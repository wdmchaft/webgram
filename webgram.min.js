/*!
 * Copyright (c) 2012 Calin Crisan <ccrisan@gmail.com>
 * 
 * This file is part of Webgram.
 * 
 * Webgram is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * Webgram is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with Webgram.  If not, see <http://www.gnu.org/licenses/>.
 */
Webgram=function(f,b,e){this.settings={zoomFactors:[0.2,0.25,0.3,0.35,0.4,0.5,0.6,0.7,0.9,1,1.5,2,3,4,5,6,7,8,9,10],zoomLevel:9,mainGrid:{sizeX:25,sizeY:25},snapGrid:{sizeX:5,sizeY:5},snapAngle:Math.PI/8,snapAngleThreshold:Math.PI/12,snapDistance:10,snapVisualFeedback:true,decorationOffset:5,doubleClickThreshold:200,showRulers:true,showZoom:true,panEnabled:true,zoomEnabled:true,multipleSelectionEnabled:true,actionsEnabled:false,keyboardShortcuts:{copy:"ctrl-67",paste:"ctrl-86","delete":"46",duplicate:"ctrl-68",moveUp:"38",moveRight:"39",moveDown:"40",moveLeft:"37",bringToFront:"ctrl-38",sendToBack:"ctrl-40",flipHorizontally:"72",flipVertically:"86"}};if(e){for(var c in e){this.settings[c]=e[c]}}this.htmlElement=f;this.rootContainer=new Webgram.DrawingElements.RootContainer(this,b);this.canvas=b;this.selectDrawingControl=new Webgram.DrawingControls.SelectDrawingControl(this.rootContainer);this.createDrawingControl=new Webgram.DrawingControls.CreateDrawingControl(this.rootContainer);this.textDrawingControl=new Webgram.DrawingControls.TextDrawingControl(this.rootContainer);this.selectDrawingControl.activate();this.onKeyPress=new Webgram.Event("key press",this);this.onKeyDown=new Webgram.Event("key down",this);this.onKeyUp=new Webgram.Event("key up",this);this.onMouseDown=new Webgram.Event("mouse down",this);this.onMouseUp=new Webgram.Event("mouse up",this);this.onMouseMove=new Webgram.Event("mouse move",this);this.onMouseScroll=new Webgram.Event("mouse scroll",this);this.onMouseEnter=new Webgram.Event("mouse enter",this);this.onMouseLeave=new Webgram.Event("mouse leave",this);this.onDraw=new Webgram.Event("draw",this);this.onZoom=new Webgram.Event("zoom",this);this.onPan=new Webgram.Event("pan",this);this.onDrawingElementAdd=new Webgram.Event("drawing element add",this);this.onDrawingElementRemove=new Webgram.Event("drawing element remove",this);this.onDrawingElementChange=new Webgram.Event("drawing element change",this);this.onDrawingElementIndexChange=new Webgram.Event("drawing element index change",this);this.onDrawingElementInteract=new Webgram.Event("drawing element interact",this);this.onDrawingElementCreate=new Webgram.Event("drawing element create",this);this.onSelectionChange=new Webgram.Event("selection change",this);this.onClipboardChange=new Webgram.Event("clipboard change",this);this.onCopyAction=new Webgram.Event("copy action",this);this.onPasteAction=new Webgram.Event("paste action",this);this.onDuplicateAction=new Webgram.Event("duplicate action",this);this.onDeleteAction=new Webgram.Event("delete action",this);this.onMoveAction=new Webgram.Event("move action",this);this.onBringToFrontAction=new Webgram.Event("bring to front",this);this.onSendToBackAction=new Webgram.Event("send to back",this);this.onFlipHorizontallyAction=new Webgram.Event("flip horizontally",this);this.onFlipVerticallyAction=new Webgram.Event("flip vertically",this);this._clipboard={type:null,content:null};this._needsRedraw=true;this._miniNeedsRedraw=true;this._lastClickTimestamp=null;this._miniWebgram=null;this._hasFocus=false;this._imageStore=new Webgram.ImageStore(this);this._lastIdSequence=0;var d=getComputedStyle(f);var a=d.getPropertyValue("border-left-width");if(a){this._border=parseInt(a,10)}else{this._border=0}this._imageStore.load("end-point-connected","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAB7SURBVBiVlZGxDYNAEARnn4AW3AAtICfkiAqo1PqEyIlFT2hJHnhkPcaX3e1sMifb5COpBTrgbXs+ZTks6Qn0WR5tf7YlXIAAfbofcAH8KghogaEA5vOqgBGob8CPCliA5gY8haQn/gCj7TkAJD2lwq5vV1conDzrnw+uKAU4lu4SgV4AAAAASUVORK5CYII=");this._imageStore.load("socket","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACvSURBVBiVbdHBSQRREIThrwdnElAwDN0gRE+zd0EFszIB7wp7EHMQNwsvRrCH9mC/dXhOwbsUf9H9uiIzNUVE4BqX+MRbLoChA2ec4wlnmMv/VQUDWzxgLO8Ed+VHG/APbA8j7lsgcFOjnzPzoFNEjLjF14ANdmtgrXnADpsBH/WRaQ0ufy7uuPMjpm7nqfwtor/GMdCDmbk4yd+dT/FS0DdeWzGx0uAVLrDH+7LBH/XmWT895jMAAAAAAElFTkSuQmCC");this._imageStore.load("gradient-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAYAAACpF6WWAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sFHgwnNtBuNwgAAAAdaVRYdENvbW1lbnQAAAAAAENyZWF0ZWQgd2l0aCBHSU1QZC5lBwAAAWBJREFUOMu9ldtKw0AQhr8kPaUoFREJaK/F938ar4VS0JaGSpv0sPHm3zIsm5j2woFhYXfny2ROm9AtSbACNMHaahTbT4BUGkKdtInBkw7YEBhJh9pvgCNwkB5j8EEEOAAmwB0wA+6BHMiAM7AHtkAJ/AAVcLIhsZ6mAk6BR6DQ/lJa6WNFcLYGdgK7MBGZgE/AXAYfHUl8E/wT+Bb4DDSZ8XKk330Fvv4AAqzk+bOABw9NTWI8lB5Agnsz2adAkhpPx0rKkutkKbuxOJca9FnPb4Tmsk+spxZcXQmtLNB7iinek4J/jUxkd2mANADuTQ32lUJ2F7D31AG1OuUW6Fb2znrqVGelKew+4u+Vsne2+G1cHfCiWK16dNQC2FhPs+CiU2yO6pS5JlStbsm1966WXqj3976bwoESm1IPWqdmSu00nTbBlGpi0LZ5OjZ16Kuk7pqn/zL5285ib1TrO/ULKJx7cY3idMAAAAAASUVORK5CYII=");this._imageStore.load("rotate","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("rotation-center","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAFKSURBVEiJ7ZW9SkNBEIW/E9MlqQ0aEBEbLbRImWBtI7YBe619gbxTfIRYWCStNgYMEomIoCCWORZ3QTF7/wqLgAeWy7Jn9pu5O+xim6ID6Jfx26bCH2v1AQr/Nt0g7QE7wCawDjwDM2Bi+zYPkFqBpLqkHtAB5sAgLA3CvCOpJ6meSUjplgZwCXSBSqyLQnLd4GuU7aITYGR7aHuRktjC9hAYBX9USwBJ+0ANuM4s/VvXQC3E5QNIDnSclvlvBd84xBUCbJAcYhnNQ9ySBPRLblZOkQ66AFpF7iKgGr4t4LxoF82AZl5ikg6B0zBtAk8xXwxwD7QlreUwHoGt4GuHuHyA7TvgHTjK2t32K2DgOPhfJB0UqQDgCvjMAgRNgV2Se+oM2JZU/WmoxqJsfwA3BQAjYAI82H6LGaKAorI9JakiVav/4PwDcvUFLF7/MeTZtowAAAAASUVORK5CYII=");this._imageStore.load("poly-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACBSURBVBiVldExEoJQDEXRk6822tpSOO7Dyh2wTjbBPqxoaaGNBZ/KgcFbZl4yyU1kJoiIG15ocMeIAX1mThCZKSKeaHH1y4wuMz+lTtwKqvU2Im4nvPHYCK5ccC51xyM0pR5zhHuxXH2EsVj0HGEo6C169pjRlyq822lYPU/xzwe/SpYw6ocjWSQAAAAASUVORK5CYII=");this._imageStore.load("remove-poly-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9sGCwwIHtegeuIAAACYSURBVCjPnZLBDcMgDEUflcwQnaB3ImWZztBhcuu9h64SyayRIbg4l4BCaJs0SAjE59mGbwxEQTgwFMRA3AIkgA7cD8CWrS8HBrYSGuCjXglvkzz3AlagTgcAgG3kvN6GsfqoSwNO5iMQgAhENb+90kJXlzIQgNC5tOdDKemp39/k1kDOcB/GUtLr0ZfMlY//+nSuI8703gw8hW96nY1MGAAAAABJRU5ErkJggg==");this._imageStore.load("resize-top-left","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-top","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-top-right","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-right","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-bottom-right","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-bottom","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-bottom-left","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("resize-left","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("round-control-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACBSURBVBiVldExEoJQDEXRk6822tpSOO7Dyh2wTjbBPqxoaaGNBZ/KgcFbZl4yyU1kJoiIG15ocMeIAX1mThCZKSKeaHH1y4wuMz+lTtwKqvU2Im4nvPHYCK5ccC51xyM0pR5zhHuxXH2EsVj0HGEo6C169pjRlyq822lYPU/xzwe/SpYw6ocjWSQAAAAASUVORK5CYII=");this._imageStore.load("round-control-point-empty","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAC6SURBVBiVhdExSgMBEIXhb7ZSJEWMdaJgY5o9goiljR7Gc+kFRPYINppCEFIHU4l2zyIrihr2wTQzP8PMe5UEVNUezjDFPl6xxH2SN6gkquoYl3jAI1Y4wBwtbpM8wwjXmCXxuzDr56PCBT6S3NmiqjrHTtPfuNgG9lpg2mCC9QC8xqTpnxkPwGOsGht75gPwHMsGHdqqOvyP6vstui+fj3Bl4/GTb59P+q03SV7qR4K7OPU3wS7JO3wCnitJqgEsmlIAAAAASUVORK5CYII=");this._imageStore.load("square-control-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAApSURBVBiV1coxEQAwCASwFC3IqnTEVAH3czPn4KLtpkKArhDA12nCmQcbJANuNVhlPwAAAABJRU5ErkJggg==");this._imageStore.load("square-control-point-square","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAABRSURBVBiVxcwxCoBAEEPRN7J2ghdS8WCeTjySnQtjY6Xb+yFN8klgxYTiS8UBG4bM9A4GbB1KZp6NF09futb45gepRsTYGp++BmYs6Bvehf0GEK4ekyLz1YYAAAAASUVORK5CYII=");this._imageStore.load("diamond-control-point","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAB7SURBVBiVlZGxDYNAEARnn4AW3AAtICfkiAqo1PqEyIlFT2hJHnhkPcaX3e1sMifb5COpBTrgbXs+ZTks6Qn0WR5tf7YlXIAAfbofcAH8KghogaEA5vOqgBGob8CPCliA5gY8haQn/gCj7TkAJD2lwq5vV1conDzrnw+uKAU4lu4SgV4AAAAASUVORK5CYII=");this._imageStore.load("diamond-control-point-diamond","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAYAAACprHcmAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAACvSURBVBiVbdHBSQRREIThrwdnElAwDN0gRE+zd0EFszIB7wp7EHMQNwsvRrCH9mC/dXhOwbsUf9H9uiIzNUVE4BqX+MRbLoChA2ec4wlnmMv/VQUDWzxgLO8Ed+VHG/APbA8j7lsgcFOjnzPzoFNEjLjF14ANdmtgrXnADpsBH/WRaQ0ufy7uuPMjpm7nqfwtor/GMdCDmbk4yd+dT/FS0DdeWzGx0uAVLrDH+7LBH/XmWT895jMAAAAAAElFTkSuQmCC");this._setRedrawLoop()};Webgram.VERSION="0.1";Webgram.prototype={getSetting:function(a,b){return Webgram.Utils.getField(a,b,this.settings)},setSetting:function(a,b){Webgram.Utils.setField(a,b,this.settings);this.invalidate()},setSettings:function(b){for(var a in b){this.settings[a]=b[a]}},getNextIdSequence:function(){return ++this._lastIdSequence},getImageStore:function(){return this._imageStore},addDrawingElement:function(b,a){this.rootContainer.addDrawingElement(b,a)},remDrawingElement:function(a){this.rootContainer.remDrawingElement(a)},getDrawingElementIndex:function(a){return this.rootContainer.getDrawingElementIndex(a)},setDrawingElementIndex:function(b,a){this.rootContainer.setDrawingElementIndex(b,a)},getSelectedDrawingElements:function(){var a=this.getActiveDrawingControl();if(a!=null){return a.getSelectedDrawingElements()}else{return[]}},setSelectedDrawingElements:function(b){var a=this.getActiveDrawingControl();if(a!=null){return a.setSelectedDrawingElements(b)}},getActiveDrawingControl:function(){return this.rootContainer.getActiveDrawingControl()},doCopyAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doCopyAction()},doPasteAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doPasteAction()},doDuplicateAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doDuplicateAction()},doDeleteAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doDeleteAction()},doMoveAction:function(c,b){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doMoveAction(c,b)},doBringToFrontAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doBringToFrontAction()},doSendToBackAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doSendToBackAction()},doFlipHorizontallyAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doFlipHorizontallyAction()},doFlipVerticallyAction:function(){var a=this.getActiveDrawingControl();if(!(a instanceof Webgram.DrawingControls.SelectDrawingControl)){return false}return a.doFlipVerticallyAction()},getZoomFactor:function(){return this.getSetting("zoomFactors")[this.rootContainer._zoomLevel]},getZoomLevel:function(){return this.rootContainer._zoomLevel},setZoomLevel:function(b,a){if(!a){a=new Webgram.Geometry.Point(this.getWidth()/2,this.getHeight()/2)}this.rootContainer.setZoomLevel(b,a)},getVisibleCenter:function(){return this.rootContainer.getVisibleCenter()},setVisibleCenter:function(a){this.rootContainer.setVisibleCenter(a)},getVisibleArea:function(){var b=new Webgram.Geometry.Point(0,0);var a=new Webgram.Geometry.Point(this.getWidth()-1,this.getHeight()-1);b=this.rootContainer.transformZoomOffsetInverse(b);a=this.rootContainer.transformZoomOffsetInverse(a);return new Webgram.Geometry.Rectangle(b.x,b.y,a.x,a.y)},setVisibleArea:function(n,k){var c=this.rootContainer.getWidth();var o=this.rootContainer.getHeight();var f=c/(k.x-n.x+1);var h=o/(k.y-n.y+1);var d=Math.min(f,h);var a=Infinity;var m=null;for(var j=0;j<this.settings.zoomFactors.length;j++){var b=this.settings.zoomFactors[j];var l=Math.abs(d-b);if(l<a){a=l;closestZoomFactor=b;m=j}}var g=(n.x+k.x)/2;var e=(n.y+k.y)/2;this.rootContainer.setZoomLevel(m);this.rootContainer.setVisibleCenter(new Webgram.Geometry.Point(g,e));this.invalidate();this.invalidateMini()},setVisibleDrawingElements:function(g){var f=Infinity;var d=Infinity;var b=-Infinity;var a=-Infinity;if(g==null){g=this.rootContainer.getDrawingElements()}if(g.length===0){return}for(var h=0;h<g.length;h++){var j=g[h];if(j._parent!==this.rootContainer){continue}var e=j.getBoundingRectangle();if(e.x1<f){f=e.x1}if(e.y1<d){d=e.y1}if(e.x2>b){b=e.x2}if(e.y2>a){a=e.y2}}var c=b-f+1;var k=a-d+1;f-=0.1*c;d-=0.1*k;b+=0.1*c;a+=0.1*k;this.setVisibleArea(new Webgram.Geometry.Point(f,d),new Webgram.Geometry.Point(b,a))},getWidth:function(){return this.rootContainer.getWidth()},getHeight:function(){return this.rootContainer.getHeight()},setWidth:function(a){this.rootContainer.setWidth(a);this.invalidate();this.invalidateMini()},setHeight:function(a){this.rootContainer.setHeight(a);this.invalidate();this.invalidateMini()},invalidate:function(){this._needsRedraw=true},invalidateMini:function(){this._miniNeedsRedraw=true},redraw:function(a){if(this.rootContainer._updatePoints||a){this.rootContainer.updatePoints();this.rootContainer._updatePoints=false}if(this._needsRedraw||a){this._needsRedraw=false;this.rootContainer.draw();this.onDraw.trigger()}if(this._miniNeedsRedraw||a){this._miniNeedsRedraw=false;this._updateMini()}},setMiniWebgram:function(a){this._miniWebgram=a;a.bigWebgram=this;a._initDrawingElements();this._updateMini()},attachHandlers:function(){var f=this;var e=this.htmlElement;var g=document.getElementsByTagName("html")[0];e.tabIndex=0;var b=this._border;function l(q){q.preventDefault();return false}function n(t){var u=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(t.pageX-u.left-b,t.pageY-u.top-b);var s={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey};this.focus();f._addEventListener(g,"mousemove",d);f._addEventListener(g,"mouseup",i);var q=f.handleMouseDown(r,t.which,s);if(q){t.preventDefault();return false}}function i(t){var u=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(t.pageX-u.left-b,t.pageY-u.top-b);var s={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey};f._removeEventListener(g,"mousemove",d);f._removeEventListener(g,"mouseup",i);var q=f.handleMouseUp(r,t.which,s);if(q){t.preventDefault();return false}}function d(t){var u=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(t.pageX-u.left-b,t.pageY-u.top-b);var s={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey};var q=f.handleMouseMove(r,s);if(q){if(typeof q==="string"){e.style.cursor=q}t.preventDefault();return false}else{e.style.cursor="default"}}function h(t){var u=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(t.pageX-u.left-b,t.pageY-u.top-b);var s={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey};var q=f.onMouseEnter.trigger(r,s);if(q){t.preventDefault();return false}}function j(t){var u=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(t.pageX-u.left-b,t.pageY-u.top-b);var s={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey};var q=f.onMouseLeave.trigger(r,s);if(q){t.preventDefault();return false}}function a(u){var t=u.detail?u.detail*-1:u.wheelDelta/40;var v=f._computeAbsCoords(e);var r=new Webgram.Geometry.Point(u.pageX-v.left-b,u.pageY-v.top-b);var s={alt:u.altKey,ctrl:u.ctrlKey,shift:u.shiftKey};var q=f.handleMouseScroll(r,t>0?true:false,s);if(q){u.preventDefault();return false}}function o(s){var r={alt:s.altKey,ctrl:s.ctrlKey,shift:s.shiftKey};var q=f.handleKeyPress(s.which,r);if(q){s.preventDefault();return false}}function k(s){var r={alt:s.altKey,ctrl:s.ctrlKey,shift:s.shiftKey};var q=f.handleKeyDown(s.which,r);if(q){s.preventDefault();return false}}function p(t){var s=(t.which>=97&&t.which<=122&&t.shiftKey)||(t.which>=65&&t.which<=90&&!t.shiftKey);var r={alt:t.altKey,ctrl:t.ctrlKey,shift:t.shiftKey,caps:s};var q=f.handleKeyUp(t.which,r);if(q){t.preventDefault();return false}}function m(r){var q=f.handleFocus();if(q){r.preventDefault();return false}}function c(r){var q=f.handleBlur();if(q){r.preventDefault();return false}}this._addEventListener(e,"click",l);this._addEventListener(e,"mousedown",n);this._addEventListener(e,"mouseup",i);this._addEventListener(e,"mousemove",d);this._addEventListener(e,"mouseover",h);this._addEventListener(e,"mouseout",j);this._addEventListener(e,"mousewheel",a);this._addEventListener(e,"DOMMouseScroll",a);this._addEventListener(e,"keypress",o);this._addEventListener(e,"keydown",k);this._addEventListener(e,"keyup",p);this._addEventListener(e,"focus",m);this._addEventListener(e,"blur",c);e.onmousedown=function(){return false};this.htmlElement.focus()},getClipboard:function(){return{type:this._clipboard.type,content:this._clipboard.content}},setClipboard:function(a,b){this._clipboard={type:a,content:b};this.onClipboardChange.trigger(this._clipboard)},clearClipboard:function(){this._clipboard={type:null,content:null};this.onClipboardChange.trigger(this._clipboard)},hasFocus:function(){return this._hasFocus},handleMouseDown:function(c,e,d){var f=new Date().getTime();var b=this.getSetting("doubleClickThreshold");d.doubleClick=this._lastClickTimestamp&&(f-this._lastClickTimestamp<b);this._lastClickTimestamp=f;var a=this.onMouseDown.trigger(c,e,d);if(a){return true}return this.rootContainer.handleMouseDown(c,e,d)},handleMouseUp:function(b,d,c){var a=this.onMouseUp.trigger(b,d,c);if(a){return true}return this.rootContainer.handleMouseUp(b,d,c)},handleMouseMove:function(b,c){var a=this.onMouseMove.trigger(b,c);if(a){return a}return this.rootContainer.handleMouseMove(b,c)},handleMouseScroll:function(c,b,d){var a=this.onMouseScroll.trigger(c,b,d);if(a){return true}return this.rootContainer.handleMouseScroll(c,b,d)},handleKeyPress:function(c,b){var a=this.onKeyPress.trigger(c,b);if(a){return true}return this.rootContainer.handleKeyPress(c,b)},handleKeyDown:function(c,b){var a=this.onKeyDown.trigger(c,b);if(a){return true}return this.rootContainer.handleKeyDown(c,b)},handleKeyUp:function(c,b){var a=this.onKeyUp.trigger(c,b);if(a){return true}return this.rootContainer.handleKeyUp(c,b)},handleFocus:function(){this._hasFocus=true;return this.rootContainer.handleFocus()},handleBlur:function(){this._hasFocus=false;return this.rootContainer.handleBlur()},_getMiniParams:function(){var a=this._miniWebgram.marginFactor;var e=this.rootContainer.getMargins();var b=e.getCenter();var g=this.rootContainer.getWidth();var d=this.rootContainer.getHeight();var i=(e.x2-e.x1+1)/(1-a);var h=(e.y2-e.y1+1)/(1-a);if(i/g>h/d){h=d*i/g}else{i=g*h/d}var c=this._miniWebgram.getWidth();var f=this._miniWebgram.getHeight();return{center:b,thisWidth:g,thisHeight:d,fullWidth:i,fullHeight:h,miniWidth:c,miniHeight:f}},_setRedrawLoop:function(){var c=function(e,d){window.setTimeout(e,1000/120)};var a=this;(function b(){c(b,a.htmlElement);a.redraw()})()},_drawMini:function(){var d=this._getMiniParams();var c=d.miniWidth/d.fullWidth;var b=d.miniHeight/d.fullHeight;var e=Math.min(c,b);var a=this.rootContainer.canvas;var f=this.rootContainer._zoomFactor;var h=this.rootContainer._offsetX;var g=this.rootContainer._offsetY;this.rootContainer.canvas=this._miniWebgram.rootContainer.canvas;this.rootContainer._zoomFactor=e;this.rootContainer._offsetX=Math.round(d.center.x-d.fullWidth/2);this.rootContainer._offsetY=Math.round(d.center.y-d.fullHeight/2);this.rootContainer._mini=true;this.rootContainer.draw();this.rootContainer.canvas=a;this.rootContainer._zoomFactor=f;this.rootContainer._offsetX=h;this.rootContainer._offsetY=g;delete this.rootContainer._mini},_updateMini:function(){if(!this._miniWebgram){return}var c=this._getMiniParams();var b=this.rootContainer.transformZoomOffsetInverse(Webgram.Geometry.Point.zero());var a=this.rootContainer.transformZoomOffsetInverse(new Webgram.Geometry.Point(c.thisWidth-1,c.thisHeight-1));b.x-=c.center.x;b.y-=c.center.y;a.x-=c.center.x;a.y-=c.center.y;b.x*=c.miniWidth/c.fullWidth;b.y*=c.miniHeight/c.fullHeight;a.x*=c.miniWidth/c.fullWidth;a.y*=c.miniHeight/c.fullHeight;this._miniWebgram.setVisibleArea(b,a);this._miniWebgram.redraw(true)},_updateFromMini:function(){if(!this._miniWebgram){return}var c=this._getMiniParams();var d=this._miniWebgram.visibleArea.getBounds();var b=d.topLeft.clone();var a=d.bottomRight.clone();b.x*=c.fullWidth/c.miniWidth;b.y*=c.fullHeight/c.miniHeight;a.x*=c.fullWidth/c.miniWidth;a.y*=c.fullHeight/c.miniHeight;b.x+=c.center.x;b.y+=c.center.y;a.x+=c.center.x;a.y+=c.center.y;this.setVisibleArea(b,a)},_computeAbsCoords:function(a){var c=0,b=0;while(a!=null){c+=a.offsetLeft;b+=a.offsetTop;a=a.offsetParent}return{left:c,top:b}},_addEventListener:function(b,a,c){if(b.addEventListener){b.addEventListener(a,c,false)}else{if(b.attachEvent){b.attachEvent(a,c)}}},_removeEventListener:function(b,a,c){if(b.removeEventListener){b.removeEventListener(a,c,false)}else{if(b.detachEvent){b.detachEvent(a,c)}}}};Webgram.Inherit=function(b){function a(){}a.prototype=b;return new a()};Webgram.Namespace=function(g,a){var f=g.split(".");var e=window;var g="";for(var d=0;d<f.length;d++){var b=f[d];if(g.length){g+="."}g+=b;if(e[b]==null){e[b]={}}if(e[b].__fullName__===undefined){e[b].__name__=b;e[b].__fullName__=g;e[b].toString=function(){return this.__fullName__}}e=e[b]}for(var c in a){if(a.hasOwnProperty(c)){e[c]=a[c]}}return e};Webgram.Class=function(d,a,j,e){var k;var f=d.split(".");var g=f[f.length-1];var i=d.substring(0,d.length-g.length-1);var c;if(i){c=this.Namespace(i)}else{c=null}var b=Webgram.Utils.getField(d);if(!b){b=j.initialize}if(!b){b=function(){if(a){a.apply(this,arguments)}}}var h;if(a){h=this.Inherit(a.prototype);for(k in j){if(j.hasOwnProperty(k)){h[k]=j[k]}}}else{h=this.Inherit(j?j:{})}for(k in b.prototype){if(b.prototype.hasOwnProperty(k)&&!h.hasOwnProperty(k)){h[k]=b.prototype[k]}}h.constructor=b;b.prototype=h;for(k in a){if(a.hasOwnProperty(k)&&!b.hasOwnProperty(k)){b[k]=a[k]}}for(k in e){if(e.hasOwnProperty(k)){b[k]=e[k]}}b.__name__=g;b.__fullName__=d;b.__namespace__=c;b.toString=function(){return this.__fullName__};if(!b.prototype.toString){b.prototype.toString=function(){return this.constructor.__fullName__+"()"}}return b};Webgram.Augment=function(f,d,c,e){var b;var a=Webgram.Utils.getField(f);if(!a){return}for(b in d.prototype){if(!a.prototype.hasOwnProperty(b)){a.prototype[b]=d.prototype[b]}}for(b in c){if(!c.hasOwnProperty(b)){a.prototype[b]=c[b]}}for(b in d){if(d.hasOwnProperty(b)&&!a.hasOwnProperty(b)){a[b]=d[b]}}for(b in e){if(e.hasOwnProperty(b)){a[b]=e[b]}}return a};Webgram.Namespace("Webgram");Webgram.Utils=Webgram.Namespace("Webgram.Utils",{getField:function(c,d,e){if(typeof c==="string"){c=c.split(".")}if(e==null){e=window}for(var b=0;b<c.length;b++){var a=c[b];if(e[a]===undefined){return d}else{if(e[a]===null){return null}}e=e[a]}return e},setField:function(c,d,e){if(typeof c==="string"){c=c.split(".")}if(e==null){e=window}for(var b=0;b<c.length-1;b++){var a=c[b];if(e[a]==null){e[a]={}}e=e[a]}e[c[c.length-1]]=d},equals:function(d,c){if(d===c){return true}if(typeof d!==typeof c){return false}if(d.equals){return d.equals(c)}if(d instanceof Array){if(!(c instanceof Array)){return false}if(d.length!==c.length){return false}for(var b=0;b<d.length;b++){if(d[b]!==c[b]){return false}}return true}else{if(d instanceof Object){if(!(c instanceof Object)){return false}var a;for(a in d){if(d.hasOwnProperty(a)){if(!c.hasOwnProperty(a)){return false}if(d[a]!==c[a]){return false}}}for(a in c){if(c.hasOwnProperty(a)){if(!d.hasOwnProperty(a)){return false}}}return true}else{return false}}},clone:function(d){if(d===undefined||d===null||typeof d==="number"||typeof d==="string"||typeof d==="boolean"){return d}else{if(d instanceof Array){var a=[];for(var c=0;c<d.length;c++){a.push(this.clone(d[c]))}return a}else{if(d instanceof Function){return d}else{if(d instanceof Object){if(d.clone){return d.clone()}var a={};for(var b in d){if(d.hasOwnProperty(b)){a[b]=this.clone(d[b])}}return a}else{return d}}}}},visit:function(a,c){function b(g,f){if(g===undefined){c(f,undefined,g)}else{if(g===null){c(f,null,g)}else{if(typeof g==="number"){c(f,Number,g)}else{if(typeof g==="string"){c(f,String,g)}else{if(typeof g==="boolean"){c(f,Boolean,g)}else{if(g instanceof Array){c(f,Array,g);for(var e=0;e<g.length;e++){b(g[e],c,e)}}else{if(g instanceof Function){c(f,Function,g)}else{if(g instanceof Object){c(f,Object,g);for(var d in g){if(g.hasOwnProperty(d)){b(g[e],c,e)}}}else{}}}}}}}}}return b(a,[])},scriptLoaded:function(c){var a=document.getElementsByTagName("script");for(var b=0;b<a.length;b++){if(a[b].src===c){return true}}return false},loadScript:function(e,d){var a=document.createElement("script");var b=false;a.onload=a.onreadystatechange=function(){if((a.readyState&&a.readyState!=="complete"&&a.readyState!=="loaded")||b){return false}a.onload=a.onreadystatechange=null;if(d){d(a)}b=true};a.async=true;a.src=e;var c=document.getElementsByTagName("head")[0];c.appendChild(a)},loadScripts:function(h,d,f){if(f){function g(){if(h.length){Webgram.Utils.loadScript(h.shift(),g)}else{if(d){d()}}}g()}else{var e=0;function c(){e++;if(e===h.length){if(d){d()}}}var b="";for(var a=0;a<h.length;a++){b+='<script type="text/javascript" src="'+h[a]+'"><\/script>'}document.write(b)}}});Webgram.jsPath=(function(){var e=new RegExp("(^|(.*?\\/))(webgram(.min)?.js)(\\?|$)");var a=document.getElementsByTagName("script");for(var c=0;c<a.length;c++){var d=a[c].src;if(d){var b=d.match(e);if(b){return b[1]}}}return"/"})();Webgram._singleScript=true;Webgram._scriptSrcList=(function(){var b=["utils.js","geometry.js","styles.js","default-styles.js","event.js","image-store.js","canvas.js","control-point.js","action-menu-item.js","drawing-element.js","drawing-control.js","control-points/absolute-control-point.js","control-points/proportional-control-point.js","control-points/gradient-control-points.js","control-points/rotate-control-points.js","drawing-elements/simple-element.js","drawing-elements/rectangular-element.js","drawing-elements/container-element.js","drawing-elements/poly-element.js","drawing-elements/root-container.js","connectors/connector.js","connectors/socket.js","connectors/end-point.js","drawing-controls/select-drawing-control.js","drawing-controls/create-drawing-control.js","drawing-controls/text-drawing-control.js","mini-webgram.js","debug.js"];for(var a=0;a<b.length;a++){b[a]=Webgram.jsPath+b[a]}return b})();if(!Webgram._singleScript){Webgram.Utils.loadScripts(Webgram._scriptSrcList)}Webgram.Namespace("Webgram.Utils",{getCursorByAngle:function(c){var b=["e-resize","se-resize","s-resize","sw-resize","w-resize","nw-resize","n-resize","ne-resize"];c=Webgram.Utils.normalizeAngle(c);var a=Math.round(4/Math.PI*c);if(a<0){a=8+a}if(a>7){a=a-8}return b[a]},normalizeAngle:function(a){a=Math.round(a*180*10/Math.PI)/10;while(a<0){a=2*180+a}a=a%360;a=a*Math.PI/180;return a},getSnappedAngle:function(d,c,a){d=Webgram.Utils.normalizeAngle(d);c=c*180/Math.PI;d=d*180/Math.PI;a=a*180/Math.PI;var e=Math.floor(d/c);var b=d%c;if(b<a/2){d=c*e}else{if(c-b<a/2){d=c*(e+1)}else{return null}}d=d*Math.PI/180;return Webgram.Utils.normalizeAngle(d)},pointInSegment:function(l,i,h,j){var c=Math.atan2(h.y-i.y,h.x-i.x);var e=(i.x+h.x)/2;var d=(i.y+h.y)/2;c=-c;var a=Math.sin(c);var n=Math.cos(c);var m=e+(l.x-e)*n-(l.y-d)*a;var k=d+(l.y-d)*n+(l.x-e)*a;var g=e+(i.x-e)*n-(i.y-d)*a;var b=d+(i.y-d)*n+(i.x-e)*a;var f=e+(h.x-e)*n-(h.y-d)*a;return(m>=Math.min(g,f))&&(m<=Math.max(g,f))&&(k>=b-j)&&(k<=b+j)},pointInBezier:function(j,f,d,k,i,h){var a=f.getDistanceTo(d);var b,c,g,e;if(i!=null){a+=(f.getDistanceTo(k)+k.getDistanceTo(i)+i.getDistanceTo(d))/6;b=5/a;c=h*2;for(var l=0;l<1;l+=b){g=Math.pow(1-l,3)*f.x+3*Math.pow(1-l,2)*l*k.x+3*(1-l)*l*l*i.x+Math.pow(l,3)*d.x;e=Math.pow(1-l,3)*f.y+3*Math.pow(1-l,2)*l*k.y+3*(1-l)*l*l*i.y+Math.pow(l,3)*d.y;if(j.getDistanceTo(new Webgram.Geometry.Point(g,e))<c){return true}}return false}else{a+=(f.getDistanceTo(k)+k.getDistanceTo(d))/4;b=5/a;c=h*2;for(var l=0;l<1;l+=b){g=Math.pow(1-l,2)*f.x+2*(1-l)*l*k.x+Math.pow(l,2)*d.x;e=Math.pow(1-l,2)*f.y+2*(1-l)*l*k.y+Math.pow(l,2)*d.y;if(j.getDistanceTo(new Webgram.Geometry.Point(g,e))<c){return true}}return false}},angleMultipleOf:function(b,c){var a=b/c;return Math.abs(a-Math.round(a))<0.0001},indexOf:function(c,b){for(var a=0;a<c.length;a++){if(c[a]===b){return a}}return -1}});Webgram.Geometry=Webgram.Namespace("Webgram.Geometry");Webgram.Geometry.Point=function(a,b){this.x=a;this.y=b};Webgram.Geometry.Point.prototype={getTranslated:function(b,a){return new Webgram.Geometry.Point(this.x+b,this.y+a)},getRotated:function(d,b){if(d===0){return new Webgram.Geometry.Point(this.x,this.y)}if(!b){b=new Webgram.Geometry.Point(0,0)}var c=Math.sin(d);var f=Math.cos(d);var a=b.x+(this.x-b.x)*f-(this.y-b.y)*c;var e=b.y+(this.y-b.y)*f+(this.x-b.x)*c;return new Webgram.Geometry.Point(a,e)},getScaled:function(b,a){return new Webgram.Geometry.Point(this.x*b,this.y*a)},getDistanceTo:function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))},getCenterTo:function(a){return new Webgram.Geometry.Point((this.x+a.x)/2,(this.y+a.y)/2)},getAngleTo:function(a){return Math.atan2(a.y-this.y,a.x-this.x)},getPointAt:function(a,b){return new Webgram.Geometry.Point(this.x+a*Math.cos(b),this.y+a*Math.sin(b))},round:function(a){if(!a){a=1}return new Webgram.Geometry.Point(Math.round(this.x/a)*a,Math.round(this.y/a)*a)},clone:function(){return new Webgram.Geometry.Point(this.x,this.y)},equals:function(a){if(a==null){return false}return(a.x===this.x&&a.y===this.y)}};Webgram.Geometry.Point.zero=function(){return new Webgram.Geometry.Point(0,0)};Webgram.Class("Webgram.Geometry.Point");Webgram.Geometry.Size=function(b,a){this.width=b;this.height=a};Webgram.Geometry.Size.prototype={round:function(a){if(!a){a=1}return new Webgram.Geometry.Size(Math.round(this.width/a)*a,Math.round(this.height/a)*a)},clone:function(){return new Webgram.Geometry.Size(this.width,this.height)},equals:function(a){if(a==null){return false}return(a.width===this.width&&a.height===this.height)}};Webgram.Class("Webgram.Geometry.Size");Webgram.Geometry.Rectangle=function(b,d,a,c){this.x1=Math.min(b,a);this.y1=Math.min(d,c);this.x2=Math.max(b,a);this.y2=Math.max(d,c)};Webgram.Geometry.Rectangle.prototype={pointInside:function(a){return(a.x>=this.x1)&&(a.x<=this.x2)&&(a.y>=this.y1)&&(a.y<=this.y2)},getWidth:function(){return this.x2-this.x1+1},getHeight:function(){return this.y2-this.y1+1},getSize:function(){return new Webgram.Geometry.Size(this.x2-this.x1+1,this.y2-this.y1+1)},getCenter:function(){return new Webgram.Geometry.Point((this.x1+this.x2)/2,(this.y1+this.y2)/2)},getTopLeft:function(){return new Webgram.Geometry.Point(this.x1,this.y1)},getBottomRight:function(){return new Webgram.Geometry.Point(this.x2,this.y2)},getTopRight:function(){return new Webgram.Geometry.Point(this.x2,this.y1)},getBottomLeft:function(){return new Webgram.Geometry.Point(this.x1,this.y2)},getPoly:function(){var b=new Webgram.Geometry.Point(this.x1,this.y1);var d=new Webgram.Geometry.Point(this.x2,this.y1);var c=new Webgram.Geometry.Point(this.x2,this.y2);var a=new Webgram.Geometry.Point(this.x1,this.y2);return new Webgram.Geometry.Poly([b,d,c,a])},getTranslated:function(b,a){return new Webgram.Geometry.Rectangle(this.x1+b,this.y1+a,this.x2+b,this.y2+a)},round:function(a){if(!a){a=1}return new Webgram.Geometry.Rectangle(Math.round(this.x1/a)*a,Math.round(this.y1/a)*a,Math.round(this.x2/a)*a,Math.round(this.y2/a)*a)},getShrinked:function(a){return new Webgram.Geometry.Rectangle(this.x1+a,this.y1+a,this.x2-a,this.y2-a)},clone:function(){return new Webgram.Geometry.Rectangle(this.x1,this.y1,this.x2,this.y2)},equals:function(a){if(a==null){return false}return(a.x1===this.x1&&a.y1===this.y1&&a.x2===this.x2&&a.y2===this.y2)}};Webgram.Class("Webgram.Geometry.Rectangle");Webgram.Geometry.Poly=function(a){this.points=[];if(a){this.points=a}};Webgram.Geometry.Poly.prototype={pointInside:function(b){var a=false;for(var d=0,c=this.points.length-1;d<this.points.length;c=d++){if(((this.points[d].y>=b.y)!==(this.points[c].y>=b.y))&&(b.x<=(this.points[c].x-this.points[d].x)*(b.y-this.points[d].y)/(this.points[c].y-this.points[d].y)+this.points[d].x)){a=!a}}return a},getCenter:function(){var a=0;var c=0;for(var b=0;b<this.points.length;b++){a+=this.points[b].x;c+=this.points[b].y}return new Webgram.Geometry.Point(a/this.points.length,c/this.points.length)},getTranslated:function(b,a){var d=[];for(var c=0;c<this.points.length;c++){d.push(this.points[c].getTranslated(b,a))}return new Webgram.Geometry.Poly(d)},getRotated:function(d,a){var c=[];for(var b=0;b<this.points.length;b++){c.push(this.points[b].getRotated(d,a))}return new Webgram.Geometry.Poly(c)},getScaled:function(d,c){var b=[];for(var a=0;a<this.points.length;a++){b.push(this.points[a].getTranslated(d,c))}return new Webgram.Geometry.Poly(b)},getBoundingRectangle:function(){if(!this.points.length){return new Webgram.Geometry.Rectangle(0,0,0,0)}var c=this.points[0].x;var f=this.points[0].y;var b=this.points[0].x;var e=this.points[0].y;for(var d=0;d<this.points.length;d++){var a=this.points[d];if(a.x<c){c=a.x}if(a.x>b){b=a.x}if(a.y<f){f=a.y}if(a.y>e){e=a.y}}return new Webgram.Geometry.Rectangle(c,f,b,e)},round:function(c){var b=[];for(var a=0;a<this.points.length;a++){b.push(this.points[a].round(c))}return new Webgram.Geometry.Poly(b)},clone:function(){var b=[];for(var a=0;a<this.points.length;a++){b.push(this.points[a].clone())}return new Webgram.Geometry.Poly(b)},equals:function(b){if(this.points.length!==b.points.length){return false}for(var a=0;a<this.points.length;a++){if(!this.points[a].equals(b.points[a])){return false}}return true}};Webgram.Class("Webgram.Geometry.Poly");Webgram.Styles={_strokeStyles:{},_fillStyles:{},_textStyles:{},setStrokeStyle:function(a,b){if(!(b instanceof Webgram.Styles.StrokeStyle)&&b!=null){b=this.createStrokeStyle(b)}this._strokeStyles[a]=b},setFillStyle:function(b,a){if(!(a instanceof Webgram.Styles.FillStyle)&&a!=null){a=this.createFillStyle(a)}this._fillStyles[b]=a},setTextStyle:function(a,b){if(!(b instanceof Webgram.Styles.TextStyle)&&b!=null){b=this.createTextStyle(b)}this._textStyles[a]=b},getStrokeStyle:function(a){var b=this._strokeStyles[a];if(b==null){return null}return b.clone()},getFillStyle:function(a){var b=this._fillStyles[a];if(b==null){return null}return b.clone()},getTextStyle:function(a){var b=this._textStyles[a];if(b==null){return null}return b.clone()},createStrokeStyle:function(a){var c=a.gradientPoint1;var b=a.gradientPoint2;if(c!=null){c=new Webgram.Geometry.Point(c.x,c.y)}if(b!=null){b=new Webgram.Geometry.Point(b.x,b.y)}return new Webgram.Styles.StrokeStyle(a.lineWidth,a.lineCap,a.lineJoin,a.miterLimit,a.colors,a.pattern,c,b,a.gradientRadius1,a.gradientRadius2)},createFillStyle:function(a){var c=a.gradientPoint1;var b=a.gradientPoint2;if(c!=null){c=new Webgram.Geometry.Point(c.x,c.y)}if(b!=null){b=new Webgram.Geometry.Point(b.x,b.y)}return new Webgram.Styles.FillStyle(a.colors,c,b,a.gradientRadius1,a.gradientRadius2)},createTextStyle:function(a){return new Webgram.Styles.TextStyle(a.color,a.font,a.size,a.bold,a.italic,a.justify)}};Webgram.Namespace("Webgram.Styles");Webgram.Styles.StrokeStyle=function(g,j,b,c,a,i,e,d,h,f){if(g==null){g=1}if(j==null){j="square"}if(b==null){b="miter"}if(c==null){c=10}if(a==null){a="black"}this.lineWidth=g;this.lineCap=j;this.lineJoin=b;this.miterLimit=c;this.colors=a;this.pattern=i;this.gradientPoint1=e;this.gradientPoint2=d;this.gradientRadius1=h;this.gradientRadius2=f};Webgram.Styles.StrokeStyle.prototype={clone:function(){return new Webgram.Styles.StrokeStyle(this.lineWidth,this.lineCap,this.lineJoin,this.miterLimit,Webgram.Utils.clone(this.colors),Webgram.Utils.clone(this.pattern),Webgram.Utils.clone(this.gradientPoint1),Webgram.Utils.clone(this.gradientPoint2),this.gradientRadius1,this.gradientRadius2)},replace:function(a){if(a.lineWidth===undefined){a.lineWidth=this.lineWidth}if(a.lineCap===undefined){a.lineCap=this.lineCap}if(a.lineJoin===undefined){a.lineJoin=this.lineJoin}if(a.miterLimit===undefined){a.miterLimit=this.miterLimit}if(a.colors===undefined){a.colors=Webgram.Utils.clone(this.colors)}if(a.pattern===undefined){a.pattern=Webgram.Utils.clone(this.pattern)}if(a.gradientPoint1===undefined){a.gradientPoint1=Webgram.Utils.clone(this.gradientPoint1)}if(a.gradientPoint2===undefined){a.gradientPoint2=Webgram.Utils.clone(this.gradientPoint2)}if(a.gradientRadius1===undefined){a.gradientRadius1=this.gradientRadius1}if(a.gradientRadius2===undefined){a.gradientRadius2=this.gradientRadius2}return Webgram.Styles.createStrokeStyle(a)},toJson:function(){return{lineWidth:this.lineWidth,lineCap:this.lineCap,lineJoin:this.lineJoin,miterLimit:this.miterLimit,colors:this.colors,pattern:this.pattern,gradientPoint1:(this.gradientPoint1!=null)?{x:this.gradientPoint1.x,y:this.gradientPoint1.y,}:null,gradientPoint2:(this.gradientPoint2!=null)?{x:this.gradientPoint2.x,y:this.gradientPoint2.y,}:null,gradientRadius1:this.gradientRadius1,gradientRadius2:this.gradientRadius2}},fromJson:function(a){if(a.lineWidth!==undefined){this.lineWidth=a.lineWidth}if(a.lineCap!==undefined){this.lineCap=a.lineCap}if(a.lineJoin!==undefined){this.lineJoin=a.lineJoin}if(a.miterLimit!==undefined){this.miterLimit=a.miterLimit}if(a.colors!==undefined){this.colors=Webgram.Utils.clone(a.colors)}if(a.pattern!==undefined){this.pattern=Webgram.Utils.clone(a.pattern)}if(a.gradientPoint1!==undefined){this.gradientPoint1=a.gradientPoint1;if(this.gradientPoint1!=null){this.gradientPoint1=new Webgram.Geometry.Point(this.gradientPoint1.x,this.gradientPoint1.y)}}if(a.gradientPoint2!==undefined){this.gradientPoint2=a.gradientPoint2;if(this.gradientPoint2!=null){this.gradientPoint2=new Webgram.Geometry.Point(this.gradientPoint2.x,this.gradientPoint2.y)}}if(a.gradientRadius1!==undefined){this.gradientRadius1=a.gradientRadius1}if(a.gradientRadius2!==undefined){this.gradientRadius2=a.gradientRadius2}}};Webgram.Class("Webgram.Styles.StrokeStyle");Webgram.Styles.FillStyle=function(a,e,d,c,b){if(!a){a="white"}this.colors=a;this.gradientPoint1=e;this.gradientPoint2=d;this.gradientRadius1=c;this.gradientRadius2=b};Webgram.Styles.FillStyle.prototype={clone:function(){return new Webgram.Styles.FillStyle(Webgram.Utils.clone(this.colors),Webgram.Utils.clone(this.gradientPoint1),Webgram.Utils.clone(this.gradientPoint2),this.gradientRadius1,this.gradientRadius2)},replace:function(a){if(a.colors===undefined){a.colors=Webgram.Utils.clone(this.colors)}if(a.gradientPoint1===undefined){a.gradientPoint1=Webgram.Utils.clone(this.gradientPoint1)}if(a.gradientPoint2===undefined){a.gradientPoint2=Webgram.Utils.clone(this.gradientPoint2)}if(a.gradientRadius1===undefined){a.gradientRadius1=this.gradientRadius1}if(a.gradientRadius2===undefined){a.gradientRadius2=this.gradientRadius2}return Webgram.Styles.createFillStyle(a)},toJson:function(){return{colors:this.colors,gradientPoint1:(this.gradientPoint1!=null)?{x:this.gradientPoint1.x,y:this.gradientPoint1.y,}:null,gradientPoint2:(this.gradientPoint2!=null)?{x:this.gradientPoint2.x,y:this.gradientPoint2.y,}:null,gradientRadius1:this.gradientRadius1,gradientRadius2:this.gradientRadius2}},fromJson:function(a){if(a.colors!==undefined){this.colors=Webgram.Utils.clone(a.colors)}if(a.gradientPoint1!==undefined){this.gradientPoint1=a.gradientPoint1;if(this.gradientPoint1!=null){this.gradientPoint1=new Webgram.Geometry.Point(this.gradientPoint1.x,this.gradientPoint1.y)}}if(a.gradientPoint2!==undefined){this.gradientPoint2=a.gradientPoint2;if(this.gradientPoint2!=null){this.gradientPoint2=new Webgram.Geometry.Point(this.gradientPoint2.x,this.gradientPoint2.y)}}if(a.gradientRadius1!==undefined){this.gradientRadius1=a.gradientRadius1}if(a.gradientRadius2!==undefined){this.gradientRadius2=a.gradientRadius2}}};Webgram.Class("Webgram.Styles.FillStyle");Webgram.Styles.TextStyle=function(d,c,f,e,b,a){this.color=d;this.font=c;this.size=f;this.bold=e;this.italic=b;this.justify=a};Webgram.Styles.TextStyle.prototype={clone:function(){return new Webgram.Styles.TextStyle(this.color,this.font,this.size,this.bold,this.italic,this.justify)},replace:function(a){if(a.color===undefined){a.color=this.color}if(a.font===undefined){a.font=this.font}if(a.size===undefined){a.size=this.size}if(a.bold===undefined){a.bold=this.bold}if(a.italic===undefined){a.italic=this.italic}if(a.justify===undefined){a.justify=this.justify}return Webgram.Styles.createTextStyle(a)},toJson:function(){return{color:this.color,font:this.font,size:this.size,bold:this.bold,italic:this.italic,justify:this.justify}},fromJson:function(a){if(a.color!==undefined){this.color=a.color}if(a.font!==undefined){this.font=a.font}if(a.size!==undefined){this.size=a.size}if(a.bold!==undefined){this.bold=a.bold}if(a.italic!==undefined){this.italic=a.italic}if(a.justify!==undefined){this.justify=a.justify}}};Webgram.Class("Webgram.Styles.TextStyle");Webgram.Styles.setStrokeStyle("default",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"#6788BF",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("default",{colors:"#B5C6FF",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setTextStyle("default",{color:"#555",font:"arial",size:14,bold:false,italic:false,justify:"cc"});Webgram.Styles.setStrokeStyle("default-guides",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.3)",pattern:[5,2],gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("default-hovered-decoration",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.3)",pattern:[5,2],gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("default-selected-decoration",Webgram.Styles.getStrokeStyle("default-hovered-decoration"));Webgram.Styles.setFillStyle("background",null);Webgram.Styles.setStrokeStyle("main-grid",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"#E5E5E5",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("main-grid-axes",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"#CCCCCC",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("snap-grid",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"#F7F7F7",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("snap-visual-feedback",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.3)",pattern:[5,2],gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setTextStyle("snap-visual-feedback",{color:"rgba(0, 0, 0, 0.3)",size:10,bold:false,italic:false,font:"arial",justify:"cc"});Webgram.Styles.setStrokeStyle("rulers",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(120, 120, 120, 0.6)",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("rulers",{colors:"rgba(160, 160, 160, 0.6)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setTextStyle("rulers",{color:"white",size:10,bold:false,italic:false,font:"arial",justify:"cc"});Webgram.Styles.setStrokeStyle("multiple-selection",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(128, 128, 128, 0.5)",pattern:[5,2],gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("multiple-selection",{colors:"rgba(255, 255, 255, 0.20)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("text-input-area",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(255, 255, 255, 0.8)",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("text-input-area",{colors:"rgba(255, 255, 255, 0.1)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("text-input-background",{colors:"rgba(0, 0, 0, 0.4)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("action-menu-item",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.2)",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("action-menu-item",{colors:"rgba(200, 200, 200, 0.20)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("action-menu-item-hover",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.5)",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("action-menu-item-hover",{colors:"rgba(200, 200, 200, 0.70)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setFillStyle("mini-background",{colors:"rgba(96, 96, 96, 0.2)",gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Styles.setStrokeStyle("mini-background",{lineWidth:null,lineCap:null,lineJoin:null,miterLimit:null,colors:"rgba(0, 0, 0, 0.25)",pattern:null,gradientPoint1:null,gradientPoint2:null,gradientRadius1:null,gradientRadius2:null});Webgram.Event=function(b,a){this.name=b;this.object=a;this.handlers=[]};Webgram.Event.prototype={bind:function(c){var a=[];for(var b=1;b<arguments.length;b++){a.push(arguments[b])}this.handlers.push({func:c,args:a})},unbind:function(d){if(d){var b=[];for(var a=0;a<this.handlers.length;a++){var c=this.handlers[a];if(c.func!==d){b.push(c)}}this.handlers=b}else{this.handlers=[]}},trigger:function(){var f;for(var d=0;d<this.handlers.length;d++){var e=this.handlers[d];var c=[];for(var b=0;b<arguments.length;b++){c.push(arguments[b])}c=c.concat(e.args);var a=e.func.apply(this.object,c);if(a!=null){f=a}if(a===false){break}}return f},toString:function(){return this.constructor.toString()+"("+this.name+")"}};Webgram.Class("Webgram.Event");Webgram.ImageStore=function(a){this._webgram=a;this._images={}};Webgram.ImageStore.prototype={load:function(b,a,c){var e=this;this._images[b]={name:b,url:a,content:null,size:null};var d=new Image();d.src=a;d.onload=function(){e._images[b].name=b;e._images[b].content=d;e._images[b].size=new Webgram.Geometry.Size(d.width,d.height);if(c){c(b,a)}if(e._webgram!=null){e._webgram.invalidate();e._webgram.invalidateMini()}}},get:function(a){if(!this._images[a]){return null}if(!this._images[a].content){return null}return this._images[a]}};Webgram.Class("Webgram.ImageStore");CanvasRenderingContext2D.prototype._oldMoveTo=CanvasRenderingContext2D.prototype.moveTo;CanvasRenderingContext2D.prototype.moveTo=function(a,b){this.currentX=a;this.currentY=b;this._oldMoveTo(a,b)};CanvasRenderingContext2D.prototype._oldLineTo=CanvasRenderingContext2D.prototype.lineTo;CanvasRenderingContext2D.prototype.lineTo=function(a,g){if(!this._strokePattern||this._transparentStroke){this._oldLineTo(a,g);this.currentX=a;this.currentY=g;return}var d=Math.atan2(g-this.currentY,a-this.currentX);var b=new Webgram.Geometry.Point(a,g).getDistanceTo(new Webgram.Geometry.Point(this.currentX,this.currentY));this.save();this.translate(this.currentX,this.currentY);this.rotate(d);var f=0;var c;var e=this._strokePatternPos%this._strokePatternLength;if(e<this._strokePattern[0]){f+=this._strokePattern[0]-e;if(f>b){f=b}this._oldLineTo(f,0);c=1}else{f+=this._strokePatternLength-e;if(f>b){f=b}this._oldMoveTo(f,0);c=0}while(f<b){f+=this._strokePattern[c];if(f>b){f=b}if(c){this._oldMoveTo(f,0)}else{this._oldLineTo(f,0)}c=(c+1)%2}this.restore();this._strokePatternPos+=b;this.currentX=a;this.currentY=g};Webgram.Canvas=function(a){this.context=a;this.width=a.canvas.width;this.height=a.canvas.height;this._drawn=true;this._pendingPathOps=[];this._strokePattern=null;this._strokePatternLength=0;this._strokePatternPos=0};Webgram.Canvas.prototype={clear:function(){this.context.clearRect(0,0,this.width,this.height)},getWidth:function(){return this.width},setWidth:function(a){this.width=a;this.context.canvas.width=a},getHeight:function(){return this.height},setHeight:function(a){this.height=a;this.context.canvas.height=a},paint:function(f,c,e){this.context._strokePattern=null;if(f){if(f.lineWidth>0){this.context.lineWidth=f.lineWidth;this.context.lineCap=f.lineCap;this.context.lineJoin=f.lineJoin;this.context.miterLimit=f.miterLimit;if(f.pattern){this.context._strokePattern=[Math.max(f.pattern[0]-f.lineWidth,0.1),Math.max(f.pattern[1]+f.lineWidth,0.1)];this.context._strokePatternLength=f.pattern[0]+f.pattern[1];this.context._strokePatternPos=0}if(f.colors instanceof Array){if(f.colors.length===1){this.context.strokeStyle=f.colors[0]}else{this.context.strokeStyle=this._getGradient(f.colors,f.gradientPoint1,f.gradientPoint2,f.gradientRadius1,f.gradientRadius2,e)}}else{this.context.strokeStyle=f.colors}}else{f=null}}if(c){if(c.colors instanceof Array){if(c.colors.length===1){this.context.fillStyle=c.colors[0]}else{this.context.fillStyle=this._getGradient(c.colors,c.gradientPoint1,c.gradientPoint2,c.gradientRadius1,c.gradientRadius2,e)}}else{this.context.fillStyle=c.colors}}e.applyToCanvas(this);var d=null;var b;if(f&&f.pattern&&f.pattern.length&&c){this.context._transparentStroke=true;b=this._commitPathOps(d,e);delete this.context._transparentStroke;var a=this.context.strokeStyle;this.context.strokeStyle="transparent";if(b){this.context.fill()}this.context.strokeStyle=a;b=this._commitPathOps(d);if(b){this.context.stroke()}}else{b=this._commitPathOps(d,e);if(c&&b){this.context.fill()}if(f&&b){this.context.stroke()}}this._pendingPathOps=[];e.restoreCanvas(this)},drawLine:function(b,a){this._pendingPathOps.push([this._actualDrawLine,[b,a]])},drawPoly:function(b,a){this._pendingPathOps.push([this._actualDrawPoly,[b,a]])},drawArc:function(a,e,d,c,b){this._pendingPathOps.push([this._actualDrawArc,[a,e,d,c,b]])},drawBezier:function(d,c,b,a){this._pendingPathOps.push([this._actualDrawBezier,[d,c,b,a]])},drawImage:function(e,a,b,f,d,c){a=c.roundPoint(a);c.applyToCanvas(this);this.context.translate(a.x,a.y);this.context.rotate(f);this.context.translate(-b.width/2,-b.height/2);this.context.globalAlpha=d;this.context.drawImage(e,0,0,b.width,b.height);this.context.globalAlpha=1;c.restoreCanvas(this)},drawText:function(g,d,e,f){var b=f.roundPoint(d.getTopLeft());var a=f.roundPoint(d.getBottomRight());d=new Webgram.Geometry.Rectangle(b.x,b.y,a.x,a.y);f.applyToCanvas(this);switch(e.justify[0]){case"l":this.context.textAlign="left";break;case"c":this.context.textAlign="center";break;case"r":this.context.textAlign="right";break}switch(e.justify[1]){case"t":this.context.textBaseline="top";break;case"c":this.context.textBaseline="middle";break;case"b":this.context.textBaseline="bottom";break}var j=this.layoutText(g,d,e).lines;this.context.fillStyle=e.color;for(var c=0;c<j.length;c++){var h=j[c];this.context.fillText(h.text,h.x,h.y)}f.restoreCanvas(this)},getTextSize:function(c,b){var a="";if(b.bold){a+="bold "}if(b.italic){a+="italic "}if(b.size!=null){a+=b.size+"px "}if(b.font!=null){a+=b.font}if(this.context.font!==a){this.context.font=a}return new Webgram.Geometry.Size(this.context.measureText(c).width,b.size)},layoutText:function(q,m,c){var I="";if(c.bold){I+="bold "}if(c.italic){I+="italic "}if(c.size!=null){I+=c.size+"px "}if(c.font!=null){I+=c.font}if(this.context.font!==I){this.context.font=I}var e=new RegExp("[ \t\r][a-zA-Z]","m");var D,C,d;var p,z,E,v=[];while(q.length>0){d=q.search(e);if(d===-1){d=q.length-1}E=q.substring(0,d+1);z="";for(C=0;C<E.length;C++){p=E[C];if(p==="\n"){if(z.length>0){v.push(z)}v.push("");z=""}else{z+=p}}if(z.length){v.push(z)}q=q.substring(d+1)}var w,J=0,k=m.getWidth();var o="",a=[];var K=[];for(D=0;D<v.length;D++){E=v[D];if(E.length===0){a.push(o);K.push(J);J=0;o="";continue}w=this.context.measureText(E).width;if((J+w>k)&&o!==""){if(o.length>0&&o[o.length-1]){o=o.substring(0,o.length-1);J=this.context.measureText(o).width}a.push(o);K.push(J);J=0;o=""}J+=w;o+=E}if(o.length>0||v.length===0){a.push(o);K.push(J)}var g=v.length&&v[v.length-1];if(g!=null&&g.length===0){a.push("");K.push(0)}var u,t,l,h,s,G,f,b;switch(c.justify[0]){case"l":u=m.x1;b=m.x1;break;case"c":u=(m.x1+m.x2)/2;break;case"r":u=m.x2;G=m.x2;break}switch(c.justify[1]){case"t":t=m.y1;s=m.y1;break;case"c":t=(m.y1+m.y2)/2;break;case"b":t=m.y2;f=m.y2;break}var r=[];var A,n,B,F;var H=m.getCenter();for(D=0;D<a.length;D++){o=a[D];w=K[D];l=u;if(b==null){if(G==null){F=H.x-w/2;n=H.x+w/2}else{n=H.x+G;F=n-w}}else{F=H.x+b;n=F+w}if(s==null){if(f==null){h=t+(D-a.length/2+0.5)*c.size;A=h-c.size/2;B=h+c.size/2}else{h=t-(a.length-D-1)*c.size;A=h-c.size;B=h}}else{h=t+D*c.size;A=h;B=h+c.size}r.push({text:o,x:l,y:h,top:A,right:n,bottom:B,left:F});q+=o;if(D<a.length-1){q+="\n"}}return{lines:r,text:q}},_commitPathOps:function(d,e){this._drawn=true;this.context.beginPath();var a=false;for(var b=0;b<this._pendingPathOps.length;b++){var c=this._pendingPathOps[b];c[1].push(d);c[1].push(e);a=c[0].apply(this,c[1])||a}this._drawn=false;return a},_actualDrawLine:function(b,a,c,d){b=d.roundPoint(b);a=a&&d.roundPoint(a);if(this._drawn){this.context.moveTo(b.x,b.y)}else{this.context.lineTo(b.x,b.y)}if(a!=null){this.context.lineTo(a.x,a.y)}this._drawn=false;return true},_actualDrawPoly:function(f,b,e,g){var c,d=[];for(c=0;c<f.points.length;c++){d.push(g.roundPoint(f.points[c]))}f=new Webgram.Geometry.Poly(d);if(this._drawn){this.context.moveTo(f.points[0].x,f.points[0].y)}else{this.context.lineTo(f.points[0].x,f.points[0].y)}for(c=1;c<f.points.length;c++){var a=f.points[c];this.context.lineTo(a.x,a.y)}if(b){this.context.lineTo(f.points[0].x,f.points[0].y)}this._drawn=false;return true},_actualDrawArc:function(b,d,c,h,f,a,i){b=i.roundPoint(b);h=Webgram.Utils.normalizeAngle(h);f=Webgram.Utils.normalizeAngle(f);var l=b.x+(d*Math.cos(h));var k=b.y+(c*Math.sin(h));if(this._drawn){this.context.moveTo(l,k)}else{this.context.lineTo(l,k)}var j=Math.max(d,c);var e=0.5/Math.sqrt(j);var g=h;if(h<f){while(g<=f){l=b.x+(d*Math.cos(g));k=b.y+(c*Math.sin(g));this.context.lineTo(l,k);g+=e}}else{while(g<2*Math.PI){l=b.x+(d*Math.cos(g));k=b.y+(c*Math.sin(g));this.context.lineTo(l,k);g+=e}g=0;while(g<=f){l=b.x+(d*Math.cos(g));k=b.y+(c*Math.sin(g));this.context.lineTo(l,k);g+=e}}l=b.x+(d*Math.cos(f));k=b.y+(c*Math.sin(f));this.context.lineTo(l,k);if(Webgram.Utils.normalizeAngle(h)===Webgram.Utils.normalizeAngle(f)){this.context.closePath()}this._drawn=false;return true},_actualDrawBezier:function(g,e,j,i,a,c){g=c.roundPoint(g);e=c.roundPoint(e);if(this._drawn){this.context.moveTo(g.x,g.y)}else{this.context.lineTo(g.x,g.y)}if(this.context._strokePattern&&!this.context._transparentStroke){if(i!=null){var d=g.getDistanceTo(j)+j.getDistanceTo(i)+i.getDistanceTo(e);var b=100/(d*10);for(var k=0;k<1;k+=b){var h=Math.pow(1-k,3)*g.x+3*Math.pow(1-k,2)*k*j.x+3*(1-k)*k*k*i.x+Math.pow(k,3)*e.x;var f=Math.pow(1-k,3)*g.y+3*Math.pow(1-k,2)*k*j.y+3*(1-k)*k*k*i.y+Math.pow(k,3)*e.y;this.context.lineTo(h,f)}}else{var d=g.getDistanceTo(j)+j.getDistanceTo(e);var b=10/d;for(var k=0;k<1;k+=b){var h=Math.pow(1-k,2)*g.x+2*(1-k)*k*j.x+Math.pow(k,2)*e.x;var f=Math.pow(1-k,2)*g.y+2*(1-k)*k*j.y+Math.pow(k,2)*e.y;this.context.lineTo(h,f)}}this.context.lineTo(e.x,e.y)}else{if(i!=null){this.context.bezierCurveTo(j.x,j.y,i.x,i.y,e.x,e.y)}else{this.context.quadraticCurveTo(j.x,j.y,e.x,e.y)}}this._drawn=false;return true},_getGradient:function(a,h,g,f,c,e){var b,d;if(f!=null){d=this.context.createRadialGradient(h.x,h.y,f,h.x,h.y,c);for(b=0;b<a.length;b++){d.addColorStop(b/(a.length-1),a[b])}}else{d=this.context.createLinearGradient(h.x,h.y,g.x,g.y);for(b=0;b<a.length;b++){d.addColorStop(b/(a.length-1),a[b])}}return d}};Webgram.Class("Webgram.Canvas");Webgram.Canvas.TransformSet=function(){this._transforms=[]};Webgram.Canvas.TransformSet.prototype={addTranslation:function(b,a){if(b===0&&a===0){return}this._transforms.unshift(["t",b,a])},addRotation:function(a){if(a===0){return}this._transforms.unshift(["r",a])},addScaling:function(a){if(a===1){return}this._transforms.unshift(["s",a])},applyToCanvas:function(b){b.context.save();for(var c=0;c<this._transforms.length;c++){var a=this._transforms[c];if(a[0]==="t"){b.context.translate(a[1],a[2])}else{if(a[0]==="r"){b.context.rotate(a[1])}else{if(a[0]==="s"){b.context.scale(a[1],a[1])}}}}},restoreCanvas:function(a){a.context.restore()},applyToGeometry:function(d,b){var c;if(!b){for(c=this._transforms.length-1;c>=0;c--){var a=this._transforms[c];if(a[0]==="t"){d=d.getTranslated(a[1],a[2])}else{if(a[0]==="r"){d=d.getRotated(a[1])}else{if(a[0]==="s"){d=d.getScaled(a[1],a[1])}}}}}else{for(c=0;c<this._transforms.length;c++){var a=this._transforms[c];if(a[0]==="t"){d=d.getTranslated(-a[1],-a[2])}else{if(a[0]==="r"){d=d.getRotated(-a[1])}else{if(a[0]==="s"){d=d.getScaled(1/a[1],1/a[1])}}}}}return d},roundPoint:function(a){a=this.applyToGeometry(a);a=a.round().getTranslated(0.5,0.5);a=this.applyToGeometry(a,true);return a},};Webgram.Class("Webgram.Canvas.TransformSet");Webgram.ControlPoint=function(){this.radius=9;this.drawingElement=null;this._anchor=null;this._focusType=Webgram.ControlPoint.FOCUS_NONE;this._strokeStyle=Webgram.Styles.getStrokeStyle("default");this._fillStyle=Webgram.Styles.getFillStyle("default");this._snapToGridEnabled=false;this.onBeginMove=new Webgram.Event("begin move",this);this.onEndMove=new Webgram.Event("end move",this);this.onMove=new Webgram.Event("move",this);this.onUpdate=new Webgram.Event("update",this);this.onMouseEnter=new Webgram.Event("mouse enter",this);this.onMouseLeave=new Webgram.Event("mouse leave",this);this.onAdd=new Webgram.Event("add",this);this.onRemove=new Webgram.Event("remove",this);this.onSelect=new Webgram.Event("select",this);this.onUnselect=new Webgram.Event("unselect",this);this.onChangeFocus=new Webgram.Event("change focus",this)};Webgram.ControlPoint.FOCUS_NONE=0;Webgram.ControlPoint.FOCUS_HOVERED=1;Webgram.ControlPoint.FOCUS_SELECTED=2;Webgram.ControlPoint.prototype={getFocusType:function(){return this._focusType},setFocusType:function(a){var b=false;if(this._focusType!==a){b=true}this._focusType=a;if(b){this.onChangeFocus.trigger()}},getCursor:function(){return"default"},draw:function(){},drawLine:function(c,b){var a=this.getAnchor();c=this._scaleDownToZoomFactor(c);b=b&&this._scaleDownToZoomFactor(b);c=c.getTranslated(a.x,a.y);b=b&&b.getTranslated(a.x,a.y);this.drawingElement._parent.drawLine(c,b)},drawRect:function(a){this.drawPoly(a.getPoly(),true)},drawPoly:function(f,b){var c=this.getAnchor();var e=[];for(var d=0;d<f.points.length;d++){var a=f.points[d];a=this._scaleDownToZoomFactor(a);a=a.getTranslated(c.x,c.y);e.push(a)}f=new Webgram.Geometry.Poly(e);this.drawingElement._parent.drawPoly(f,b)},drawArc:function(a,f,e,d,b){var c=this.getAnchor();a=a.getTranslated(c.x,c.y);this.drawingElement._parent.drawArc(a,f,e,d,b)},drawBezier:function(e,d,b,a){var c=this.getAnchor();e=e.getTranslated(c.x,c.y);d=d.getTranslated(c.x,c.y);b=b.getTranslated(c.x,c.y);a=a.getTranslated(c.x,c.y);this.drawingElement._parent.drawBezier(e,d,b,a)},drawImage:function(e,a,c,f,d){var b=this.getAnchor();a=a.getTranslated(b.x,b.y);this.drawingElement._parent.drawImage(e,a,c,f,d)},drawText:function(d,b,c){if(b==null){b=this.getBaseRectangle()}var a=this.getAnchor();b=b.getTranslated(a.x,a.y);this.drawingElement._parent.drawText(d,b,c)},paint:function(f,a){if(f===undefined){f=this._strokeStyle}if(a===undefined){a=this._fillStyle}if(f){f=f.clone()}if(a){a=a.clone()}var b=this.getAnchor();var e=[f,a];for(var c=0;c<e.length;c++){var d=e[c];if(!d){continue}if(d.gradientPoint1){d.gradientPoint1=this._scaleDownToZoomFactor(d.gradientPoint1);d.gradientPoint1=d.gradientPoint1.getTranslated(b.x,b.y)}if(d.gradientPoint2){d.gradientPoint2=this._scaleDownToZoomFactor(d.gradientPoint2);d.gradientPoint2=d.gradientPoint1.getTranslated(b.x,b.y)}}this.drawingElement._parent.paint(f,a)},getZoomFactor:function(){return this.drawingElement.webgram.rootContainer._zoomFactor},getImageStore:function(){if(!this.drawingElement||!this.drawingElement.webgram){return null}return this.drawingElement.webgram.getImageStore()},getStrokeStyle:function(){return this._strokeStyle},setStrokeStyle:function(a){this._strokeStyle=a},getFillStyle:function(){return this._fillStyle},setFillStyle:function(a){this._fillStyle=a},getBoundingRectangle:function(){var a=this.radius/this.getZoomFactor();var b=this.getZoomFactor()/50;var c=this.getAnchor();return new Webgram.Geometry.Rectangle(c.x-a+b,c.y-a+b,c.x+a+b,c.y+a+b)},pointInside:function(a){return this.getBoundingRectangle().pointInside(a)},getAnchor:function(){if(!this._anchor){this.update(false)}return this._anchor},getOffsets:function(){return{x:0,y:0}},computeAnchor:function(){},processMove:function(a,b){},move:function(b){var c=this._getOffsets();var a=b;b=b.getTranslated(-c.x,-c.y);b=b.getRotated(this.drawingElement.getRotationAngle(),a);b=this.snap(b);this.processMove(b,a);this.onMove.trigger(b);this.update()},update:function(){var b=this.computeAnchor();var c=this._getOffsets();var a=this._anchor;this._anchor=b.getTranslated(c.x,c.y).getRotated(this.drawingElement.getRotationAngle(),b);if(a&&(this._anchor.x!==a.x||this._anchor.y!==a.y)){this.onUpdate.trigger(this._anchor.x-a.x,this._anchor.y-a.y)}},snap:function(a){if(this.isSnapToGridEnabled()&&this.getSetting("snapGrid")!=null){a=this.snapToGrid(a)}return a},snapToGrid:function(a){var b=this.getSetting("snapGrid");if(b==null){return a}a=new Webgram.Geometry.Point(Math.round(a.x/b.sizeX)*b.sizeX,Math.round(a.y/b.sizeY)*b.sizeY);return a},getSetting:function(a,b){if(!this.drawingElement){return null}return this.drawingElement.getSetting(a,b)},isSnapToGridEnabled:function(){return this._snapToGridEnabled},setSnapToGridEnabled:function(a){this._snapToGridEnabled=a},_getOffsets:function(){var d=this.getZoomFactor();var f=this.drawingElement.getStrokeStyle();var b=f?f.lineWidth/2:0;var c=this.getOffsets();var a=c.x/d;var e=c.y/d;if(c.x>0){a+=b}else{if(c.x<0){a-=b}}if(c.y>0){e+=b}else{if(c.y<0){e-=b}}return{x:a,y:e}},_scaleDownToZoomFactor:function(a){var b=Webgram.Geometry.Point.zero().getAngleTo(a);var c=Webgram.Geometry.Point.zero().getDistanceTo(a);return Webgram.Geometry.Point.zero().getPointAt(c/this.getZoomFactor(),b)}};Webgram.Class("Webgram.ControlPoint");Webgram.ActionMenuItem=function(a,c,b){Webgram.ControlPoint.call(this);if(!b){b="rt"}this.radius=15;this.icon=a;this.callback=c;this.align=b;this._strokeStyle=Webgram.Styles.getStrokeStyle("action-menu-item");this._fillStyle=Webgram.Styles.getFillStyle("action-menu-item");this._hoveredStrokeStyle=Webgram.Styles.getStrokeStyle("action-menu-item-hover");this._hoveredFillStyle=Webgram.Styles.getFillStyle("action-menu-item-hover");this.onActivate=new Webgram.Event("click",this)};Webgram.ActionMenuItem.prototype={draw:function(){var b=this.getImageStore().get(this.icon);if(!b){return}var a=new Webgram.Geometry.Rectangle(-this.radius,-this.radius,this.radius,this.radius);this.drawPoly(a.getPoly().getRotated(this.drawingElement.getRotationAngle()),true);if(this.getFocusType()===Webgram.ActionMenuItem.FOCUS_HOVERED){this.paint(this._hoveredStrokeStyle,this._hoveredFillStyle);this.drawImage(b.content,Webgram.Geometry.Point.zero(),b.size,0,1)}else{this.paint();this.drawImage(b.content,Webgram.Geometry.Point.zero(),b.size,0,0.5)}},getStrokeStyle:function(a){if(a){return this._strokeStyle}else{return this._hoveredStrokeStyle}},setStrokeStyle:function(b,a){if(a){this._hoveredStrokeStyle=b}else{this._strokeStyle=b}},getFillStyle:function(a){if(a){return this._hoveredFillStyle}else{return this._fillStyle}},setFillStyle:function(a,b){if(b){this._hoveredFillStyle=a}else{this._fillStyle=a}},computeAnchor:function(){var a=this.drawingElement.getBounds();if(this.align[0]==="t"){if(this.align[1]==="l"){return a.topLeft}else{if(this.align[1]==="c"){return a.top}else{if(this.align[1]==="r"){return a.topRight}}}}if(this.align[0]==="b"){if(this.align[1]==="l"){return a.bottomLeft}else{if(this.align[1]==="c"){return a.bottom}else{if(this.align[1]==="r"){return a.bottomRight}}}}if(this.align[0]==="l"){if(this.align[1]==="t"){return a.topLeft}else{if(this.align[1]==="c"){return a.left}else{if(this.align[1]==="b"){return a.bottomLeft}}}}if(this.align[0]==="r"){if(this.align[1]==="t"){return a.topRight}else{if(this.align[1]==="c"){return a.right}else{if(this.align[1]==="b"){return a.bottomRight}}}}},update:function(){var a=this.computeAnchor();var b=this._getOffsets();this._anchor=a.getTranslated(b.x,b.y).getRotated(this.drawingElement.getRotationAngle(),a)},activate:function(){this.callback.call(this);this.onActivate.trigger()},_getSiblingCounts:function(){var c=0;var a=0;var e=true;for(var b=0;b<this.drawingElement._actionMenuItems.length;b++){var d=this.drawingElement._actionMenuItems[b];if(d===this){e=false}if(d.align===this.align){if(e){c++}a++}}return[c,a]},_getOffsets:function(){var a=this.getZoomFactor();var f=this.drawingElement.getStrokeStyle();var i=f.lineWidth/2;var j=0;var g=0;var e=20;var d=20;var c=this.getOffsets();var h=this._getSiblingCounts();var b=h[0];var k=h[1];if(this.align[0]==="t"||this.align[0]==="b"){if(this.align[0]==="t"){g=-this.radius-d}else{g=this.radius+d}if(this.align[1]==="l"){j=this.radius*2*b}else{if(this.align[1]==="c"){j=this.radius*2*(b-(k-1)/2)}else{if(this.align[1]==="r"){j=-this.radius*2*b}}}}if(this.align[0]==="l"||this.align[0]==="r"){if(this.align[0]==="l"){j=-this.radius-e}else{j=this.radius+e}if(this.align[1]==="t"){g=this.radius*2*b}else{if(this.align[1]==="c"){g=this.radius*2*(b-(k-1)/2)}else{if(this.align[1]==="b"){g=-this.radius*2*b}}}}j=Math.round(j);g=Math.round(g);j/=a;g/=a;if(c.x>0){j+=i}else{if(c.x<0){j-=i}}if(c.y>0){g+=i}else{if(c.y<0){g-=i}}return{x:j,y:g}}};Webgram.Class("Webgram.ActionMenuItem",Webgram.ControlPoint);Webgram.DrawingElement=function(b,a){if(a==null||a.length===0){a=[Webgram.Geometry.Point.zero()]}this.webgram=null;this.shape=new Webgram.Geometry.Poly(a);this.rotationCenter=new Webgram.Geometry.Point(0,0);this.zIndex=0;this.minPointCount=1;this.onKeyPress=new Webgram.Event("key press",this);this.onKeyDown=new Webgram.Event("key down",this);this.onKeyUp=new Webgram.Event("key up",this);this.onMouseDown=new Webgram.Event("mouse down",this);this.onMouseUp=new Webgram.Event("mouse up",this);this.onMouseMove=new Webgram.Event("mouse move",this);this.onMouseScroll=new Webgram.Event("mouse scroll",this);this.onMouseEnter=new Webgram.Event("mouse enter",this);this.onMouseLeave=new Webgram.Event("mouse leave",this);this.onBeginRotate=new Webgram.Event("begin rotate",this);this.onRotate=new Webgram.Event("rotate",this);this.onEndRotate=new Webgram.Event("end rotate",this);this.onFlipHorizontally=new Webgram.Event("flip horizontally",this);this.onFlipVertically=new Webgram.Event("flip vertically",this);this.onAdd=new Webgram.Event("add",this);this.onRemove=new Webgram.Event("remove",this);this.onSelect=new Webgram.Event("select",this);this.onUnselect=new Webgram.Event("unselect",this);this.onIndexChange=new Webgram.Event("index change",this);this.onMove=new Webgram.Event("move",this);this.onChangeFocus=new Webgram.Event("change focus",this);this.onShapeBeginChange=new Webgram.Event("begin change",this);this.onShapeEndChange=new Webgram.Event("end change",this);this.onShapeChange=new Webgram.Event("change",this);this._strokeStyle=Webgram.Styles.getStrokeStyle("default");this._fillStyle=Webgram.Styles.getFillStyle("default");this._textStyle=Webgram.Styles.getTextStyle("default");this._guidesStyle=Webgram.Styles.getStrokeStyle("default-guides");this._hoveredDecorationStyle=Webgram.Styles.getStrokeStyle("default-hovered-decoration");this._selectedDecorationStyle=Webgram.Styles.getStrokeStyle("default-selected-decoration");this._rotationAngle=0;this._flippedHorizontally=false;this._flippedVertically=false;this._parent=null;this._id=b;this._mouseDownPoint=null;this._creating=false;this._cachedBaseRectangle=null;this._shapeChanged=false;this._updatePoints=false;this._focusType=Webgram.DrawingElement.FOCUS_NONE;this._jsonFields=[];this._jsonFuncs=[];this._shiftBehaviors=[];this._hoveredControlPointsEnabled=false;this._selectEnabled=true;this._moveEnabled=true;this._snapToAngleEnabled=false;this._snapInternallyEnabled=false;this._snapExternallyEnabled=false;this._snapToGridEnabled=true;this._rotateEnabled=false;this._flipEnabled=true;this._gradientEditEnabled=false;this._shiftEnabled=false;this._controlPoints=[];this._proportionalPoints=[];this._sockets=[];this._actionMenuItems=[];this._parentRelativePositions=[];this._parentRelativePositions=[];this._cachedBaseRectangle=this._computeBaseRectangle();this.setRotateEnabled(false)};Webgram.DrawingElement.FOCUS_NONE=0;Webgram.DrawingElement.FOCUS_HOVERED=1;Webgram.DrawingElement.FOCUS_SELECTED=2;Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE=3;Webgram.DrawingElement.prototype={getId:function(){return this._id},setId:function(a){this._id=a},getFocusType:function(){return this._focusType},setFocusType:function(a){var b=false;if(this._focusType!==a){b=true}this._focusType=a;if(b){this.onChangeFocus.trigger()}if(a==Webgram.DrawingElement.FOCUS_SELECTED&&this._parent){this._parent.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED)}},toString:function(){var a=this.constructor.toString();if(this._id===undefined){a+="(undefined)"}else{if(this._id===null){a+="(null)"}else{if(this._id!==undefined){a+='("'+this._id+'")'}}}return a},getCursor:function(){if(this.isMoveEnabled()){return"move"}else{return"default"}},draw:function(){},drawTop:function(){},drawNoZoom:function(){},drawNoZoomTop:function(){this.drawDecoration();if(this.getFocusType()===Webgram.DrawingElement.FOCUS_SELECTED||this.getFocusType()===Webgram.DrawingElement.FOCUS_HOVERED){this.drawGuides()}},drawDecoration:function(){switch(this.getFocusType()){case Webgram.DrawingElement.FOCUS_NONE:break;case Webgram.DrawingElement.FOCUS_HOVERED:if(this._hoveredDecorationStyle){this.drawPoly(this.getDecorationPoly(),true);this.paint(this._hoveredDecorationStyle,null)}break;case Webgram.DrawingElement.FOCUS_SELECTED:if(this._selectedDecorationStyle){this.drawPoly(this.getDecorationPoly(),true);this.paint(this._selectedDecorationStyle,null)}break}},drawGuides:function(){if(this.isGradientEditEnabled()){this.drawGradientLines(this._fillStyle);this.drawGradientLines(this._strokeStyle)}this.drawRotationCenterLine()},drawRotationCenterLine:function(){this.drawLine(Webgram.Geometry.Point.zero(),this.rotationCenter);this.paint(this._guidesStyle,null)},drawGradientLines:function(a){if(this.getFocusType()!==Webgram.DrawingElement.FOCUS_SELECTED){return}if(a==null){return}if(a.gradientPoint1!=null){if(a.gradientPoint1._radiusPoint1){this.drawLine(a.gradientPoint1,a.gradientPoint1._radiusPoint1);this.drawLine(a.gradientPoint1,a.gradientPoint1._radiusPoint2);this.paint(this._guidesStyle,null)}else{this.drawLine(a.gradientPoint1,a.gradientPoint2);this.paint(this._guidesStyle,null)}}},drawControlPoints:function(){if((this._focusType===Webgram.DrawingElement.FOCUS_HOVERED&&this.isHoveredControlPointsEnabled())||this._focusType===Webgram.DrawingElement.FOCUS_SELECTED){for(var b=0;b<this._controlPoints.length;b++){var a=this._controlPoints[b];a.draw()}}},drawSockets:function(){for(var b=0;b<this._sockets.length;b++){var a=this._sockets[b];a.draw()}},drawActionMenuItems:function(){if(this._focusType===Webgram.DrawingElement.FOCUS_SELECTED){for(var a=0;a<this._actionMenuItems.length;a++){var b=this._actionMenuItems[a];b.draw()}}},invalidate:function(a){if(this.webgram){this.webgram.invalidate();if(a){this.webgram.invalidateMini()}}},getDecorationOffset:function(){return this.getSetting("decorationOffset")},drawLine:function(b,a){if(this.webgram.rootContainer._noZoom){b=this.transformDirect(b);a=a&&this.transformDirect(a)}this._parent.drawLine(b,a)},drawRect:function(a){var b=a.getPoly();if(this.webgram.rootContainer._noZoom){b=this.transformDirect(b)}this._parent.drawPoly(b,true)},drawPoly:function(b,a){if(this.webgram.rootContainer._noZoom){b=this.transformDirect(b)}this._parent.drawPoly(b,a)},drawArc:function(a,e,d,c,b){if(this.webgram.rootContainer._noZoom){a=this.transformDirect(a);c+=this.getRotationAngle();b+=this.getRotationAngle()}this._parent.drawArc(a,e,d,c,b)},drawBezier:function(d,c,b,a){if(this.webgram.rootContainer._noZoom){d=this.transformDirect(d);c=this.transformDirect(c);b=this.transformDirect(b);a=this.transformDirect(a)}this._parent.drawBezier(d,c,b,a)},drawImage:function(e,a,b,f,d){if(this.webgram.rootContainer._noZoom){a=this.transformDirect(a)}var c=null;if(!this.webgram.rootContainer._noZoom){c=this._getTransformSet()}this._parent.drawImage(e,a,b,f,d,c)},drawText:function(d,a,c){if(a==null){a=this.translateInverse(this.getBaseRectangle())}if(c==null){c=this._textStyle}if(this.webgram.rootContainer._noZoom){a=this.translateDirect(a)}var b=null;if(!this.webgram.rootContainer._noZoom){b=this._getTransformSet()}this._parent.drawText(d,a,c,b)},getTextSize:function(b,a){if(a==null){a=this.getTextStyle()}if(this.webgram==null){return null}return this.webgram.canvas.getTextSize(b,a)},layoutText:function(c,a,b){if(a==null){a=this.translateInverse(this.getBaseRectangle())}if(b==null){b=this.getTextStyle()}if(this.webgram==null){return null}return this.webgram.canvas.layoutText(c,a,b)},paint:function(c,a){var b=null;if(!this.webgram.rootContainer._noZoom){b=this._getTransformSet()}if(c===undefined){c=this.getStrokeStyle()}if(a===undefined){a=this.getFillStyle()}this._parent.paint(c,a,b)},getDrawingWidth:function(){return Math.round(this.getWidth())},getDrawingHeight:function(){return Math.round(this.getHeight())},getDrawingSize:function(){return new Webgram.Geometry.Size(this.getDrawingWidth(),this.getDrawingHeight())},getDrawingRectangle:function(){var b=this.getDrawingWidth();var a=this.getDrawingHeight();return new Webgram.Geometry.Rectangle(-b/2+0.5,-a/2+0.5,b/2-0.5,a/2-0.5)},getDrawingPoly:function(){return this.translateInverse(this.shape)},getDecorationRectangle:function(){return this.getDrawingRectangle()},getDecorationPoly:function(){var e=this.getDecorationRectangle();var d=this.getStrokeStyle();var b=this.getZoomFactor();var a=d?d.lineWidth/2:0;var c=this.getDecorationOffset()/b;e=e.getShrinked(-(a+c));return e.getPoly()},getZoomFactor:function(){return this.webgram.rootContainer._zoomFactor},getImageStore:function(){if(!this.webgram){return null}return this.webgram.getImageStore()},getStrokeStyle:function(){return this._strokeStyle},setStrokeStyle:function(d){var a=this.isGradientEditEnabled();if(a){this.setGradientEditEnabled(false)}this._clearGradientProportionalPoints(this._strokeStyle);if(d!=null){if(this._strokeStyle==null){this._strokeStyle=Webgram.Styles.getStrokeStyle("default")}var b=(this.getWidth()-1)/2;var c=(this.getHeight()-1)/2;if(d.lineWidth!==undefined){this._strokeStyle.lineWidth=d.lineWidth}if(d.lineCap!==undefined){this._strokeStyle.lineCap=d.lineCap}if(d.lineJoin!==undefined){this._strokeStyle.lineJoin=d.lineJoin}if(d.miterLimit!==undefined){this._strokeStyle.miterLimit=d.miterLimit}if(d.pattern!==undefined){this._strokeStyle.pattern=Webgram.Utils.clone(d.pattern)}if(d.colors!==undefined){this._strokeStyle.colors=Webgram.Utils.clone(d.colors)}if(d.gradientPoint1!==null){if(d.gradientPoint1!==undefined){this._strokeStyle.gradientPoint1=d.gradientPoint1}else{if(this._strokeStyle.gradientPoint1==null||((d.gradientRadius1===null)!==(this._strokeStyle.gradientRadius1===null))){if(d.gradientRadius1!==null){this._strokeStyle.gradientPoint1=Webgram.Geometry.Point.zero()}else{this._strokeStyle.gradientPoint1=new Webgram.Geometry.Point(-b,-c)}}}}else{this._strokeStyle.gradientPoint1=null}if(d.gradientPoint2!==null){if(d.gradientPoint2!==undefined){this._strokeStyle.gradientPoint2=d.gradientPoint2}else{if(this._strokeStyle.gradientPoint2==null){this._strokeStyle.gradientPoint2=new Webgram.Geometry.Point(b,c)}}}else{this._strokeStyle.gradientPoint2=null}if(d.gradientRadius1!==null){if(d.gradientRadius1!==undefined){this._strokeStyle.gradientRadius1=d.gradientRadius1}else{if(this._strokeStyle.gradientRadius1==null){this._strokeStyle.gradientRadius1=0}}}else{this._strokeStyle.gradientRadius1=null}if(d.gradientRadius2!==null){if(d.gradientRadius2!==undefined){this._strokeStyle.gradientRadius2=d.gradientRadius2}else{if(this._strokeStyle.gradientRadius2==null){this._strokeStyle.gradientRadius2=Math.min(b,c)}}}else{this._strokeStyle.gradientRadius2=null}this._setGradientProportionalPoints(this._strokeStyle);if(a){this.setGradientEditEnabled(true)}}else{this._strokeStyle=null}this.invalidatePoints();this.invalidate(true)},getFillStyle:function(){return this._fillStyle},setFillStyle:function(b){var a=this.isGradientEditEnabled();if(a){this.setGradientEditEnabled(false)}this._clearGradientProportionalPoints(this._fillStyle);if(b!=null){if(this._fillStyle==null){this._fillStyle=Webgram.Styles.getFillStyle("default")}var c=(this.getWidth()-1)/2;var d=(this.getHeight()-1)/2;if(b.colors!==undefined){this._fillStyle.colors=Webgram.Utils.clone(b.colors)}if(b.gradientPoint1!==null){if(b.gradientPoint1!==undefined){this._fillStyle.gradientPoint1=b.gradientPoint1}else{if(this._fillStyle.gradientPoint1==null||((b.gradientRadius1===null)!==(this._fillStyle.gradientRadius1===null))){if(b.gradientRadius1!==null){this._fillStyle.gradientPoint1=Webgram.Geometry.Point.zero()}else{this._fillStyle.gradientPoint1=new Webgram.Geometry.Point(-c,-d)}}}}else{this._fillStyle.gradientPoint1=null}if(b.gradientPoint2!==null){if(b.gradientPoint2!==undefined){this._fillStyle.gradientPoint2=b.gradientPoint2}else{if(this._fillStyle.gradientPoint2==null){this._fillStyle.gradientPoint2=new Webgram.Geometry.Point(c,d)}}}else{this._fillStyle.gradientPoint2=null}if(b.gradientRadius1!==null){if(b.gradientRadius1!==undefined){this._fillStyle.gradientRadius1=b.gradientRadius1}else{if(this._fillStyle.gradientRadius1==null){this._fillStyle.gradientRadius1=0}}}else{this._fillStyle.gradientRadius1=null}if(b.gradientRadius2!==null){if(b.gradientRadius2!==undefined){this._fillStyle.gradientRadius2=b.gradientRadius2}else{if(this._fillStyle.gradientRadius2==null){this._fillStyle.gradientRadius2=Math.min(c,d)}}}else{this._fillStyle.gradientRadius2=null}this._setGradientProportionalPoints(this._fillStyle);if(a){this.setGradientEditEnabled(true)}}else{this._fillStyle=null}this.invalidate(true)},getTextStyle:function(){return this._textStyle},setTextStyle:function(a){if(a!=null){if(this._textStyle==null){this._textStyle=Webgram.Styles.getTextStyle("default")}if(a.color!==undefined){this._textStyle.color=a.color}if(a.font!==undefined){this._textStyle.font=a.font}if(a.size!==undefined){this._textStyle.size=a.size}if(a.bold!==undefined){this._textStyle.bold=a.bold}if(a.italic!==undefined){this._textStyle.italic=a.italic}if(a.justify!==undefined){this._textStyle.justify=a.justify}}else{this._textStyle=null}this.invalidate(true)},getGuidesStyle:function(){return this._guidesStyle},setGuidesStyle:function(a){this._guidesStyle=a;this.invalidate()},getDecorationStyle:function(a){if(a){return this._hoveredDecorationStyle}else{return this._selectedDecorationStyle}},setDecorationStyle:function(b,a){if(a){this._hoveredDecorationStyle=b}else{this._selectedDecorationStyle=b}this.invalidate()},transformDirect:function(b){var a=this.getBaseRectangle().getCenter();return b.getTranslated(a.x,a.y).getRotated(this.getRotationAngle(),a)},transformInverse:function(b){var a=this.getBaseRectangle().getCenter();return b.getRotated(-this.getRotationAngle(),a).getTranslated(-a.x,-a.y)},translateDirect:function(b){var a=this.getBaseRectangle().getCenter();return b.getTranslated(a.x,a.y)},translateInverse:function(b){var a=this.getBaseRectangle().getCenter();return b.getTranslated(-a.x,-a.y)},rotateDirect:function(b){var a=this.getBaseRectangle().getCenter();return b.getRotated(this.getRotationAngle(),a)},rotateInverse:function(b){var a=this.getBaseRectangle().getCenter();return b.getRotated(-this.getRotationAngle(),a)},getBaseRectangle:function(){if(!this._cachedBaseRectangle){this._cachedBaseRectangle=this._computeBaseRectangle();this.restoreProportionalPoints();if(!this._shapeChanged){this._shapeChanged=true;this.onShapeBeginChange.trigger()}this.onShapeChange.trigger()}return this._cachedBaseRectangle},invalidateBaseRectangle:function(){this._cachedBaseRectangle=null;this.invalidatePoints();this.invalidate()},triggerShapeChange:function(a){if(a){this.invalidateBaseRectangle()}this.getBaseRectangle();if(this._shapeChanged){if(this.webgram){this.invalidate(true);this.webgram.onDrawingElementChange.trigger(this)}this._shapeChanged=false;this.onShapeEndChange.trigger()}},getBoundingRectangle:function(){return this.shape.getRotated(this.getRotationAngle(),this.getCenter()).getBoundingRectangle()},getBounds:function(){var b=this.getBaseRectangle();var a=b.getPoly().getRotated(this.getRotationAngle(),b.getCenter());return{topLeft:a.points[0],top:a.points[0].getCenterTo(a.points[1]),topRight:a.points[1],right:a.points[1].getCenterTo(a.points[2]),bottomRight:a.points[2],bottom:a.points[2].getCenterTo(a.points[3]),bottomLeft:a.points[3],left:a.points[3].getCenterTo(a.points[0])}},getCenter:function(){return this.getBaseRectangle().getCenter()},getWidth:function(){return this.getBaseRectangle().getWidth()},getHeight:function(){return this.getBaseRectangle().getHeight()},pointInside:function(a){return this.rotateDirect(this.getBaseRectangle().getPoly()).pointInside(a)},setRotatedShapePoint:function(b,a){this._setRotatedShapePoint(b,a,true);this.triggerShapeChange()},snap:function(f){if(f==null){var m,r,o;var g,l;var k=Infinity;var j=Infinity;var b=null;var a=null;var h={type:null,x:null,y:null,angle:null};var p=this.getCenter();var d=this.getRotationAngle();var c=this.getSnappingPoints();if(this.isSnapExternallyEnabled()){for(m=0;m<c.length;m++){var s=c.slice(0,m).concat(c.slice(m+1));l=c[m];g=this.snapExternally(m,l,s,0,p);if(g==null){continue}if(g.x!=null){r=g.x-l.x;if(Math.abs(r)<Math.abs(k)){k=r;b=g.x;h.x=g.x;h.type="linear"}}if(g.y!=null){o=g.y-l.y;if(Math.abs(o)<Math.abs(j)){j=o;a=g.y;h.y=g.y;h.type="linear"}}}}var n=b!=null;var e=a!=null;if(this.isSnapToGridEnabled()&&(b==null||a==null)){for(m=0;m<c.length;m++){l=c[m];g=this.snapToGrid(l,0,p);if(g==null){continue}if(g.x!=null&&!n){r=g.x-l.x;if(Math.abs(r)<Math.abs(k)){k=r;b=g.x}}if(g.y!=null&&!e){o=g.y-l.y;if(Math.abs(o)<Math.abs(j)){j=o;a=g.y}}}}if(k<Infinity){this.shape=this.shape.getTranslated(k,0);this.invalidateBaseRectangle()}if(j<Infinity){this.shape=this.shape.getTranslated(0,j);this.invalidateBaseRectangle()}if(h.type==null){h=null}this.setSnapVisualFeedback(h)}else{var q=this.rotateDirect(this.shape);this._setRotatedShapePoint(f,q.points[f],true)}},snapExternally:function(c,b,d,e,a){if(this.getSetting("snapDistance")){return this._snapToSiblings(b,e,a)}},snapInternally:function(c,b,d,e,a){},snapToGrid:function(b,d,a){var c=this.getSetting("snapGrid");if(c==null){return}b=new Webgram.Geometry.Point(Math.round(b.x/c.sizeX)*c.sizeX,Math.round(b.y/c.sizeY)*c.sizeY);return b},getSnappingPoints:function(){var a=Webgram.Utils.clone(this.rotateDirect(this.shape).points);a.push(this.getCenter());return a},applyShapePointConstraints:function(c,b,d,e,a){return b},setSnapVisualFeedback:function(a){if(this._parent!=null){this._parent.setSnapVisualFeedback(a)}},moveTo:function(b){var d=this.getCenter();var c=b.x-d.x;var a=b.y-d.y;this.shape=this.shape.getTranslated(c,a);this.invalidateBaseRectangle();this.snap();this.invalidateBaseRectangle();this.saveParentRelativePosition();if(this.isRotationCenterEnabled()){this.rotationCenterControlPoint.reset();this.setRotationCenterEnabled(false)}this.invalidatePoints();c=this.getCenter().x-d.x;a=this.getCenter().y-d.y;if(c!==0||a!==0){this.onMove.trigger(c,a)}if(!this._mouseDownPoint){this.triggerShapeChange()}this.invalidate()},getRotationAngle:function(){return Webgram.Utils.normalizeAngle(this._rotationAngle)},setRotationAngle:function(a){this.onBeginRotate.trigger();this._setRotationAngle(a);this.onRotate.trigger(a);this.onEndRotate.trigger();this.invalidate(true);if(this.webgram){this.webgram.onDrawingElementChange.trigger(this)}},isFlippedHorizontally:function(){return this._flippedHorizontally},flipHorizontally:function(){if(!this.isFlipEnabled()){return}if(this.isRotateEnabled()){this.setRotationAngle(-this.getRotationAngle())}this._flipGradientProportionalPoints(this._fillStyle,true);this._flipGradientProportionalPoints(this._strokeStyle,true);this.flipShapeHorizontally();this._flippedHorizontally=!this._flippedHorizontally;this.onFlipHorizontally.trigger()},flipShapeHorizontally:function(){var d=[];var b=this.getCenter();for(var c=0;c<this.shape.points.length;c++){var a=new Webgram.Geometry.Point(2*b.x-this.shape.points[c].x,this.shape.points[c].y);d.push(a)}this.shape=new Webgram.Geometry.Poly(d);this.invalidateBaseRectangle();this.invalidate(true)},isFlippedVertically:function(){return this._flippedVertically},flipVertically:function(){if(!this.isFlipEnabled()){return false}this._flipGradientProportionalPoints(this._fillStyle,this.isRotateEnabled());this._flipGradientProportionalPoints(this._strokeStyle,this.isRotateEnabled());if(this.isRotateEnabled()){this.setRotationAngle(Math.PI-this.getRotationAngle());this.flipShapeHorizontally()}else{this.flipShapeVertically()}this._flippedVertically=!this._flippedVertically;this.onFlipVertically.trigger()},flipShapeVertically:function(){var d=[];var b=this.getCenter();for(var c=0;c<this.shape.points.length;c++){var a=new Webgram.Geometry.Point(this.shape.points[c].x,2*b.y-this.shape.points[c].y);d.push(a)}this.shape=new Webgram.Geometry.Poly(d);this.invalidateBaseRectangle();this.invalidate(true)},saveParentRelativePosition:function(){var d=this._parent.getWidth();var c=this._parent.getHeight();this._parentRelativePositions=[];for(var b=0;b<this.shape.points.length;b++){var a=this.shape.points[b];a=this.rotateDirect(a);this._parentRelativePositions.push({x:a.x/(d-1),y:a.y/(c-1)})}},restoreParentRelativePosition:function(){var f=this._parent.getWidth();var e=this._parent.getHeight();for(var d=0;d<this._parentRelativePositions.length;d++){var b=this._parentRelativePositions[d];var a=new Webgram.Geometry.Point(b.x*(f-1),b.y*(e-1));this.shape.points[d]=a}var c=this.shape.getBoundingRectangle().getCenter();this.shape=this.shape.getRotated(-this.getRotationAngle(),c);this.invalidateBaseRectangle()},enterContainerElement:function(a){this._enterContainerElement(a,true)},leaveContainerElement:function(){this._leaveContainerElement(true)},getParent:function(){if(this._parent instanceof Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer){return this._parent._parent}else{return this._parent}},isEnclosed:function(){return this._parent&&this._parent._parent},updatePoints:function(){var c;for(c=0;c<this._sockets.length;c++){var a=this._sockets[c];a.update()}for(c=0;c<this._controlPoints.length;c++){var b=this._controlPoints[c];b.update()}for(c=0;c<this._actionMenuItems.length;c++){var d=this._actionMenuItems[c];d.update()}},invalidatePoints:function(){this._updatePoints=true;if(this._parent){this._parent.invalidatePoints()}},addProportionalPoint:function(a,b){if(!this.getBaseRectangle()){return}this._proportionalPoints.push(a);this.saveProportionalPoint(a);a._onChange=b},remProportionalPoint:function(a){this._proportionalPoints.splice(Webgram.Utils.indexOf(this._proportionalPoints,a),1);delete a._relativePosition;delete a._onChange},saveProportionalPoint:function(c){var d=this.getWidth();var b=this.getHeight();var a,e;if(d===1){a=0}else{a=c.x/(d-1)}if(b===1){e=0}else{e=c.y/(b-1)}c._relativePosition={x:a,y:e}},restoreProportionalPoints:function(){var d=this.getWidth();var b=this.getHeight();for(var c=0;c<this._proportionalPoints.length;c++){var a=this._proportionalPoints[c];a.x=(d-1)*a._relativePosition.x;a.y=(b-1)*a._relativePosition.y;if(a._onChange!=null){a._onChange.call(this,a)}}},addControlPoint:function(a){a.drawingElement=this;this._controlPoints.push(a);this.invalidate();a.onAdd.trigger(this)},remControlPoint:function(a){a.onRemove.trigger(this);a.drawingElement=null;this._controlPoints.splice(Webgram.Utils.indexOf(this._controlPoints,a),1);this.invalidate()},pointInsideControlPoint:function(a){for(var c=this._controlPoints.length-1;c>=0;c--){var b=this._controlPoints[c];if(b.pointInside(a)){return b}}return null},getControlPoints:function(a){var c=[];for(var d=0;d<this._controlPoints.length;d++){var b=this._controlPoints[d];if(!a||b instanceof a){c.push(b)}}return c},addSocket:function(a){a.drawingElement=this;this._sockets.push(a);this.invalidate()},remSocket:function(a){a.drawingElement=null;this._sockets.splice(Webgram.Utils.indexOf(this._sockets,a),1);this.invalidate()},getSockets:function(){return this._sockets.slice()},pointInsideSocket:function(a){for(var c=0;c<this._sockets.length;c++){var b=this._sockets[c];if(b.pointInside(a)){return b}}return null},addActionMenuItem:function(a){a.drawingElement=this;this._actionMenuItems.push(a);this.invalidate();a.onAdd.trigger(this)},remActionMenuItem:function(a){a.onRemove.trigger(this);a.drawingElement=null;this._actionMenuItems.splice(Webgram.Utils.indexOf(this._actionMenuItems,a),1);this.invalidate()},getActionMenuItems:function(){return this._actionMenuItems.slice()},pointInsideActionMenuItem:function(a){for(var b=0;b<this._actionMenuItems.length;b++){var c=this._actionMenuItems[b];if(c.pointInside(a)){return c}}return null},isHoveredControlPointsEnabled:function(){return this._hoveredControlPointsEnabled},setHoveredControlPointsEnabled:function(a){this._hoveredControlPointsEnabled=a},isSelectEnabled:function(){return this._selectEnabled},setSelectEnabled:function(a){this._selectEnabled=a},isMoveEnabled:function(){return this._moveEnabled},setMoveEnabled:function(a){this._moveEnabled=a},isRotateEnabled:function(){return this._rotateEnabled},setRotateEnabled:function(a){if(a){if(this._rotateEnabled){return}this.rotateControlPoint=new Webgram.ControlPoints.RotateControlPoint();this.addControlPoint(this.rotateControlPoint);this._rotateEnabled=true}else{if(!this._rotateEnabled){return}this.remControlPoint(this.rotateControlPoint);this.rotateControlPoint=null;if(this.rotationCenterControlPoint){this.setRotationCenterEnabled(false)}this._rotateEnabled=false}},isRotationCenterEnabled:function(){return this.rotationCenterControlPoint!=null},isRotationCenterMoved:function(){return(this.rotationCenter!=null)&&((this.rotationCenter.x!==0)||(this.rotationCenter.y!==0))},setRotationCenterEnabled:function(a){if(a){if(!this._rotateEnabled){return}if(this.rotationCenterControlPoint){return}this.rotationCenterControlPoint=new Webgram.ControlPoints.RotationCenterControlPoint();this.addControlPoint(this.rotationCenterControlPoint)}else{if(!this._rotateEnabled){return}if(!this.rotationCenterControlPoint){return}this.remControlPoint(this.rotationCenterControlPoint);this.rotationCenterControlPoint=null}},isFlipEnabled:function(){return this._flipEnabled},setFlipEnabled:function(a){this._flipEnabled=a},isGradientEditEnabled:function(){return this._gradientEditEnabled},setGradientEditEnabled:function(a){if(a){if(this._gradientEditEnabled){return}this._setGradientControlPoints(this._fillStyle);this._setGradientControlPoints(this._strokeStyle);this._gradientEditEnabled=true;this.invalidate()}else{if(!this._gradientEditEnabled){return}this._clearGradientControlPoints(this._fillStyle);this._clearGradientControlPoints(this._strokeStyle);this._gradientEditEnabled=false;this.invalidate()}},isSnapToAngleEnabled:function(){return this._snapToAngleEnabled},setSnapToAngleEnabled:function(a){this._snapToAngleEnabled=a},isSnapInternallyEnabled:function(){return this._snapInternallyEnabled},setSnapInternallyEnabled:function(a){this._snapInternallyEnabled=a},isSnapExternallyEnabled:function(){return this._snapExternallyEnabled},setSnapExternallyEnabled:function(a){this._snapExternallyEnabled=a},isSnapToGridEnabled:function(){return this._snapToGridEnabled},setSnapToGridEnabled:function(a){this._snapToGridEnabled=a},addShiftBehavior:function(a,c,b){if(b==null){b=false}if(c&&c.call(this)!==b){return}this._shiftBehaviors.push({controlFunc:a,testFunc:c,enabled:b,reverse:b})},enableShift:function(){if(this._shiftEnabled){return}for(var a=0;a<this._shiftBehaviors.length;a++){var b=this._shiftBehaviors[a];if(b.testFunc!=null){if(b.testFunc.call(this)!==b.reverse){continue}}b.controlFunc.call(this,!b.reverse);b.enabled=!b.reverse}this._shiftEnabled=true},disableShift:function(){if(!this._shiftEnabled){return}for(var a=0;a<this._shiftBehaviors.length;a++){var b=this._shiftBehaviors[a];if(b.testFunc!=null){if(b.testFunc.call(this)===b.reverse){continue}}b.controlFunc.call(this,b.reverse);b.enabled=b.reverse}this._shiftEnabled=false},isShiftEnabled:function(){return this._shiftEnabled},getSetting:function(a,b){if(!this.webgram){return null}return this.webgram.getSetting(a,b)},isCreating:function(){return this._creating},beginCreate:function(a){return false},continueCreate:function(b,c,a,d){return true},endCreate:function(){return true},shapeToJson:function(){var d,g,j=[];if(this._parent&&(this._parent instanceof Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer)){var e=this._parent;var h=e.getCenter();if(e.getRotationAngle()!==0){var a=this.getCenter();var f=a.getRotated(e.getRotationAngle());var c=h.x+f.x-a.x;var b=h.y+f.y-a.y;g=this.shape.getTranslated(c,b)}else{g=this.shape.getTranslated(h.x,h.y)}}else{g=this.shape}for(d=0;d<g.points.length;d++){j.push({x:g.points[d].x,y:g.points[d].y})}return j},shapeFromJson:function(d){var c,e=[];for(c=0;c<d.length;c++){var b=d[c];e.push(new Webgram.Geometry.Point(b.x,b.y))}this.shape=new Webgram.Geometry.Poly(e);var g=this.getRotationAngle();var a=this.getCenter();for(c=0;c<this.shape.points.length;c++){var f=this.shape.points.slice(0,c).concat(this.shape.points.slice(c+1));this.shape.points[c]=this._applyShapePointConstraints(c,this.shape.points[c],f,g,a)}this.invalidateBaseRectangle()},rotationAngleToJson:function(){var c;if(this._parent&&(this._parent instanceof Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer)){var b=this._parent;var a=b.getCenter();if(b.getRotationAngle()!==0){c=this.getRotationAngle()+b.getRotationAngle()}else{c=this.getRotationAngle()}}else{c=this.getRotationAngle()}return c},rotationAngleFromJson:function(a){this._rotationAngle=a;if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}},strokeStyleToJson:function(){var a=this.getStrokeStyle();if(a!=null){return a.toJson()}else{return null}},strokeStyleFromJson:function(a){if(a!==null){var b=this.getStrokeStyle();if(b==null){b=Webgram.Styles.getStrokeStyle("default")}b.fromJson(a);this.setStrokeStyle(b)}else{this.setStrokeStyle(null)}},fillStyleToJson:function(){var a=this.getFillStyle();if(a!=null){return a.toJson()}else{return null}},fillStyleFromJson:function(b){if(b!==null){var a=this.getFillStyle();if(a==null){a=Webgram.Styles.getFillStyle("default")}a.fromJson(b);this.setFillStyle(a)}else{this.setFillStyle(null)}},textStyleToJson:function(){var a=this.getTextStyle();if(a!=null){return a.toJson()}else{return null}},textStyleFromJson:function(a){if(a!==null){var b=this.getTextStyle();if(b==null){b=Webgram.Styles.getTextStyle("default")}b.fromJson(a);this.setTextStyle(b)}else{this.setTextStyle(null)}},settingsToJson:function(){return{moveEnabled:this._moveEnabled,rotateEnabled:this._rotateEnabled,selectEnabled:this._selectEnabled,snapToAngleEnabled:this._snapToAngleEnabled,snapExternallyEnabled:this._snapExternallyEnabled,snapToGridEnabled:this._snapToGridEnabled}},settingsFromJson:function(a){if(a.moveEnabled!==undefined&&a.moveEnabled!==this._moveEnabled){this.setMoveEnabled(a.moveEnabled)}if(a.rotateEnabled!==undefined&&a.rotateEnabled!==this._rotateEnabled){this.setRotateEnabled(a.rotateEnabled)}if(a.selectEnabled!==undefined&&a.selectEnabled!==this._selectEnabled){this.setSelectEnabled(a.selectEnabled)}if(a.snapToAngleEnabled!==undefined&&a.snapToAngleEnabled!==this._snapToAngleEnabled){this.setSnapToAngleEnabled(a.snapToAngle)}if(a.snapExternallyEnabled!==undefined&&a.snapExternallyEnabled!==this._snapExternallyEnabled){this.setSnapExternallyEnabled(a.snapExternallyEnabled)}if(a.snapToGridEnabled!==undefined&&a.snapToGridEnabled!==this._snapToGridEnabled){this.setSnapToGridEnabledEnabled(a.snapToGridEnabled)}},addJsonField:function(a){this._jsonFields.push(a)},addJsonFuncs:function(a,b,c){this._jsonFuncs.push({name:a,toFunc:b,fromFunc:c})},toJson:function(){var c={id:this.getId(),className:this.constructor.toString(),shape:this.shapeToJson(),rotationAngle:this.rotationAngleToJson(),strokeStyle:this.strokeStyleToJson(),fillStyle:this.fillStyleToJson(),textStyle:this.textStyleToJson()};var a=this._fieldsToJson();for(var b in a){c[b]=a[b]}a=this._funcsToJson();for(var b in a){c[b]=a[b]}return c},fromJson:function(a){if(a.id!==undefined){this.setId(a.id)}if(a.shape!==undefined){this.shapeFromJson(a.shape)}if(a.rotationAngle!==undefined){this.rotationAngleFromJson(a.rotationAngle)}if(a.strokeStyle!==undefined){this.strokeStyleFromJson(a.strokeStyle)}if(a.fillStyle!==undefined){this.fillStyleFromJson(a.fillStyle)}if(a.textStyle!==undefined){this.textStyleFromJson(a.textStyle)}this._fieldsFromJson(a);this._funcsFromJson(a)},_getTransformSet:function(b){var c=this.getBaseRectangle();var a=c.getCenter();if(b){b.addRotation(this.getRotationAngle());b.addTranslation(a.x,a.y);return b}else{b=new Webgram.Canvas.TransformSet();b.addRotation(this.getRotationAngle());b.addTranslation(a.x,a.y);return b}},_setRotatedShapePoint:function(h,m,d){var a=this.getCenter();var l=this.getRotationAngle();var j=[];var g=[];for(var f=0;f<this.shape.points.length;f++){if(f!==h){j.push(this.shape.points[f]);g.push(this.shape.points[f].getRotated(l,a))}}var e=m.getRotated(-l,a);var k=this._snapShapePoint(h,e,j,l,a);e=k.point;e=this._applyShapePointConstraints(h,e,j,l,a);m=e.getRotated(l,a);var b=new Webgram.Geometry.Poly(g.concat(m));b=b.getRotated(-l);var c=b.getBoundingRectangle().getCenter().getRotated(l);j=new Webgram.Geometry.Poly(g).getRotated(-l,c).points;e=m.getRotated(-l,c);j.splice(h,0,e);this.shape=new Webgram.Geometry.Poly(j);this.invalidateBaseRectangle();if(!d){this.setSnapVisualFeedback(k.snapVisualFeedback)}},_snapShapePoint:function(f,o,u,d,r){var g;var h;var t=null,s=null;var q=false,e=false;var b=null,a=null;var n=null;var j=null;if(this.isSnapInternallyEnabled()){g=this.snapInternally(f,o,u,d,r);if(g!=null){if(d!==0){if(g.x!=null){if(g.y!=null){if(g.x instanceof Function){if(g.y instanceof Function){if(g.preferredPoint!=null){t=g.preferredPoint.x;s=g.preferredPoint.y}else{t=o.x;s=o.y}}else{t=g.x(g.y);s=g.y}}else{if(g.y instanceof Function){t=g.x;s=g.y(g.x)}else{t=g.x;s=g.y}}}else{if(g.x instanceof Function){t=g.x(o.y);s=o.y}else{t=g.x;s=o.y}}}else{if(g.y!=null){if(g.y instanceof Function){t=o.x;s=g.y(o.x)}else{t=o.x;s=g.y}}else{t=o.x;s=o.y}}if(g.snapVisualFeedback!=null){if(!(g.snapVisualFeedback instanceof Array)){g.snapVisualFeedback=[g.snapVisualFeedback]}j=[];for(var p=0;p<g.snapVisualFeedback.length;p++){var l=g.snapVisualFeedback[p];snapCenter=new Webgram.Geometry.Point(l.x,l.y);snapCenter=snapCenter.getRotated(d,r);if(l.type==="linear"){j.push({type:"linear",x:snapCenter.x,y:snapCenter.y})}else{j.push({type:"radial",x:snapCenter.x,y:snapCenter.y,angle:l.angle+d})}}}h=new Webgram.Geometry.Point(t,s);return{point:h,snapVisualFeedback:j,xSnapped:q,ySnapped:e}}else{if(g.x!=null){if(g.y!=null){if(g.x instanceof Function){if(g.y instanceof Function){b=g.x;a=g.y;if(g.preferredPoint!=null){n=g.preferredPoint}}else{t=g.x(g.y);s=g.y;e=true}}else{if(g.y instanceof Function){t=g.x;s=g.y(g.x);q=true}else{t=g.x;s=g.y;q=true;e=true}}}else{if(g.x instanceof Function){b=g.x}else{t=g.x;q=true}}}else{if(g.y!=null){if(g.y instanceof Function){a=g.y}else{s=g.y;e=true}}else{}}if(g.snapVisualFeedback!=null){if(!(g.snapVisualFeedback instanceof Array)){g.snapVisualFeedback=[g.snapVisualFeedback]}j=[];h=new Webgram.Geometry.Point(t,s);if(h.x==null){h.x=o.x}if(h.y==null){h.y=o.y}for(var p=0;p<g.snapVisualFeedback.length;p++){var l=g.snapVisualFeedback[p];snapCenter=new Webgram.Geometry.Point(l.x,l.y);snapCenter=snapCenter.getRotated(d,r);if(l.type==="linear"){j.push({type:"linear",x:snapCenter.x,y:snapCenter.y})}else{j.push({type:"radial",x:snapCenter.x,y:snapCenter.y,angle:l.angle+d})}}}}}}o=o.getRotated(d,r);var c=j;if((t==null||s==null)&&this.isSnapExternallyEnabled()){g=this.snapExternally(f,o,u,d,r);if(g!=null){if((g.x!=null&&t==null)||(g.y!=null&&s==null)){j={type:"linear",x:null,y:null};if(g.x!=null&&t==null){t=g.x;j.x=g.x;q=true}if(g.y!=null&&s==null){s=g.y;j.y=g.y;e=true}}}}if(t==null){if(s==null){if(b!=null){if(a!=null){if(n!=null){t=n.x;s=n.y}else{s=a}}else{t=b}}else{if(a!=null){s=a}else{}}}else{if(b!=null){t=b(s)}var m=new Webgram.Geometry.Point(t,s).getDistanceTo(o);var k=this.getSetting("snapDistance",Math.min(this.getWidth(),this.getHeight())/4);if(m>2*k&&n!=null){t=n.x;s=n.y;j=c}}}else{if(s==null){if(a!=null){s=a(t)}var m=new Webgram.Geometry.Point(t,s).getDistanceTo(o);var k=this.getSetting("snapDistance",Math.min(this.getWidth(),this.getHeight())/4);if(m>2*k&&n!=null){t=n.x;s=n.y;j=c}}else{}}if(this.isSnapToGridEnabled()&&(t==null||s==null)){g=this.snapToGrid(o,d,r);if(g!=null){if(g.x!=null&&t==null){t=g.x}if(g.y!=null&&s==null){s=g.y}if(t instanceof Function){t=t(s)}if(s instanceof Function){s=s(t)}}}if(t==null){t=o.x}if(s==null){s=o.y}var h=new Webgram.Geometry.Point(t,s);if(d!==0){h=h.getRotated(-d,r)}return{point:h,snapVisualFeedback:j,xSnapped:q,ySnapped:e}},_snapToSiblings:function(n,m,a){var p=this.getSetting("snapDistance");if(p==null){return}var k=null;var c=Infinity;var h=null;var b=Infinity;for(var f=0;f<this._parent.drawingElements.length;f++){var g=this._parent.drawingElements[f];if(g===this){continue}if(g instanceof Webgram.Connectors.Connector){continue}var l=g.getSnappingPoints();for(var e=0;e<l.length;e++){var d=l[e];var q=d.x-n.x;if(Math.abs(q)<=p&&Math.abs(q)<Math.abs(c)){k=d.x;c=q}var o=d.y-n.y;if(Math.abs(o)<=p&&Math.abs(o)<Math.abs(b)){h=d.y;b=o}}}if(k!=null||h!=null){return new Webgram.Geometry.Point(k,h)}},_applyShapePointConstraints:function(c,b,d,e,a){b=this.applyShapePointConstraints(c,b,d,e,a);return b},_computeBaseRectangle:function(){return this.shape.getBoundingRectangle()},_setRotationAngle:function(e){var d=this.getSetting("snapAngle");var c=this.getSetting("snapAngleThreshold");if(this.isSnapToAngleEnabled()&&d!=null&&this.rotationCenter.x===0&&this.rotationCenter.y===0&&d!=null){var b=Webgram.Utils.getSnappedAngle(e,d,c);if(b!=null){var a=this.getCenter();this.setSnapVisualFeedback({type:"radial",x:a.x,y:a.y,angle:b-Math.PI/2});e=b}}else{e=Webgram.Utils.normalizeAngle(e)}this._rotationAngle=e;if(this._parent!=null){this.saveParentRelativePosition()}this.invalidatePoints();this.invalidate()},_enterContainerElement:function(c,b){if(c.getRotationAngle()!==0){return}if(this._parent){this._parent._remDrawingElement(this,b)}c._addDrawingElement(this,null,b);var a=c.getCenter();this.shape=this.shape.getTranslated(-a.x,-a.y);this.invalidateBaseRectangle();this._focusType=Webgram.DrawingElement.FOCUS_NONE;if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}this.saveParentRelativePosition();this.invalidatePoints()},_leaveContainerElement:function(h){if(!this._parent||!this._parent._parent){return}var f=this._parent;var g=f._parent;f._remDrawingElement(this,h);g._addDrawingElement(this,null,h);var e=f.getCenter();if(f.getRotationAngle()!==0){var b=this.getCenter();var d=b.getRotated(f.getRotationAngle());var c=e.x+d.x-b.x;var a=e.y+d.y-b.y;this.shape=this.shape.getTranslated(c,a);this._rotationAngle+=f.getRotationAngle()}else{this.shape=this.shape.getTranslated(e.x,e.y)}this.invalidateBaseRectangle();this._focusType=Webgram.DrawingElement.FOCUS_NONE;if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}this.saveParentRelativePosition();this.invalidatePoints()},_setGradientProportionalPoints:function(a){if(a==null){return}var b=a.gradientPoint1;if(b!=null){if(a.gradientRadius1!=null){b._radiusPoint1=new Webgram.Geometry.Point(b.x,b.y+a.gradientRadius1);b._radiusPoint2=new Webgram.Geometry.Point(b.x+a.gradientRadius2,b.y);this.addProportionalPoint(b._radiusPoint1,function(c){a.gradientRadius1=b._radiusPoint1.getDistanceTo(b);this.invalidate()});this.addProportionalPoint(b._radiusPoint2,function(c){a.gradientRadius2=b._radiusPoint2.getDistanceTo(b);this.invalidate()});this.addProportionalPoint(b)}else{this.addProportionalPoint(b)}}if(a.gradientPoint2!=null&&a.gradientRadius1==null){this.addProportionalPoint(a.gradientPoint2)}},_setGradientControlPoints:function(b){if(b==null){return}var c=b.gradientPoint1;var a;if(c!=null){a=new Webgram.ControlPoints.GradientControlPoint(b.gradientPoint1,b.gradientPoint2,true,b);c._controlPoint=a;this.addControlPoint(a);if(b.gradientRadius1!=null){c._radiusControlPoint1=new Webgram.ControlPoints.GradientRadiusControlPoint(c._radiusPoint1,c,true,b);c._radiusControlPoint2=new Webgram.ControlPoints.GradientRadiusControlPoint(c._radiusPoint2,c,false,b);this.addControlPoint(c._radiusControlPoint1);this.addControlPoint(c._radiusControlPoint2)}}if(b.gradientPoint2!=null&&b.gradientRadius1==null){a=new Webgram.ControlPoints.GradientControlPoint(b.gradientPoint2,b.gradientPoint1,false,b);b.gradientPoint2._controlPoint=a;this.addControlPoint(a)}b._gradientEditEnabled=true},_clearGradientProportionalPoints:function(a){if(a==null){return}if(a.gradientPoint1!=null){this.remProportionalPoint(a.gradientPoint1);if(a.gradientPoint1._radiusPoint1!=null){this.remProportionalPoint(a.gradientPoint1._radiusPoint1);this.remProportionalPoint(a.gradientPoint1._radiusPoint2)}}if(a.gradientPoint2!=null&&a.gradientRadius1==null){this.remProportionalPoint(a.gradientPoint2)}},_clearGradientControlPoints:function(a){if(a==null||a._gradientEditEnabled==null){return}if(a.gradientPoint1!=null&&a.gradientPoint1._controlPoint!=null){this.remControlPoint(a.gradientPoint1._controlPoint);if(a.gradientPoint1._radiusControlPoint1!=null){this.remControlPoint(a.gradientPoint1._radiusControlPoint1);this.remControlPoint(a.gradientPoint1._radiusControlPoint2);a.gradientPoint1._radiusControlPoint1=null;a.gradientPoint1._radiusControlPoint2=null}}if(a.gradientPoint2!=null&&a.gradientPoint2._controlPoint!=null&&a.gradientRadius1==null){this.remControlPoint(a.gradientPoint2._controlPoint)}delete a._gradientEditEnabled},_flipGradientProportionalPoints:function(b,a){if(b==null){return}if(b.gradientPoint1!=null){if(a){b.gradientPoint1.x=-b.gradientPoint1.x}else{b.gradientPoint1.y=-b.gradientPoint1.y}this.saveProportionalPoint(b.gradientPoint1);if(b.gradientPoint1._radiusPoint1!=null){if(a){b.gradientPoint1._radiusPoint1.x=-b.gradientPoint1._radiusPoint1.x;b.gradientPoint1._radiusPoint2.x=-b.gradientPoint1._radiusPoint2.x}else{b.gradientPoint1._radiusPoint1.y=-b.gradientPoint1._radiusPoint1.y;b.gradientPoint1._radiusPoint2.y=-b.gradientPoint1._radiusPoint2.y}this.saveProportionalPoint(b.gradientPoint1._radiusPoint1);this.saveProportionalPoint(b.gradientPoint1._radiusPoint2)}}if(b.gradientPoint2!=null&&b.gradientRadius1==null){if(a){b.gradientPoint2.x=-b.gradientPoint2.x}else{b.gradientPoint2.y=-b.gradientPoint2.y}this.saveProportionalPoint(b.gradientPoint2)}},_setWebgram:function(a){this.webgram=a;if(this._id==null){this._id=":local:"+a.getNextIdSequence()}},_clearWebgram:function(){this.webgram=null},_triggerAdded:function(){this.webgram.onDrawingElementAdd.trigger(this)},_triggerRemoved:function(){this.webgram.onDrawingElementRemove.trigger(this)},_fieldsToJson:function(){var b={};for(var a=0;a<this._jsonFields.length;a++){var d=this._jsonFields[a];var c=Webgram.Utils.getField(d,undefined,this);Webgram.Utils.setField(d,c,b)}return b},_fieldsFromJson:function(b){for(var a=0;a<this._jsonFields.length;a++){var d=this._jsonFields[a];var c=Webgram.Utils.getField(d,undefined,b);c=Webgram.Utils.clone(c);Webgram.Utils.setField(d,c,this)}},_funcsToJson:function(){var c={};for(var b=0;b<this._jsonFuncs.length;b++){var a=this._jsonFuncs[b];var d=a.toFunc.call(this,a.name);Webgram.Utils.setField(a.name,d,c)}return c},_funcsFromJson:function(c){for(var b=0;b<this._jsonFuncs.length;b++){var a=this._jsonFuncs[b];a.fromFunc.call(this,c[a.name],a.name)}}};Webgram.Class("Webgram.DrawingElement");Webgram.DrawingControl=function(a){this.rootContainer=a;this.onActivate=new Webgram.Event("activate",this);this.onDeactivate=new Webgram.Event("deactivate",this)};Webgram.DrawingControl.prototype={invalidate:function(a){this.rootContainer.webgram.invalidate();if(a){this.rootContainer.webgram.invalidateMini()}},getSetting:function(a,b){if(!this.rootContainer){return null}return this.rootContainer.webgram.getSetting(a,b)},getWebgram:function(){if(this.rootContainer==null){return null}return this.rootContainer.webgram},activate:function(){if(this.rootContainer._activeDrawingControl===this){return}if(this.rootContainer._activeDrawingControl){this.rootContainer._activeDrawingControl.onDeactivate.trigger()}this.rootContainer._prevDrawingControl=this.rootContainer._activeDrawingControl;this.rootContainer._activeDrawingControl=this;this.onActivate.trigger();if(this.rootContainer._lastMousePoint){var a=this.handleMouseMove(this.rootContainer._lastMousePoint,{});if(a!=null){this.rootContainer.webgram.htmlElement.style.cursor=a}}var b=this.getWebgram();if(!b.hasFocus()){b.htmlElement.focus()}},deactivate:function(){if(this.rootContainer._activeDrawingControl!==this){return}this.rootContainer._activeDrawingControl=null;this.onDeactivate.trigger()},activatePrevious:function(){this.deactivate();var a=this.rootContainer._prevDrawingControl;if(a==null){return null}a.activate();return a},keyMatches:function(a,d,c){if(a==null){return false}if(a.indexOf("alt")>=0){if(!c.alt){return false}}else{if(c.alt){return false}}if(a.indexOf("ctrl")>=0){if(!c.ctrl){return false}}else{if(c.ctrl){return false}}if(a.indexOf("shift")>=0){if(!c.shift){return false}}else{if(c.shift){return false}}var b=a.lastIndexOf("-");if(b>=0){if(a.substring(b+1)!=d){return false}}else{if(a!=d){return false}}return true},getSelectedDrawingElements:function(){return[]},setSelectedDrawingElements:function(a){},handleMouseDown:function(a,c,b){},handleMouseUp:function(a,c,b){},handleMouseMove:function(a,b){},handleMouseScroll:function(b,a,c){},handleKeyPress:function(b,a){},handleKeyDown:function(b,a){},handleKeyUp:function(b,a){},handleFocus:function(){},handleBlur:function(){},handleDrawingElementAdd:function(a){},handleDrawingElementRemove:function(a){}};Webgram.Class("Webgram.DrawingControl");Webgram.Namespace("Webgram.ControlPoints");Webgram.ControlPoints.SimpleControlPoint=function(a){this.point=a;Webgram.ControlPoint.call(this)};Webgram.ControlPoints.SimpleControlPoint.prototype={getCursor:function(){return"pointer"},computeAnchor:function(){return this.point},processMove:function(a,b){this.point.x=a.x;this.point.y=a.y}};Webgram.Class("Webgram.ControlPoints.SimpleControlPoint",Webgram.ControlPoint);Webgram.ControlPoints=Webgram.Namespace("Webgram.ControlPoints");Webgram.ControlPoints.ProportionalControlPoint=function(a){this.proportionalPoint=a;Webgram.ControlPoint.call(this)};Webgram.ControlPoints.ProportionalControlPoint.prototype={getCursor:function(){return"pointer"},computeAnchor:function(){return this.drawingElement.transformDirect(this.proportionalPoint)},processMove:function(a,b){a=this.drawingElement.transformInverse(a);this.proportionalPoint.x=a.x;this.proportionalPoint.y=a.y;this.drawingElement.saveProportionalPoint(this.proportionalPoint);if(this.proportionalPoint._onChange!=null){this.proportionalPoint._onChange.call(this.drawingElement,this.proportionalPoint)}}};Webgram.Class("Webgram.ControlPoints.ProportionalControlPoint",Webgram.ControlPoint);Webgram.Namespace("Webgram.ControlPoints");Webgram.ControlPoints.GradientControlPoint=function(b,d,a,c){Webgram.ControlPoints.ProportionalControlPoint.call(this,b);this.radius=9;this.siblingPoint=d;this.isFirst=a;this.style=c;this.setSnapToGridEnabled(true)};Webgram.ControlPoints.GradientControlPoint.prototype={draw:function(){var b=this.proportionalPoint;var d;if(b._radiusPoint1!=null){d=this.getImageStore().get("gradient-point");if(!d){return}this.drawImage(d.content,Webgram.Geometry.Point.zero(),d.size,0);var a=7;this.drawArc(Webgram.Geometry.Point.zero(),a,a,0,2*Math.PI);this.paint(null,Webgram.Styles.createFillStyle({colors:this.style.colors,gradientPoint1:new Webgram.Geometry.Point(0,0),gradientRadius1:0,gradientRadius2:a}));a=15;this.drawLine(new Webgram.Geometry.Point(0,-a),new Webgram.Geometry.Point(0,a));this.paint(this.drawingElement._guidesStyle,null);this.drawLine(new Webgram.Geometry.Point(-a,0),new Webgram.Geometry.Point(a,0));this.paint(this.drawingElement._guidesStyle,null)}else{d=this.getImageStore().get("gradient-point");if(!d){return}this.drawImage(d.content,Webgram.Geometry.Point.zero(),d.size,0);this.drawArc(Webgram.Geometry.Point.zero(),7,7,0,2*Math.PI);var c;if(this.isFirst){c=this.style.colors[0]}else{c=this.style.colors.slice(-1)[0]}this.paint(null,this._fillStyle.replace({colors:c}))}},processMove:function(c,e){Webgram.ControlPoints.ProportionalControlPoint.prototype.processMove.call(this,c,e);var b=this.proportionalPoint;if(b._radiusPoint1!=null){var f=this.drawingElement.transformInverse(this.getAnchor());c=this.drawingElement.transformInverse(c);var d=c.x-f.x;var a=c.y-f.y;b._radiusPoint1.x+=d;b._radiusPoint1.y+=a;this.drawingElement.saveProportionalPoint(b._radiusPoint1);b._radiusPoint2.x+=d;b._radiusPoint2.y+=a;this.drawingElement.saveProportionalPoint(b._radiusPoint2);if(b._radiusControlPoint1!=null){b._radiusControlPoint1.update();b._radiusControlPoint2.update()}}}};Webgram.Class("Webgram.ControlPoints.GradientControlPoint",Webgram.ControlPoints.ProportionalControlPoint);Webgram.ControlPoints.GradientRadiusControlPoint=function(c,b,a,d){Webgram.ControlPoints.ProportionalControlPoint.call(this,c);this.radius=9;this.gradientPoint=b;this.isFirst=a;this.style=d};Webgram.ControlPoints.GradientRadiusControlPoint.prototype={draw:function(){var b=this.getImageStore().get("gradient-point");if(!b){return}this.drawImage(b.content,Webgram.Geometry.Point.zero(),b.size,0);this.drawArc(Webgram.Geometry.Point.zero(),7,7,0,2*Math.PI);var a;if(this.isFirst){a=this.style.colors[0]}else{a=this.style.colors.slice(-1)[0]}this.paint(null,this._fillStyle.replace({colors:a}))},snap:function(b){var a=this.style.gradientPoint1;a=this.drawingElement.transformDirect(a);var d=a.getDistanceTo(b);var c=this.getSetting("snapDistance");if(c==null){return b}if(d<10){return a}else{return b}}};Webgram.Class("Webgram.ControlPoints.GradientRadiusControlPoint",Webgram.ControlPoints.ProportionalControlPoint);Webgram.Namespace("Webgram.ControlPoints");Webgram.ControlPoints.RotateControlPoint=function(){Webgram.ControlPoint.call(this);this.radius=15;this.onBeginMove.bind(function(){this.origin=this.drawingElement.transformDirect(this.drawingElement.rotationCenter);var b=Webgram.Utils.normalizeAngle(this.origin.getAngleTo(this.drawingElement.getCenter()));var a=Webgram.Utils.normalizeAngle(this.origin.getAngleTo(this.getAnchor()));this.angleOffset=b-a+this.drawingElement.getRotationAngle();this.initialDistance=this.origin.getDistanceTo(this.drawingElement.getCenter());this.initialAngleToPoint=a;this.initialRotationAngle=this.drawingElement.getRotationAngle();this.drawingElement.onBeginRotate.trigger()});this.onEndMove.bind(function(){this.drawingElement.onEndRotate.trigger()})};Webgram.ControlPoints.RotateControlPoint.prototype={draw:function(){var a=this.getImageStore().get("rotate");if(!a){return}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0)},getCursor:function(){return"pointer"},computeAnchor:function(){var f=this.drawingElement.getBaseRectangle();var d=f.x1;var c=f.x2;var b=new Webgram.Geometry.Point((c+d)/2,f.y1);var a=0;var e=-this.drawingElement.getHeight()/2;b=this.drawingElement.transformDirect(new Webgram.Geometry.Point(a,e));return b},getOffsets:function(){return{x:0,y:-30}},processMove:function(c,f){var g=this.origin.getAngleTo(f);g=Webgram.Utils.normalizeAngle(g);var e=this.origin.getPointAt(this.initialDistance,g+this.angleOffset-this.initialRotationAngle);var b=this.drawingElement.getCenter();var d=e.x-b.x;var a=e.y-b.y;this.drawingElement.shape=this.drawingElement.shape.getTranslated(d,a);this.drawingElement.invalidateBaseRectangle();this.drawingElement.saveParentRelativePosition();var h=g-this.initialAngleToPoint+this.initialRotationAngle;this.drawingElement._setRotationAngle(h);this.drawingElement.onRotate.trigger(h)}};Webgram.Class("Webgram.ControlPoints.RotateControlPoint",Webgram.ControlPoint);Webgram.ControlPoints.RotationCenterControlPoint=function(){Webgram.ControlPoint.call(this);this.setSnapToGridEnabled(true);this.radius=12;this._computedAnchor=null};Webgram.ControlPoints.RotationCenterControlPoint.prototype={draw:function(){var a=this.getImageStore().get("rotation-center");if(!a){return}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0)},getCursor:function(){return"pointer"},snap:function(a){a=Webgram.ControlPoint.prototype.snap.call(this,a);a=this._snapToCenter(a);return a},computeAnchor:function(){if(!this._computedAnchor){this._computedAnchor=this.drawingElement.transformDirect(this.drawingElement.rotationCenter)}return this._computedAnchor},processMove:function(a,b){a=this.drawingElement.transformInverse(a);this.drawingElement.rotationCenter.x=a.x;this.drawingElement.rotationCenter.y=a.y;this._computedAnchor=null},reset:function(){this.drawingElement.rotationCenter.x=0;this.drawingElement.rotationCenter.y=0;this._computedAnchor=null},_snapToCenter:function(b){var a=this.drawingElement.getCenter();if(a.getDistanceTo(b)<=2*this.radius){return a}return b}};Webgram.Class("Webgram.ControlPoints.RotationCenterControlPoint",Webgram.ControlPoint);Webgram.DrawingElements=Webgram.Namespace("Webgram.DrawingElements");Webgram.DrawingElements.SimpleElement=function(b,a){if(a==null){a=Webgram.Geometry.Point.zero()}Webgram.DrawingElement.call(this,b,a)};Webgram.DrawingElements.SimpleElement.prototype={getDecorationRectangle:function(){return new Webgram.Geometry.Poly(this.getPoints()).getBoundingRectangle()},getBoundingRectangle:function(){return this.transformDirect(new Webgram.Geometry.Poly(this.getPoints())).getBoundingRectangle()},getWidth:function(){return new Webgram.Geometry.Poly(this.getPoints()).getBoundingRectangle().getWidth()},getHeight:function(){return new Webgram.Geometry.Poly(this.getPoints()).getBoundingRectangle().getHeight()},getSnappingPoints:function(){var a=new Webgram.Geometry.Poly(this.getPoints().concat(Webgram.Geometry.Point.zero()));return this.transformDirect(a).points},pointInside:function(a){return this.transformDirect(new Webgram.Geometry.Poly(this.getPoints())).pointInside(a)},beginCreate:function(a){this.setCenter(a);return true},continueCreate:function(b,c,a,d){return false},endCreate:function(){return true},shapeToJson:function(){var a=this.getCenter();return{x:a.x,y:a.y}},shapeFromJson:function(b){var a=new Webgram.Geometry.Point(b.x,b.y);this.setCenter(a);this.invalidateBaseRectangle()},setCenter:function(a){this.setRotatedShapePoint(0,a);if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}},getCenter:function(){return this.shape.points[0]},getPoints:function(){return[Webgram.Geometry.Point.zero()]}};Webgram.Class("Webgram.DrawingElements.SimpleElement",Webgram.DrawingElement);Webgram.Namespace("Webgram.DrawingElements");Webgram.DrawingElements.RectangularElement=function(f,b,e,d,a){this._minSize=new Webgram.Geometry.Size(1,1);if(b==null){b=0;e=0;d=this._minSize.width;a=this._minSize.height}var c=[new Webgram.Geometry.Point(b,e),new Webgram.Geometry.Point(b+d-1,e+a-1)];Webgram.DrawingElement.call(this,f,c);this._aspectRatio=null;this._keepSquareEnabled=false;this.setResizeEnabled(true);this.onResize=new Webgram.Event("resize",this);this.onResize.bind(function(){if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}})};Webgram.DrawingElements.RectangularElement.TOP_LEFT=0;Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT=1;Webgram.DrawingElements.RectangularElement.TOP_RIGHT=2;Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT=3;Webgram.DrawingElements.RectangularElement.prototype={setTop:function(a){this._setTop(a,true);this.triggerShapeChange()},setRight:function(a){this._setRight(a,true);this.triggerShapeChange()},setBottom:function(a){this._setBottom(a,true);this.triggerShapeChange()},setLeft:function(a){this._setLeft(a,true);this.triggerShapeChange()},setTopLeft:function(a){this._setTopLeft(a,true);this.triggerShapeChange()},setBottomRight:function(a){this._setBottomRight(a,true);this.triggerShapeChange()},setTopRight:function(a){this._setTopRight(a,true);this.triggerShapeChange()},setBottomLeft:function(a){this._setBottomLeft(a,true);this.triggerShapeChange()},setWidth:function(a){this._setWidth(a,true);this.triggerShapeChange()},setHeight:function(a){this._setHeight(a,true);this.triggerShapeChange()},getBoundingRectangle:function(){var a=this._getFourPointsShape();return a.getRotated(this.getRotationAngle(),this.getCenter()).getBoundingRectangle()},getSnappingPoints:function(){var a=Webgram.Utils.clone(this.rotateDirect(this._getFourPointsShape()).points);a.push(this.getCenter());return a},flipShapeHorizontally:function(){},flipShapeVertically:function(){},restoreParentRelativePosition:function(){if(!this.isResizeEnabled()){return}var k=this._parent.getWidth();var e=this._parent.getHeight();var i=new Webgram.Geometry.Point(this._parentRelativePositions[Webgram.DrawingElements.RectangularElement.TOP_LEFT].x*(k-1),this._parentRelativePositions[Webgram.DrawingElements.RectangularElement.TOP_LEFT].y*(e-1));var f=new Webgram.Geometry.Point(this._parentRelativePositions[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].x*(k-1),this._parentRelativePositions[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].y*(e-1));var c=i.getCenterTo(f);i=i.getRotated(-this.getRotationAngle(),c);f=f.getRotated(-this.getRotationAngle(),c);var b=f.x-i.x+1;var l=f.y-i.y+1;var j=this._applySizeConstraints(new Webgram.Geometry.Size(b,l));b=j.width;l=j.height;if(this.isKeepSquareEnabled()){if(l<b){b=l}else{l=b}}else{if(this.getAspectRatio()!=null){if(this.getAspectRatio()*l<b){b=l*this.getAspectRatio()}else{l=b/this.getAspectRatio()}}}var d=c.x-b/2;var g=c.y-l/2;var h=c.x+b/2;var a=c.y+l/2;this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=new Webgram.Geometry.Point(d,g);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=new Webgram.Geometry.Point(h,a);this.invalidateBaseRectangle()},getMinSize:function(){return this._minSize},setMinSize:function(b){this._minSize=b;var c=this.rotateDirect(this.shape);var a=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];this._setBottomRight(a);this.setSnapVisualFeedback(null)},isKeepAspectRatioEnabled:function(){return this._aspectRatio!=null},getAspectRatio:function(){return this._aspectRatio},setKeepAspectRatioEnabled:function(a,d){if(a){if(this._aspectRatio==null||d!=null){if(d!=null){this._aspectRatio=d}else{this._aspectRatio=this.getWidth()/this.getHeight()}var c=this.rotateDirect(this.shape);var b=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];this._setBottomRight(b)}}else{this._aspectRatio=null}},isKeepSquareEnabled:function(){return this._keepSquareEnabled},setKeepSquareEnabled:function(a){this._keepSquareEnabled=a;if(a){var c=this.rotateDirect(this.shape);var b=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];this._setBottomRight(b)}},isResizeEnabled:function(){return this._resizeEnabled},setResizeEnabled:function(a){if(a){if(this._resizeEnabled){return}this._resizeEnabled=true;this._enableResizeControlPoints()}else{if(!this._resizeEnabled){return}this._disableResizeControlPoints();this._resizeEnabled=false}},beginCreate:function(a){this.moveTo(a);return true},continueCreate:function(b,c,a,d){if(a){if(c.width>0){if(c.height>0){this._setBottomRight(b)}else{this._setTopRight(b)}}else{if(c.height>0){this._setBottomLeft(b)}else{this._setTopLeft(b)}}return true}else{return false}},endCreate:function(){return true},settingsToJson:function(){var a=Webgram.DrawingElement.prototype.settingsToJson();var b=this.getMinSize();a.minSize={x:b.x,y:b.y};a.keepAspectRatioEnabled=this.getAspectRatio()!=null;a.keepSquareEnabled=this.isKeepSquareEnabled();a.resizeEnabled=this.isResizeEnabled();return a},settingsFromJson:function(a){Webgram.DrawingElement.prototype.settingsFromJson(a);if(a.keepAspectRatioEnabled!==undefined){this.setKeepAspectRatioEnabled(a.keepAspectRatio)}if(a.keepSquareEnabled!==undefined&&a.keepSquareEnabled!==this._keepSquareEnabled){this.setKeepSquareEnabled(a.keepSquareEnabled)}if(a.resizeEnabled!==undefined&&a.resizeEnabled!==this._resizeEnabled){this.setResizeEnabled(a.resizeEnabled)}},_setTop:function(n,d){var c=this._getFourPointsShape();var v=this.rotateDirect(c);var g=this.getRotationAngle();var q=this.shape.getCenter();var t=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var l=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];var u=t.getCenterTo(l);var p=n.getRotated(-g,q);var b=c.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];b.y=p.y;var j=null;if(Webgram.Utils.angleMultipleOf(g,Math.PI/2)){j=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.TOP_LEFT,b,[l],g,q);b=j.point;if(Webgram.Utils.angleMultipleOf(g,Math.PI)){if(j.ySnapped&&!d){j.snapVisualFeedback.x=null;this.setSnapVisualFeedback(j.snapVisualFeedback)}}else{if(j.xSnapped&&!d){j.snapVisualFeedback.y=null;this.setSnapVisualFeedback(j.snapVisualFeedback)}}}p.y=b.y;var m=l.x-t.x+1;var w=this._applyTopConstraints(p,u,m);p=w.nrTop;m=w.width;var k=p.getRotated(g,q);var o=v.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var i=v.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];var h=o.getCenterTo(i);var a=k.getCenterTo(h);p=k.getRotated(-this.getRotationAngle(),a);u=h.getRotated(-this.getRotationAngle(),a);var s=a.x-m/2+0.5;var f=p.y;var r=a.x+m/2-0.5;var e=u.y;this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=new Webgram.Geometry.Point(s,f);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=new Webgram.Geometry.Point(r,e);this.invalidateBaseRectangle();this.onResize.trigger()},_setRight:function(o,e){var d=this._getFourPointsShape();var v=this.rotateDirect(d);var i=this.getRotationAngle();var q=this.shape.getCenter();var c=d.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var t=d.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var j=c.getCenterTo(t);var b=o.getRotated(-i,q);var m=d.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];m.x=b.x;var k=null;if(Webgram.Utils.angleMultipleOf(i,Math.PI/2)){k=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT,m,[c],i,q);m=k.point;if(Webgram.Utils.angleMultipleOf(i,Math.PI)){if(k.xSnapped&&!e){k.snapVisualFeedback.y=null;this.setSnapVisualFeedback(k.snapVisualFeedback)}}else{if(k.ySnapped&&!e){k.snapVisualFeedback.x=null;this.setSnapVisualFeedback(k.snapVisualFeedback)}}}b.x=m.x;var l=t.y-c.y+1;var w=this._applyRightConstraints(b,j,l);b=w.nrRight;l=w.height;var u=b.getRotated(i,q);var n=v.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var p=v.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var h=n.getCenterTo(p);var a=h.getCenterTo(u);j=h.getRotated(-this.getRotationAngle(),a);b=u.getRotated(-this.getRotationAngle(),a);var s=j.x;var g=a.y-l/2+0.5;var r=b.x;var f=a.y+l/2-0.5;this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=new Webgram.Geometry.Point(s,g);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=new Webgram.Geometry.Point(r,f);this.invalidateBaseRectangle();this.onResize.trigger()},_setBottom:function(p,d){var c=this._getFourPointsShape();var v=this.rotateDirect(c);var g=this.getRotationAngle();var r=this.shape.getCenter();var b=c.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var j=c.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var q=b.getCenterTo(j);var u=p.getRotated(-g,r);var l=c.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];l.y=u.y;var i=null;if(Webgram.Utils.angleMultipleOf(g,Math.PI/2)){i=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT,l,[b],g,r);l=i.point;if(Webgram.Utils.angleMultipleOf(g,Math.PI)){if(i.ySnapped&&!d){i.snapVisualFeedback.x=null;this.setSnapVisualFeedback(i.snapVisualFeedback)}}else{if(i.xSnapped&&!d){i.snapVisualFeedback.y=null;this.setSnapVisualFeedback(i.snapVisualFeedback)}}}u.y=l.y;var n=j.x-b.x+1;var w=this._applyBottomConstraints(u,q,n);u=w.nrBottom;n=w.width;var h=u.getRotated(g,r);var o=v.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var m=v.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var k=o.getCenterTo(m);var a=k.getCenterTo(h);q=k.getRotated(-this.getRotationAngle(),a);u=h.getRotated(-this.getRotationAngle(),a);var t=a.x-n/2+0.5;var f=q.y;var s=a.x+n/2-0.5;var e=u.y;this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=new Webgram.Geometry.Point(t,f);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=new Webgram.Geometry.Point(s,e);this.invalidateBaseRectangle();this.onResize.trigger()},_setLeft:function(q,e){var d=this._getFourPointsShape();var v=this.rotateDirect(d);var i=this.getRotationAngle();var r=this.shape.getCenter();var m=d.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var o=d.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];var b=m.getCenterTo(o);var j=q.getRotated(-i,r);var c=d.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];c.x=j.x;var l=null;if(Webgram.Utils.angleMultipleOf(i,Math.PI/2)){l=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.TOP_LEFT,c,[o],i,r);c=l.point;if(Webgram.Utils.angleMultipleOf(i,Math.PI)){if(l.xSnapped&&!e){l.snapVisualFeedback.y=null;this.setSnapVisualFeedback(l.snapVisualFeedback)}}else{if(l.ySnapped&&!e){l.snapVisualFeedback.x=null;this.setSnapVisualFeedback(l.snapVisualFeedback)}}}j.x=c.x;var n=o.y-m.y+1;var w=this._applyLeftConstraints(j,b,n);j=w.nrLeft;n=w.height;var h=j.getRotated(i,r);var p=v.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var k=v.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];var u=p.getCenterTo(k);var a=h.getCenterTo(u);j=h.getRotated(-this.getRotationAngle(),a);b=u.getRotated(-this.getRotationAngle(),a);var t=j.x;var g=a.y-n/2+0.5;var s=b.x;var f=a.y+n/2-0.5;this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=new Webgram.Geometry.Point(t,g);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=new Webgram.Geometry.Point(s,f);this.invalidateBaseRectangle();this.onResize.trigger()},_setTopLeft:function(b,a){this._setRotatedShapePoint(Webgram.DrawingElements.RectangularElement.TOP_LEFT,b,a);this.onResize.trigger()},_setBottomRight:function(b,a){this._setRotatedShapePoint(Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT,b,a);this.onResize.trigger()},_setTopRight:function(p,d){var h=this._getFourPointsShape();var f=this.rotateDirect(h);var m=this.getRotationAngle();var a=this.shape.getCenter();var q=h.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var k=p.getRotated(-m,a);var l=h.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var j=h.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];l.y=k.y;j.x=k.x;var n=null,c=null;var g=false,o=false;if(Webgram.Utils.angleMultipleOf(m,Math.PI/2)){n=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.TOP_LEFT,l,[j],m,a);l=n.point;c=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT,j,[l],m,a);j=c.point;if(!d){if(Webgram.Utils.angleMultipleOf(m,Math.PI)){g=n.ySnapped;o=c.xSnapped;if(g){if(o){n.snapVisualFeedback.x=c.snapVisualFeedback.x;this.setSnapVisualFeedback(n.snapVisualFeedback)}else{n.snapVisualFeedback.x=null;this.setSnapVisualFeedback(n.snapVisualFeedback)}}else{if(o){c.snapVisualFeedback.y=null;this.setSnapVisualFeedback(c.snapVisualFeedback)}else{}}}else{g=n.xSnapped;o=c.ySnapped;if(g){if(o){n.snapVisualFeedback.y=c.snapVisualFeedback.y;this.setSnapVisualFeedback(n.snapVisualFeedback)}else{n.snapVisualFeedback.y=null;this.setSnapVisualFeedback(n.snapVisualFeedback)}}else{if(o){c.snapVisualFeedback.x=null;this.setSnapVisualFeedback(c.snapVisualFeedback)}else{}}}}}k.y=l.y;k.x=j.x;k=this._applyTopRightConstraints(k,q);var e=k.getRotated(m,a);var i=f.points[Webgram.DrawingElements.RectangularElement.BOTTOM_LEFT];var b=i.getCenterTo(e);k=e.getRotated(-m,b);q=i.getRotated(-m,b);l=new Webgram.Geometry.Point(q.x,k.y);j=new Webgram.Geometry.Point(k.x,q.y);this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=l;this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=j;this.invalidateBaseRectangle();this.onResize.trigger()},_setBottomLeft:function(n,d){var g=this._getFourPointsShape();var f=this.rotateDirect(g);var l=this.getRotationAngle();var a=this.shape.getCenter();var j=g.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var o=n.getRotated(-l,a);var k=g.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var i=g.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];k.x=o.x;i.y=o.y;var m=null,c=null;if(Webgram.Utils.angleMultipleOf(l,Math.PI/2)){m=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.TOP_LEFT,k,[i],l,a);k=m.point;c=this._snapShapePoint(Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT,i,[k],l,a);i=c.point;if(!d){if(Webgram.Utils.angleMultipleOf(l,Math.PI)){leftSnapped=m.xSnapped;bottomSnapped=c.ySnapped;if(leftSnapped){if(bottomSnapped){m.snapVisualFeedback.y=c.snapVisualFeedback.y;this.setSnapVisualFeedback(m.snapVisualFeedback)}else{m.snapVisualFeedback.y=null;this.setSnapVisualFeedback(m.snapVisualFeedback)}}else{if(bottomSnapped){c.snapVisualFeedback.x=null;this.setSnapVisualFeedback(c.snapVisualFeedback)}else{}}}else{leftSnapped=m.ySnapped;bottomSnapped=c.xSnapped;if(leftSnapped){if(bottomSnapped){m.snapVisualFeedback.x=c.snapVisualFeedback.x;this.setSnapVisualFeedback(m.snapVisualFeedback)}else{m.snapVisualFeedback.x=null;this.setSnapVisualFeedback(m.snapVisualFeedback)}}else{if(leftSnapped){c.snapVisualFeedback.y=null;this.setSnapVisualFeedback(c.snapVisualFeedback)}else{}}}}}o.x=k.x;o.y=i.y;o=this._applyBottomLeftConstraints(o,j);var h=o.getRotated(l,a);var e=f.points[Webgram.DrawingElements.RectangularElement.TOP_RIGHT];var b=e.getCenterTo(h);o=h.getRotated(-l,b);j=e.getRotated(-l,b);k=new Webgram.Geometry.Point(o.x,j.y);i=new Webgram.Geometry.Point(j.x,o.y);this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT]=k;this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=i;this.invalidateBaseRectangle();this.onResize.trigger()},_setWidth:function(c,a){var f=this.getMinSize();c=Math.max(c,f.width);var h=this.getCenter();var g=this.getRotationAngle();var d=this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var e=this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];e.x=d.x+c-1;if(this.isKeepSquareEnabled()){e.y=d.y+c-1}else{if(this.isKeepAspectRatioEnabled()){e.y=d.y+c/this.getAspectRatio()-1}}var b=this._snapShapePoint(1,e,[d],g,h);e=b.point;e=this._applyShapePointConstraints(1,e,[d],g,h);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=e;this.invalidateBaseRectangle();if(!a){this.setSnapVisualFeedback(b.snapVisualFeedback)}this.onResize.trigger()},_setHeight:function(b,a){var f=this.getMinSize();b=Math.max(b,f.height);var h=this.getCenter();var g=this.getRotationAngle();var d=this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT];var e=this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT];e.y=d.y+b-1;if(this.isKeepSquareEnabled()){e.x=d.x+b-1}else{if(this.isKeepAspectRatioEnabled()){e.x=d.x+b*this.getAspectRatio()-1}}var c=this._snapShapePoint(1,e,[d],g,h);e=c.point;e=this._applyShapePointConstraints(1,e,[d],g,h);this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT]=e;this.invalidateBaseRectangle();if(!a){this.setSnapVisualFeedback(c.snapVisualFeedback)}this.onResize.trigger()},_applyShapePointConstraints:function(c,b,d,e,a){b=Webgram.DrawingElement.prototype._applyShapePointConstraints.call(this,c,b,d,e,a);b=this.applyShapePointConstraints(c,b,d,e,a);switch(c){case Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT:b=this._applyBottomRightConstraints(b,d[0]);break;case Webgram.DrawingElements.RectangularElement.TOP_LEFT:b=this._applyTopLeftConstraints(b,d[0]);break}return b},_applyTopConstraints:function(b,e,d){var a=e.y-b.y+1;var c=this._applySizeConstraints(new Webgram.Geometry.Size(d,a),false);return{nrTop:new Webgram.Geometry.Point(e.x,e.y-c.height+1),width:c.width}},_applyRightConstraints:function(b,e,a){var d=b.x-e.x+1;var c=this._applySizeConstraints(new Webgram.Geometry.Size(d,a),true);return{nrRight:new Webgram.Geometry.Point(e.x+c.width-1,e.y),height:c.height}},_applyBottomConstraints:function(e,b,d){var a=e.y-b.y+1;var c=this._applySizeConstraints(new Webgram.Geometry.Size(d,a),false);return{nrBottom:new Webgram.Geometry.Point(b.x,b.y+c.height-1),width:c.width}},_applyLeftConstraints:function(e,b,a){var d=b.x-e.x+1;var c=this._applySizeConstraints(new Webgram.Geometry.Size(d,a),true);return{nrLeft:new Webgram.Geometry.Point(b.x-c.width+1,b.y),height:c.height}},_applyTopLeftConstraints:function(d,e){var c=e.x-d.x+1;var a=e.y-d.y+1;var b=this._applySizeConstraints(new Webgram.Geometry.Size(c,a));return new Webgram.Geometry.Point(e.x-b.width+1,e.y-b.height+1)},_applyBottomRightConstraints:function(e,d){var c=e.x-d.x+1;var a=e.y-d.y+1;var b=this._applySizeConstraints(new Webgram.Geometry.Size(c,a));return new Webgram.Geometry.Point(d.x+b.width-1,d.y+b.height-1)},_applyTopRightConstraints:function(e,d){var c=e.x-d.x+1;var a=d.y-e.y+1;var b=this._applySizeConstraints(new Webgram.Geometry.Size(c,a));return new Webgram.Geometry.Point(d.x+b.width-1,d.y-b.height+1)},_applyBottomLeftConstraints:function(d,e){var c=e.x-d.x+1;var a=d.y-e.y+1;var b=this._applySizeConstraints(new Webgram.Geometry.Size(c,a));return new Webgram.Geometry.Point(e.x-b.width+1,e.y+b.height-1)},_applySizeConstraints:function(b,h){if(h==null){var g=this._applySizeConstraints(b,true);var f=this._applySizeConstraints(b,false);if(f.width+f.height>g.width+g.height){return g}else{return f}}var e=this.getMinSize();var d=this.getAspectRatio();var c=b.width;var a=b.height;if(this.isKeepSquareEnabled()){d=1}if(d!=null){if(h){a=c/d}else{c=a*d}if(c<e.width){c=e.width;a=c/d}if(a<e.height){a=e.height;c=a*d}}else{if(c<e.width){c=e.width}if(a<e.height){a=e.height}}return new Webgram.Geometry.Size(c,a)},_computeBaseRectangle:function(){return new Webgram.Geometry.Rectangle(this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT].x,this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT].y,this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].x,this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].y)},_getFourPointsShape:function(){return new Webgram.Geometry.Poly([this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT],this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT],new Webgram.Geometry.Point(this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].x,this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT].y),new Webgram.Geometry.Point(this.shape.points[Webgram.DrawingElements.RectangularElement.TOP_LEFT].x,this.shape.points[Webgram.DrawingElements.RectangularElement.BOTTOM_RIGHT].y)])},_enableResizeControlPoints:function(){if(!this.isResizeEnabled()){return}if(this.resizeTopLeftControlPoint!=null){return}this.resizeTopLeftControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeTopLeftControlPoint();this.resizeTopControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeTopControlPoint();this.resizeTopRightControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeTopRightControlPoint();this.resizeRightControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeRightControlPoint();this.resizeBottomRightControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeBottomRightControlPoint();this.resizeBottomControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeBottomControlPoint();this.resizeBottomLeftControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeBottomLeftControlPoint();this.resizeLeftControlPoint=new Webgram.DrawingElements.RectangularElement.ResizeLeftControlPoint();this.addControlPoint(this.resizeTopLeftControlPoint);this.addControlPoint(this.resizeTopControlPoint);this.addControlPoint(this.resizeTopRightControlPoint);this.addControlPoint(this.resizeRightControlPoint);this.addControlPoint(this.resizeBottomRightControlPoint);this.addControlPoint(this.resizeBottomControlPoint);this.addControlPoint(this.resizeBottomLeftControlPoint);this.addControlPoint(this.resizeLeftControlPoint)},_disableResizeControlPoints:function(){if(this.resizeTopLeftControlPoint==null){return}this.remControlPoint(this.resizeTopLeftControlPoint);this.remControlPoint(this.resizeTopControlPoint);this.remControlPoint(this.resizeTopRightControlPoint);this.remControlPoint(this.resizeRightControlPoint);this.remControlPoint(this.resizeBottomRightControlPoint);this.remControlPoint(this.resizeBottomControlPoint);this.remControlPoint(this.resizeBottomLeftControlPoint);this.remControlPoint(this.resizeLeftControlPoint);this.resizeTopLeftControlPoint=null;this.resizeTopControlPoint=null;this.resizeTopRightControlPoint=null;this.resizeRightControlPoint=null;this.resizeBottomRightControlPoint=null;this.resizeBottomControlPoint=null;this.resizeBottomLeftControlPoint=null;this.resizeLeftControlPoint=null}};Webgram.Class("Webgram.DrawingElements.RectangularElement",Webgram.DrawingElement);Webgram.DrawingElements.RectangularElement.ResizeControlPoint=function(){Webgram.ControlPoint.call(this);this.imageName=null;this.radius=9.5};Webgram.DrawingElements.RectangularElement.ResizeControlPoint.prototype={draw:function(){var a=this.getImageStore().get(this.imageName);if(!a){return}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0)},getOffsets:function(){var a=this.drawingElement.getDecorationOffset();return{x:this.offsetX*a,y:this.offsetY*a}}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeControlPoint",Webgram.ControlPoint);Webgram.DrawingElements.RectangularElement.ResizeTopLeftControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=-1;this.offsetY=-1;this.imageName="resize-top-left"};Webgram.DrawingElements.RectangularElement.ResizeTopLeftControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()-3*Math.PI/4)},computeAnchor:function(){return this.drawingElement.getBounds().topLeft},processMove:function(a,b){this.drawingElement._setTopLeft(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeTopLeftControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeTopRightControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=1;this.offsetY=-1;this.imageName="resize-top-right"};Webgram.DrawingElements.RectangularElement.ResizeTopRightControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()-Math.PI/4)},computeAnchor:function(){return this.drawingElement.getBounds().topRight},processMove:function(a,b){this.drawingElement._setTopRight(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeTopRightControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeBottomLeftControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=-1;this.offsetY=1;this.imageName="resize-bottom-left"};Webgram.DrawingElements.RectangularElement.ResizeBottomLeftControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()+3*Math.PI/4)},computeAnchor:function(){return this.drawingElement.getBounds().bottomLeft},processMove:function(a,b){this.drawingElement._setBottomLeft(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeBottomLeftControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeBottomRightControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=1;this.offsetY=1;this.imageName="resize-bottom-right"};Webgram.DrawingElements.RectangularElement.ResizeBottomRightControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()+Math.PI/4)},computeAnchor:function(){return this.drawingElement.getBounds().bottomRight},processMove:function(a,b){this.drawingElement._setBottomRight(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeBottomRightControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeTopControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=0;this.offsetY=-1;this.imageName="resize-top"};Webgram.DrawingElements.RectangularElement.ResizeTopControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()-Math.PI/2)},computeAnchor:function(){return this.drawingElement.getBounds().top},processMove:function(a,b){this.drawingElement._setTop(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeTopControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeBottomControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=0;this.offsetY=1;this.imageName="resize-bottom"};Webgram.DrawingElements.RectangularElement.ResizeBottomControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()+Math.PI/2)},computeAnchor:function(){return this.drawingElement.getBounds().bottom},processMove:function(a,b){this.drawingElement._setBottom(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeBottomControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeLeftControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=-1;this.offsetY=0;this.imageName="resize-left"};Webgram.DrawingElements.RectangularElement.ResizeLeftControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle()+Math.PI)},computeAnchor:function(){return this.drawingElement.getBounds().left},processMove:function(a,b){this.drawingElement._setLeft(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeLeftControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.DrawingElements.RectangularElement.ResizeRightControlPoint=function(){Webgram.DrawingElements.RectangularElement.ResizeControlPoint.call(this);this.offsetX=1;this.offsetY=0;this.imageName="resize-right"};Webgram.DrawingElements.RectangularElement.ResizeRightControlPoint.prototype={getCursor:function(){return Webgram.Utils.getCursorByAngle(this.drawingElement.getRotationAngle())},computeAnchor:function(){return this.drawingElement.getBounds().right},processMove:function(a,b){this.drawingElement._setRight(a)}};Webgram.Class("Webgram.DrawingElements.RectangularElement.ResizeRightControlPoint",Webgram.DrawingElements.RectangularElement.ResizeControlPoint);Webgram.Namespace("Webgram.DrawingElements");Webgram.DrawingElements.ContainerElement=function(e,b,d,c,a){this.drawingElements=[];Webgram.DrawingElements.RectangularElement.call(this,e,b,d,c,a)};Webgram.DrawingElements.ContainerElement.prototype={setFocusType:function(c){if(c<Webgram.DrawingElement.FOCUS_SELECTED){for(var b=0;b<this.drawingElements.length;b++){var a=this.drawingElements[b];a.setFocusType(Webgram.DrawingElement.FOCUS_NONE)}}Webgram.DrawingElement.prototype.setFocusType.call(this,c)},draw:function(){this.drawSelf();this.drawElements()},drawSelf:function(){},drawDecoration:function(){this.drawRect(this.getDrawingRectangle());this.paint(undefined,null)},drawElements:function(){var a,b;for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];a.draw();this.webgram.rootContainer._noZoom=true;a.drawNoZoom();this.webgram.rootContainer._noZoom=false}for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];a.drawTop();this.webgram.rootContainer._noZoom=true;a.drawNoZoomTop();this.webgram.rootContainer._noZoom=false}for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];this.webgram.rootContainer._noZoom=true;a.drawActionMenuItems();a.drawControlPoints();a.drawSockets();this.webgram.rootContainer._noZoom=false}},drawImage:function(e,a,b,f,d,c){if(c){this._parent.drawImage(e,a,b,f,d,this._getTransformSet(c))}else{Webgram.DrawingElement.prototype.drawImage.call(this,e,a,b,f,d)}},drawText:function(d,a,c,b){if(a==null){a=this.getBaseRectangle()}if(c===undefined){c=this.getTextStyle()}if(b){this._parent.drawText(d,a,c,this._getTransformSet(b))}else{Webgram.DrawingElement.prototype.drawText.call(this,d,a,c)}},paint:function(c,a,b){if(c===undefined){c=this.getStrokeStyle()}if(a===undefined){a=this.getFillStyle()}if(b){this._parent.paint(c,a,this._getTransformSet(b))}else{Webgram.DrawingElement.prototype.paint.call(this,c,a)}},triggerShapeChange:function(b){Webgram.DrawingElement.prototype.triggerShapeChange.call(this,b);for(var a=0;a<this.drawingElements.length;a++){this.drawingElements[a].triggerShapeChange(b)}},setRotatedShapePoint:function(c,a){Webgram.DrawingElements.RectangularElement.prototype.setRotatedShapePoint.call(this,c,a);for(var d=0;d<this.drawingElements.length;d++){var b=this.drawingElements[d];b.restoreParentRelativePosition()}},updatePoints:function(){Webgram.DrawingElement.prototype.updatePoints.call(this);for(var b=0;b<this.drawingElements.length;b++){var a=this.drawingElements[b];if(a._updatePoints){a.updatePoints();a._updatePoints=false}}},addDrawingElement:function(b,a){this._addDrawingElement(b,a,true)},remDrawingElement:function(a){this._remDrawingElement(a,true)},getDrawingElementIndex:function(a){for(var b=0;b<this.drawingElements.length;b++){if(this.drawingElements[b]===a){return b}}return -1},setDrawingElementIndex:function(b,a){this._setDrawingElementIndex(b,a,true)},getDrawingElements:function(){return this.drawingElements.slice(0)},getMargins:function(){var a=Infinity;var g=Infinity;var f=-Infinity;var e=-Infinity;var d;for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];d=b.getBoundingRectangle();if(d.x1<a){a=d.x1}if(d.x2>f){f=d.x2}if(d.y1<g){g=d.y1}if(d.y2>e){e=d.y2}}if(a===Infinity){d=this.getBoundingRectangle();a=d.x1;g=d.y1;f=d.x2;e=d.y2}return new Webgram.Geometry.Rectangle(a,g,f,e)},_addDrawingElement:function(e,d,g){if(e._parent){return null}e._parent=this;e.saveParentRelativePosition();var j=(d instanceof Webgram.DrawingElement)?d:null;var a=(typeof d==="number")?d:this.drawingElements.length;var c,f=0,b=this.drawingElements.length,h=null;for(c=0;c<this.drawingElements.length;c++){if(this.drawingElements[c].zIndex>=e.zIndex){break}}f=c;while((c<this.drawingElements.length)&&(this.drawingElements[c].zIndex===e.zIndex)){if(this.drawingElements[c]===j){h=c+1;break}c++}b=c;if(h==null){if(a<f){h=f}else{if(a>b){h=b}else{h=a}}}this.drawingElements.splice(h,0,e);if(g){e.onAdd.trigger(this);for(c=h+1;c<this.drawingElements.length;c++){this.drawingElements[c].onIndexChange.trigger(c);this.webgram.onDrawingElementIndexChange.trigger(this.drawingElements[c],c)}}if(this.webgram){e._setWebgram(this.webgram);if(g){e._triggerAdded()}}this.invalidate(true)},_remDrawingElement:function(c,f){c._parent=null;var b=this.getDrawingElementIndex(c);if(b===-1){return}var e;var g=c.getControlPoints(Webgram.Connectors.EndPoint);for(e=0;e<g.length;e++){var d=g[e];if(d.isConnected()){d.socket.disconnect()}}for(e=0;e<c._sockets.length;e++){var a=c._sockets[e];if(a.isConnected()){a.disconnect()}}this.drawingElements.splice(b,1);if(this.webgram){if(f){c._triggerRemoved()}c._clearWebgram()}if(f){c.onRemove.trigger(this);for(e=b;e<this.drawingElements.length;e++){this.drawingElements[e].onIndexChange.trigger(e);this.webgram.onDrawingElementIndexChange.trigger(this.drawingElements[e],e)}}this.invalidate(true)},_setDrawingElementIndex:function(d,c,g){var a=this.getDrawingElementIndex(d);if(a===-1){return}var f,b=0,e=this.drawingElements.length-1;for(f=0;f<this.drawingElements.length;f++){if(this.drawingElements[f]!==d&&this.drawingElements[f].zIndex>=d.zIndex){break}}if(a===f-1){f--}b=f;while((f<this.drawingElements.length)&&(this.drawingElements[f].zIndex===d.zIndex)){f++}e=f-1;if(c<b){c=b}else{if(c>e){c=e}}if(a===c){return}this.drawingElements.splice(a,1);this.drawingElements.splice(c,0,d);if(g){for(f=Math.min(c,a);f<=Math.max(c,a);f++){this.drawingElements[f].onIndexChange.trigger(f);if(this.webgram){this.webgram.onDrawingElementIndexChange.trigger(this.drawingElements[f],f)}}}this.invalidate(true)},_setTop:function(a){Webgram.DrawingElements.RectangularElement.prototype._setTop.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setRight:function(a){Webgram.DrawingElements.RectangularElement.prototype._setRight.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setBottom:function(a){Webgram.DrawingElements.RectangularElement.prototype._setBottom.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setLeft:function(a){Webgram.DrawingElements.RectangularElement.prototype._setLeft.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setTopLeft:function(a){Webgram.DrawingElements.RectangularElement.prototype._setTopLeft.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setBottomRight:function(a){Webgram.DrawingElements.RectangularElement.prototype._setBottomRight.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setTopRight:function(a){Webgram.DrawingElements.RectangularElement.prototype._setTopRight.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setBottomLeft:function(a){Webgram.DrawingElements.RectangularElement.prototype._setBottomLeft.call(this,a);for(var c=0;c<this.drawingElements.length;c++){var b=this.drawingElements[c];b.restoreParentRelativePosition()}},_setWebgram:function(a){this.webgram=a;for(var b=0;b<this.drawingElements.length;b++){this.drawingElements[b]._setWebgram(a)}},_clearWebgram:function(){for(var a=0;a<this.drawingElements.length;a++){this.drawingElements[a]._clearWebgram()}this.webgram=null},_triggerAdded:function(){this.webgram.onDrawingElementAdd.trigger(this);for(var a=0;a<this.drawingElements.length;a++){this.drawingElements[a]._triggerAdded()}},_triggerRemoved:function(){for(var a=0;a<this.drawingElements.length;a++){this.drawingElements[a]._triggerRemoved()}this.webgram.onDrawingElementRemove.trigger(this)}};Webgram.Class("Webgram.DrawingElements.ContainerElement",Webgram.DrawingElements.RectangularElement);Webgram.Namespace("Webgram.DrawingElements");Webgram.DrawingElements.PolyElement=function(b,a){Webgram.DrawingElement.call(this,b,a);this.closed=false;this.maxPointCount=Infinity;this._hoveredPoint=null;this._pendingCreatePoint=false;this.setHoveredControlPointsEnabled(true);this.setRotateEnabled(false);this.setAddRemovePointsEnabled(true);this.setEditEnabled(true);this.onAddPoint=new Webgram.Event("add point",this);this.onRemovePoint=new Webgram.Event("remove point",this);this.onKeyUp.bind(function(d,c){if(d===16){this._markHoveredPoint(null);return false}});this.onMouseDown.bind(function(c,e,d){if(d.shift&&this.isAddRemovePointsEnabled()){this._addHoveredPoint()}});this.onMouseMove.bind(function(c,d){if(d.shift&&this.isAddRemovePointsEnabled()&&this.getPolyControlPoints().length<this.maxPointCount){this._markHoveredPoint(c)}else{this._markHoveredPoint(null)}});this.onMouseLeave.bind(function(){this._markHoveredPoint(null)})};Webgram.DrawingElements.PolyElement.prototype={getCursor:function(){if(this._hoveredPoint){return"pointer"}return Webgram.DrawingElement.prototype.getCursor.call(this)},drawNoZoom:function(){Webgram.DrawingElement.prototype.drawNoZoom.call(this);if(this.isAddRemovePointsEnabled()&&(this.getFocusType()===Webgram.DrawingElement.FOCUS_HOVERED||this.getFocusType()===Webgram.DrawingElement.FOCUS_SELECTED)){this.drawHoveredPoint()}},drawDecoration:function(){if(this.shape.points.length==2){switch(this.getFocusType()){case Webgram.DrawingElement.FOCUS_NONE:break;case Webgram.DrawingElement.FOCUS_HOVERED:if(this._hoveredDecorationStyle){this.drawPoly(this.getLineTolerancePoly(),true);this.paint(this._hoveredDecorationStyle,null)}break;case Webgram.DrawingElement.FOCUS_SELECTED:if(this._selectedDecorationStyle){this.drawPoly(this.getLineTolerancePoly(),true);this.paint(this._selectedDecorationStyle,null)}break}}else{Webgram.DrawingElement.prototype.drawDecoration.call(this)}},drawHoveredPoint:function(){if(!this._hoveredPoint){return}var a=this.getImageStore().get("poly-point");if(!a){return}this.drawImage(a.content,this._hoveredPoint,a.size,0,0.5)},pointInside:function(a){if(this.shape.points.length<=1){return false}if(this.closed){return this.rotateDirect(this.shape).pointInside(a)}else{return this.transformDirect(this.getLineTolerancePoly()).pointInside(a)}},getLineTolerance:function(){var b=this.getStrokeStyle();var a=Math.round(b.lineWidth/2)+5/this.getZoomFactor();return a},getLineTolerancePoly:function(){var f=this.getLineTolerance();if(this.shape.points.length===0){return null}else{if(this.shape.points.length===1){var r=this.translateInverse(this.shape.points[0]);return new Webgram.Geometry.Poly([new Webgram.Geometry.Point(r.x-f,r.y-f),new Webgram.Geometry.Point(r.x+f,r.y-f),new Webgram.Geometry.Point(r.x+f,r.y+f),new Webgram.Geometry.Point(r.x-f,r.y+f)])}else{if(this.shape.points.length===2){var h=this.translateInverse(this.shape.points[0]);var g=this.translateInverse(this.shape.points[1]);var k=Math.atan2(g.y-h.y,g.x-h.x);var u=f*1.4142135623730951;var y=h.getPointAt(u,-3*Math.PI/4+k);var x=g.getPointAt(u,-Math.PI/4+k);var w=g.getPointAt(u,Math.PI/4+k);var v=h.getPointAt(u,3*Math.PI/4+k);return new Webgram.Geometry.Poly([y,x,w,v])}else{var l=[];var t=this.getDrawingPoly().points;var u=f*1.4142135623730951;var m=Math.PI/4;var n,h,g,e;var k,q,o;var j;for(var s=0;s<t.length-1;s++){h=t[s];g=t[s+1];if(s===0){q=Webgram.Utils.normalizeAngle(h.getAngleTo(g));l.push(h.getPointAt(u,-3*m+q))}if(s===t.length-2){q=Webgram.Utils.normalizeAngle(h.getAngleTo(g));l.push(g.getPointAt(u,-m+q))}else{e=t[s+2];q=Webgram.Utils.normalizeAngle(g.getAngleTo(h));o=Webgram.Utils.normalizeAngle(g.getAngleTo(e));j=f+(u-f)*Math.abs(Math.sin(o-q));k=(q+o)/2;if(q>o){k+=Math.PI}l.push(g.getPointAt(j,k))}}for(var s=t.length-2;s>=0;s--){h=t[s];g=t[s+1];if(s===t.length-2){q=Webgram.Utils.normalizeAngle(h.getAngleTo(g));l.push(g.getPointAt(u,m+q))}else{e=t[s+2];q=Webgram.Utils.normalizeAngle(g.getAngleTo(h));o=Webgram.Utils.normalizeAngle(g.getAngleTo(e));j=f+(u-f)*Math.abs(Math.sin(o-q));k=(q+o)/2+Math.PI;if(q>o){k-=Math.PI}l.push(g.getPointAt(j,k))}if(s===0){q=Webgram.Utils.normalizeAngle(h.getAngleTo(g));l.push(h.getPointAt(u,3*m+q))}}return new Webgram.Geometry.Poly(l)}}}},snapInternally:function(c,b,d,e,a){if(this.isSnapToAngleEnabled()&&this.getSetting("snapAngle")!=null){return this._snapToAngleInternally(c,b,e,a)}},addPoint:function(d,b){if(d<0||d>this.shape.points.length){return}var c;var f=this.getPolyControlPoints();for(var e=0;e<f.length;e++){c=f[e];if(c.polyPointIndex>=d){c.polyPointIndex+=1}}this.shape.points.splice(d,0,b);this.invalidateBaseRectangle();var a=this.getPolyControlPointClass(d);if(a!=null){this.addControlPoint(new a(d))}this._recreatePolyControlPoints();this.snap(d);this.onAddPoint.trigger(d,b)},remPoint:function(c){if(c<0||c>=this.shape.points.length){return}if(this.shape.points.length<=2){return}var b,d;var e=this.getPolyControlPoints();for(d=0;d<e.length;d++){b=e[d];if(b.polyPointIndex===c){this.remControlPoint(b)}}e=this.getPolyControlPoints();for(d=0;d<e.length;d++){b=e[d];if(b.polyPointIndex>c){b.polyPointIndex-=1}}var a=this.shape.points[c];this.shape.points.splice(c,1);this.invalidateBaseRectangle();this._recreatePolyControlPoints();this.onRemovePoint.trigger(c,a)},setPoint:function(b,a){this.setRotatedShapePoint(b,a);if(this.rotationCenterControlPoint){this.rotationCenterControlPoint.reset()}this._recreatePolyControlPoints()},getPoints:function(){var a=this.rotateDirect(this.shape);return a.points},getSelectedPointIndex:function(){var c=this.getPolyControlPoints();for(var b=0;b<c.length;b++){var a=c[b];if(a.getFocusType()===Webgram.ControlPoint.FOCUS_SELECTED){return a.polyPointIndex}}return -1},setSelectedPointIndex:function(b){var d=this.getPolyControlPoints();for(var c=0;c<d.length;c++){var a=d[c];if(a.getFocusType()===Webgram.ControlPoint.FOCUS_SELECTED){a.getFocusType(Webgram.ControlPoint.FOCUS_NONE)}if(c===b){a.getFocusType(Webgram.ControlPoint.FOCUS_SELECTED)}}},getMarkedForRemovalPointIndex:function(){var b=this.getPolyControlPoints();for(var c=0;c<b.length;c++){var a=b[c];if(a._markedForRemoval!=null){return a.polyPointIndex}}return -1},beginCreate:function(a){this.addPoint(0,a);if(this.maxPointCount>1){this._pendingCreatePoint=true}return true},continueCreate:function(b,d,a,e){var c=this.getPolyControlPointByIndex(this.shape.points.length-1);if(c!=null){c.move(b,true)}else{this.shape.points[this.shape.points.length-1]=b}if(e){if(c!=null){c.onEndMove.trigger()}if(this.shape.points.length>=this.maxPointCount){this._pendingCreatePoint=false;return false}this.addPoint(this.shape.points.length,b);c=this.getPolyControlPointByIndex(this.shape.points.length-1);if(c!=null){c.move(b,true)}}this.invalidateBaseRectangle();return true},endCreate:function(){if(this._pendingCreatePoint){this._pendingCreatePoint=false;var a=this.getPolyControlPointByIndex(this.shape.points.length-1);if(a!=null){a.onEndMove.trigger();this.remPoint(a.polyPointIndex)}else{this.remPoint(this.shape.points.length-1)}}if(this.shape.points.length<this.minPointCount){return false}return true},shapeFromJson:function(d){var c,e=[];for(c=0;c<d.length;c++){var a=d[c];var b=new Webgram.Geometry.Point(a.x,a.y);e.push(b)}if(e.length>this.shape.points.length){for(c=0;c<this.shape.points.length;c++){this.setPoint(c,e[c])}for(c=this.shape.points.length;c<e.length;c++){this.addPoint(this.shape.points.length,e[c])}}else{for(c=0;c<e.length;c++){this.setPoint(c,e[c])}while(this.shape.points.length>e.length){this.remPoint(this.shape.points.length-1)}}this.invalidateBaseRectangle()},getPolyControlPoints:function(){return this.getControlPoints(Webgram.DrawingElements.PolyElement.PolyControlPoint)},getNextPolyControlPoint:function(a){if(a.polyPointIndex===this.shape.points.length-1){return this.getPolyControlPointByIndex(0)}else{return this.getPolyControlPointByIndex(a.polyPointIndex+1)}},getPrevPolyControlPoint:function(a){if(a.polyPointIndex===0){return this.getPolyControlPointByIndex(this.shape.points.length-1)}else{return this.getPolyControlPointByIndex(a.polyPointIndex-1)}},getPolyControlPointByIndex:function(b){var d=this.getPolyControlPoints();for(var c=0;c<d.length;c++){var a=d[c];if(a.polyPointIndex===b){return a}}return null},getPolyControlPointClass:function(a){return Webgram.DrawingElements.PolyElement.PolyControlPoint},isAddRemovePointsEnabled:function(){return this._addRemovePointsEnabled},setAddRemovePointsEnabled:function(a){this._addRemovePointsEnabled=a;if(!a){this._hoveredPoint=null}},isEditEnabled:function(){return this._editEnabled},setEditEnabled:function(a){if(a){if(this._editEnabled){return}this._recreatePolyControlPoints();this._editEnabled=true;this._selectedDecorationStyle=Webgram.Styles.getStrokeStyle("default-selected-decoration")}else{if(!this._editEnabled){return}var c=this.getPolyControlPoints();for(var b=0;b<c.length;b++){this.remControlPoint(c[b])}this._editEnabled=false;this._selectedDecorationStyle=this._hoveredDecorationStyle}},_snapShapePoint:function(d,b,e,f,a){var c=this.getMarkedForRemovalPointIndex();if(c===d){return{point:b,snapVisualFeedback:null,xSnapped:false,ySnapped:false}}return Webgram.DrawingElement.prototype._snapShapePoint.call(this,d,b,e,f,a)},_snapToAngleInternally:function(z,A,u,b){function H(T,j,R,i){j=Webgram.Utils.normalizeAngle(j);i=Webgram.Utils.normalizeAngle(i);if(Math.abs(j-i)<0.000001){if(T.equals(R)){return T}else{return null}}else{var W,n,V,m,U,S;if(Math.abs(j-Math.PI/2)<0.000001){V=Math.tan(i);m=R.y-V*R.x;U=T.x;S=V*U+m}else{if(Math.abs(i-Math.PI/2)<0.000001){W=Math.tan(j);n=T.y-W*T.x;U=R.x;S=W*U+n}else{W=Math.tan(j);n=T.y-W*T.x;V=Math.tan(i);m=R.y-V*R.x;U=(n-m)/(V-W);S=(n*V-m*W)/(V-W)}}return new Webgram.Geometry.Point(U,S)}}var D=this.shape.points;if(D.length<2){return}var I=this.getSetting("snapAngle");var t=this.getSetting("snapAngleThreshold");if(I==null||t==null){return}var l=[];if(z>=2){l.push(D[z-1]);l.push(D[z-2])}else{if(z==1){l.push(D[0]);if(this.closed&&D.length>2){l.push(D[D.length-1])}}else{if(this.closed&&D.length>2){l.push(D[D.length-1]);l.push(D[D.length-2])}}}var F=[];if(z<=D.length-3){F.push(D[z+1]);F.push(D[z+2])}else{if(z==D.length-2){F.push(D[D.length-1]);if(this.closed&&D.length>2){F.push(D[0])}}else{if(this.closed&&D.length>2){F.push(D[0]);F.push(D[1])}}}var N,M,K,J,x,w,L;var a=[];var k=null;if(l.length>0){k=l[0];w=0;if(l.length==2){w=k.getAngleTo(l[1])}x=0;while(x<Math.PI){a.push(Webgram.Utils.normalizeAngle(x+w)%Math.PI);if(!Webgram.Utils.angleMultipleOf(w+u,I)){a.push(Webgram.Utils.normalizeAngle(x-u)%Math.PI)}x+=I}}var v=[];var s=null;if(F.length>0){s=F[0];w=0;if(F.length==2){w=s.getAngleTo(F[1])}x=0;while(x<Math.PI){v.push(Webgram.Utils.normalizeAngle(x+w)%Math.PI);if(!Webgram.Utils.angleMultipleOf(w+u,I)){v.push(Webgram.Utils.normalizeAngle(x-u)%Math.PI)}x+=I}}var f,E=[];if(a.length>0&&v.length>0){if(Math.abs(k.x-s.x)<0.000001){f={x:null,y:null,m:Infinity,n:Infinity,x0:k.x}}else{K=(k.y-s.y)/(k.x-s.x);J=k.y-K*k.x;f={x:null,y:null,m:K,n:J,x0:null}}E.push(f);for(N=0;N<a.length;N++){for(M=0;M<v.length;M++){if(Math.abs(a[N]-v[M])<0.000001){continue}var C=H(k,a[N],s,v[M]);if(C!=null){f={x:C.x,y:C.y,m:null,n:null,x0:null};E.push(f)}}}}var p,o,B=Infinity;var e,d,c,h;var G=null,L;for(N=0;N<E.length;N++){f=E[N];if(f.m!=null){e=A.getDistanceTo(k);d=A.getDistanceTo(s);c=s.getDistanceTo(k);h=(e*e+d*d-c*c)/(2*e*d);if(h>1){h=1}if(h<-1){h=-1}x=Math.acos(h);x=Math.PI-x}else{var L=new Webgram.Geometry.Point(f.x,f.y);c=A.getDistanceTo(L);e=A.getDistanceTo(k);d=L.getDistanceTo(k);h=(e*e+d*d-c*c)/(2*e*d);if(h>1){h=1}if(h<-1){h=-1}p=Math.acos(h);e=A.getDistanceTo(s);d=L.getDistanceTo(s);h=(e*e+d*d-c*c)/(2*e*d);if(h>1){h=1}if(h<-1){h=-1}o=Math.acos(h);x=p+o}if(x<B&&x<t){B=x;G=f}}var y,Q,q=null;if(G!=null){snapVisualFeedback=null;if(G.m!=null){if(G.m===0){y=null;Q=G.n}else{if(G.m===Infinity){y=G.x0;Q=null}else{y=function(i){return(i-G.n)/G.m};Q=function(i){return G.m*i+G.n};K=G.m;J=G.n;q=new Webgram.Geometry.Point((A.y*K+A.x-K*J)/(K*K+1),(K*K*A.y+K*A.x+J)/(K*K+1))}}}else{y=G.x;Q=G.y;bestPoint=new Webgram.Geometry.Point(y,Q);snapVisualFeedback=[];snapVisualFeedback.push({type:"radial",x:k.x,y:k.y,angle:k.getAngleTo(bestPoint)});snapVisualFeedback.push({type:"radial",x:s.x,y:s.y,angle:s.getAngleTo(bestPoint)})}return{x:y,y:Q,preferredPoint:q,snapVisualFeedback:snapVisualFeedback}}B=null;var P=null;var r=Infinity;var O;var g=[];for(N=0;N<a.length;N++){g.push({angle:a[N],point:k});g.push({angle:a[N]+Math.PI,point:k})}for(N=0;N<v.length;N++){g.push({angle:v[N],point:s});g.push({angle:v[N]+Math.PI,point:s})}for(N=0;N<g.length;N++){x=g[N].angle;p=Webgram.Utils.normalizeAngle(g[N].point.getAngleTo(A));O=Math.abs(x-p);if(O>Math.PI){O=2*Math.PI-O}if(O<r&&O<t){r=O;B=x;P=g[N].point}}if(B!=null){B=Webgram.Utils.normalizeAngle(B);q=null;if(Math.abs(B-Math.PI/2)<0.000001||Math.abs(B-3*Math.PI/2)<0.000001){y=P.x;Q=null}else{if(Math.abs(B)<0.000001||Math.abs(B-Math.PI)<0.000001){y=null;Q=P.y}else{K=Math.tan(B);J=P.y-K*P.x;y=function(i){return(i-J)/K};Q=function(i){return K*i+J};q=new Webgram.Geometry.Point((A.y*K+A.x-K*J)/(K*K+1),(K*K*A.y+K*A.x+J)/(K*K+1))}}return{x:y,y:Q,preferredPoint:q,snapVisualFeedback:{type:"radial",x:P.x,y:P.y,angle:B}}}},_markHoveredPoint:function(a){if(!a){this._hoveredPoint=null;this.invalidate();return}this._hoveredPoint=this._computeHoveredPoint(a);this.invalidate()},_addHoveredPoint:function(){if(!this._hoveredPoint){return}var b=this._getHoveredPointIndex();if(b===-1){return}var a=this.translateDirect(this._hoveredPoint);this.addPoint(b,a);this.setSelectedPointIndex(b);this._hoveredPoint=null;this.invalidate()},_removeSelectedPoint:function(){var a=this.getSelectedPointIndex();if(a!==-1){this.remPoint(a);this.invalidate()}},_getHoveredPointIndex:function(){var a=this.transformDirect(this._hoveredPoint);var f=-1;var e=this.rotateDirect(this.shape).points;for(var c=0;c<e.length;c++){var d=e[c];var b;if(c<e.length-1){b=e[c+1]}else{b=e[0]}if(Webgram.Utils.pointInSegment(a,d,b,3)){f=c+1;break}}return f},_computeHoveredPoint:function(h){var c=-1;var l=this.rotateDirect(this.shape).points;for(var b=0;b<l.length;b++){if(!this.closed&&b===l.length-1){break}var g=l[b];var e;if(b<l.length-1){e=l[b+1]}else{e=l[0]}if(Webgram.Utils.pointInSegment(h,g,e,this.getLineTolerance())){var j,f;if(e.y===g.y){f=g.y;j=h.x}else{if(e.x===g.x){j=g.x;f=h.y}else{var a=(e.y-g.y)/(e.x-g.x);j=(h.y-g.y+h.x/a+g.x*a)/(a+1/a);f=g.y+a*(j-g.x)}}var k=new Webgram.Geometry.Point(j,f);var d=this._controlPoints[0].radius*1.5/this.getZoomFactor();for(b=0;b<l.length;b++){if(k.getDistanceTo(l[b])<d){return null}}return this.transformInverse(k)}}return null},_recreatePolyControlPoints:function(){var d,c=this.getPolyControlPoints();var b=[];for(d=0;d<c.length;d++){b[c[d].polyPointIndex]=c[d]}for(d=0;d<this.shape.points.length;d++){var a=this.getPolyControlPointClass(d);var e=b[d];var f=e&&e.constructor;if(a!=f){if(e!=null){this.remControlPoint(e)}if(a!=null){this.addControlPoint(new a(d))}}}}};Webgram.Class("Webgram.DrawingElements.PolyElement",Webgram.DrawingElement);Webgram.DrawingElements.PolyElement.PolyControlPoint=function(a){Webgram.ControlPoint.call(this);this.radius=11;this.polyPointIndex=a;this._removeDistance=10;this._markedForRemoval=null;this.setSnapToGridEnabled(false);this.onEndMove.bind(function(){this._removeIfMarked()})};Webgram.DrawingElements.PolyElement.PolyControlPoint.prototype={getCursor:function(){return"pointer"},draw:function(){this.drawBase();if(this._markedForRemoval!=null){this.drawRemovalMark()}},drawBase:function(){var b=1;var a=this.getImageStore().get("poly-point");if(!a){return}if(this.drawingElement.getFocusType()===Webgram.DrawingElement.FOCUS_HOVERED){b=0.5}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0,b)},drawRemovalMark:function(){var a=this.getImageStore().get("remove-poly-point");if(!a){return}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0)},computeAnchor:function(){return this.drawingElement.rotateDirect(this.drawingElement.shape.points[this.polyPointIndex])},snap:function(a){if(this._markedForRemoval!=null){var c=this._markedForRemoval.getAnchor();var d=a.getDistanceTo(c);var b=this.getSetting("snapDistance",this.radius);if(d<=b){return c}else{return a}}else{return a}},processMove:function(a,b){this.drawingElement._setRotatedShapePoint(this.polyPointIndex,a);if(this.drawingElement.rotationCenterControlPoint){this.drawingElement.rotationCenterControlPoint.reset()}this.drawingElement.snap(this.polyPointIndex);if(this.drawingElement.isAddRemovePointsEnabled()){this._checkAndMarkForRemoval()}},_checkAndMarkForRemoval:function(){if(this.drawingElement.isCreating()){return}this._markedForRemoval=null;var b=this.drawingElement.getPolyControlPointByIndex(this.polyPointIndex-1);var a=this.drawingElement.getPolyControlPointByIndex(this.polyPointIndex+1);if(b&&b.getAnchor()&&b.getAnchor().getDistanceTo(this.getAnchor())<this._removeDistance){if(this.drawingElement.getPolyControlPoints().length<=this.drawingElement.minPointCount){return}this._markedForRemoval=b}if(a&&a.getAnchor()&&a.getAnchor().getDistanceTo(this.getAnchor())<this._removeDistance){if(this.drawingElement.getPolyControlPoints().length<=this.drawingElement.minPointCount){return}this._markedForRemoval=a}},_removeIfMarked:function(){if(this._markedForRemoval!=null){this.drawingElement.remPoint(this.polyPointIndex)}}};Webgram.Class("Webgram.DrawingElements.PolyElement.PolyControlPoint",Webgram.ControlPoint);Webgram.Namespace("Webgram.DrawingElements");Webgram.DrawingElements.RootContainer=function(a,b){Webgram.DrawingElements.ContainerElement.call(this,":special:root-container",-b.getWidth()/2,-b.getHeight()/2,b.getWidth(),b.getHeight());this.webgram=a;this.canvas=b;this._controlPoints=[];this._parent=null;this._fillStyle=Webgram.Styles.getFillStyle("background");this._activeDrawingControl=null;this._prevDrawingControl=null;this._lastMousePoint=null;this._noZoom=false;this._zoomLevel=this.getSetting("zoomLevel");this._zoomFactor=this.getSetting("zoomFactors")[this._zoomLevel];this._offsetX=-this.canvas.getWidth()/2;this._offsetY=-this.canvas.getHeight()/2;this._snapVisualFeedbackList=null;this._snapVisualFeedbackTimer=null;this._drawingStartTime=0;this._drawingEndTime=0;this.setMoveEnabled(false);this.setRotateEnabled(false);this.setResizeEnabled(false);this.setSelectEnabled(false)};Webgram.DrawingElements.RootContainer.prototype={drawBackground:function(){this.canvas.clear();if(this._fillStyle!=null){this.drawRect(this.webgram.getVisibleArea().getShrinked(-1));this.paint()}},drawGrid:function(){var d=this.canvas.getWidth()/this._zoomFactor;var a=this.canvas.getHeight()/this._zoomFactor;var g=1/this._zoomFactor;var c,f,m,l,j;var e=this.getSetting("snapGrid");var n=this.getSetting("mainGrid");var h=Webgram.Styles.getStrokeStyle("main-grid").replace({lineWidth:g});var k=Webgram.Styles.getStrokeStyle("main-grid-axes").replace({lineWidth:g});var i=null;if(e!=null&&e.sizeX!=null){i=Webgram.Styles.getStrokeStyle("snap-grid").replace({lineWidth:g})}if(!this._mini){if(this._zoomFactor>1&&i!=null){f=Math.floor(this._offsetX/e.sizeX)+1;m=Math.floor((this._offsetX+d)/e.sizeX);for(c=f;c<=m;c++){l=e.sizeX*c;this.drawLine(new Webgram.Geometry.Point(l,this._offsetY),new Webgram.Geometry.Point(l,a+this._offsetY-1));this.paint(i,null)}f=Math.floor(this._offsetY/e.sizeY)+1;m=Math.floor((this._offsetY+a)/e.sizeY);for(c=f;c<=m;c++){j=e.sizeY*c;this.drawLine(new Webgram.Geometry.Point(this._offsetX,j),new Webgram.Geometry.Point(d+this._offsetX-1,j));this.paint(i,null)}}var b;if(this._zoomFactor<1){b=Math.round(1/this._zoomFactor)}else{b=1}f=Math.floor(this._offsetX/n.sizeX)+1;m=Math.floor((this._offsetX+d)/n.sizeX);for(c=f;c<=m;c++){if(c%b){continue}l=n.sizeX*c;if(l===0){continue}this.drawLine(new Webgram.Geometry.Point(l,this._offsetY),new Webgram.Geometry.Point(l,a+this._offsetY-1));this.paint(h,null)}f=Math.floor(this._offsetY/n.sizeY)+1;m=Math.floor((this._offsetY+a)/n.sizeY);for(c=f;c<=m;c++){if(c%b){continue}j=n.sizeY*c;if(j===0){continue}this.drawLine(new Webgram.Geometry.Point(this._offsetX,j),new Webgram.Geometry.Point(d+this._offsetX-1,j));this.paint(h,null)}}this.drawLine(new Webgram.Geometry.Point(0,this._offsetY),new Webgram.Geometry.Point(0,a+this._offsetY-1));this.paint(k,null);this.drawLine(new Webgram.Geometry.Point(this._offsetX,0),new Webgram.Geometry.Point(d+this._offsetX-1,0));this.paint(k,null)},drawSnapVisualFeedback:function(){if(this._mini){return}if(this._snapVisualFeedbackList==null||this._snapVisualFeedbackList.length===0){return}if(!this.getSetting("snapVisualFeedback")){return}var o=Webgram.Styles.getStrokeStyle("snap-visual-feedback");var p=Webgram.Styles.createFillStyle({colors:o.colors});var m=Webgram.Styles.getTextStyle("snap-visual-feedback");var h=this.canvas.getWidth()/this._zoomFactor;var b=this.canvas.getHeight()/this._zoomFactor;for(var g=0;g<this._snapVisualFeedbackList.length;g++){var e=this._snapVisualFeedbackList[g];if(e.type==="linear"){if(e.x!=null){this.drawLine(new Webgram.Geometry.Point(e.x,this._offsetY),new Webgram.Geometry.Point(e.x,b+this._offsetY-1));this.paint(o,null)}if(e.y!=null){this.drawLine(new Webgram.Geometry.Point(this._offsetX,e.y),new Webgram.Geometry.Point(h+this._offsetX-1,e.y));this.paint(o,null)}}else{var a=new Webgram.Geometry.Point(e.x,e.y);var k=50;var d=Webgram.Utils.normalizeAngle(e.angle);var c=10*Math.PI/k/this._zoomFactor;this.drawArc(a,k,k,d-c,d+c,0);this.paint(o,null);var j=a.getPointAt(k,d);var f=10/this._zoomFactor;var l=Math.PI/4;var n=5/k/this._zoomFactor;this.drawLine(j,j.getPointAt(f,d-Math.PI/2-l/2-n));this.drawLine(j.getPointAt(f,d-Math.PI/2+l/2-n));this.drawLine(j);this.paint(null,p);this.drawLine(j,j.getPointAt(f,d+Math.PI/2-l/2+n));this.drawLine(j.getPointAt(f,d+Math.PI/2+l/2+n));this.drawLine(j);this.paint(null,p);this.drawLine(a,a.getPointAt(k*100,d));this.paint(o,null)}}},drawRulers:function(){var e=Webgram.Styles.getFillStyle("rulers");var t=Webgram.Styles.getStrokeStyle("rulers");var d=Webgram.Styles.getTextStyle("rulers");var o=this.getSetting("mainGrid");var j=this.getSetting("snapGrid");var c=this.getSetting("showRulers");var m=this.getSetting("showZoom");var n,s,a,b,i,h;if(!this._mini){var p=this.canvas.getWidth()/this._zoomFactor;var l=this.canvas.getHeight()/this._zoomFactor;var w=1/this._zoomFactor;var v=null,r=null;if(j!=null&&j.sizeX!=null){v=j.sizeX;r=j.sizeY}else{if(o!=null&&o.sizeX!=null){v=Math.round(o.sizeX/2);r=Math.round(o.sizeY/2)}}if(c&&v!=null){s=15;n=Math.max((""+Math.round(this._offsetY)).length,(""+Math.round(this._offsetY+l)).length)*7;this.drawRect(new Webgram.Geometry.Rectangle(this._offsetX-w,this._offsetY-w,this._offsetX+p,this._offsetY+s/this._zoomFactor));this.drawRect(new Webgram.Geometry.Rectangle(this._offsetX-w,this._offsetY-w,this._offsetX+n/this._zoomFactor,this._offsetY+l));this.paint(null,e);this.drawLine(new Webgram.Geometry.Point(this._offsetX+n/this._zoomFactor,this._offsetY+s/this._zoomFactor),new Webgram.Geometry.Point(this._offsetX+p,this._offsetY+s/this._zoomFactor));this.paint(t,null);this.drawLine(new Webgram.Geometry.Point(this._offsetX+n/this._zoomFactor,this._offsetY+s/this._zoomFactor),new Webgram.Geometry.Point(this._offsetX+n/this._zoomFactor,this._offsetY+l));this.paint(t,null);var u=Math.ceil(Math.round(10/this._zoomFactor)/v)*v;a=Math.floor(this._offsetX/v)+Math.round(10/this._zoomFactor);b=Math.floor((this._offsetX+p)/v)-1;for(i=a;i<=b;i++){if(i%u){continue}var g=v*i;h=new Webgram.Geometry.Rectangle(g,this._offsetY,g,this._offsetY+s/this._zoomFactor);this.drawText(""+g,h,d)}var q=Math.ceil(Math.round(10/this._zoomFactor)/r)*r;a=Math.floor(this._offsetY/r)+2;b=Math.floor((this._offsetY+l)/r)-1;for(i=a;i<=b;i++){if(i%q){continue}var f=r*i;h=new Webgram.Geometry.Rectangle(this._offsetX,f,this._offsetX+(n-3)/this._zoomFactor,f);this.drawText(""+f,h,d.replace({justify:"rc"}))}}if(m){n=45;s=15;this.drawRect(new Webgram.Geometry.Rectangle(this._offsetX+p-n/this._zoomFactor,this._offsetY+l-s/this._zoomFactor,this._offsetX+p,this._offsetY+l));this.paint(t,e);var k;if(this._zoomFactor>=2){k=""+this._zoomFactor+" x"}else{k=""+this._zoomFactor.toFixed(1)+" x"}h=new Webgram.Geometry.Rectangle(this._offsetX+p-n/this._zoomFactor,this._offsetY+l-s/this._zoomFactor,this._offsetX+p,this._offsetY+l);this.drawText(k,h,d.replace({justify:"cc"}))}}},drawFPS:function(){var a=new Date().getTime()-this._drawingEndTime;var b=1000/a;this.drawText("fps: "+b.toFixed(1),new Webgram.Geometry.Rectangle(-100,-100,100,100))},draw:function(){this._drawingStartTime=new Date().getTime();this.drawBackground();if(this.webgram.settings.mainGrid){this.drawGrid()}var a,b;for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];if(a.shape.points.length>=a.minPointCount){a.draw();if(!this._mini){this._noZoom=true;a.drawNoZoom();this._noZoom=false}}}for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];a.drawTop();if(!this._mini){this._noZoom=true;a.drawNoZoomTop();this._noZoom=false}}if(!this._mini){for(b=0;b<this.drawingElements.length;b++){a=this.drawingElements[b];this._noZoom=true;a.drawActionMenuItems();a.drawControlPoints();a.drawSockets();this._noZoom=false}}this._noZoom=true;this.drawSnapVisualFeedback();this.drawRulers();this._noZoom=false;this._drawingEndTime=new Date().getTime()},drawLine:function(b,a){if(this._noZoom){b=this.transformZoomOffsetDirect(b);a=a&&this.transformZoomOffsetDirect(a)}this.canvas.drawLine(b,a)},drawPoly:function(e,b){if(this._noZoom){var d=[];for(var c=0;c<e.points.length;c++){var a=e.points[c];a=this.transformZoomOffsetDirect(a);d.push(a)}e=new Webgram.Geometry.Poly(d)}this.canvas.drawPoly(e,b)},drawRect:function(a){var b=a.getPoly();this.drawPoly(b,true)},drawArc:function(a,e,d,c,b){if(this._noZoom){a=this.transformZoomOffsetDirect(a);e*=this._zoomFactor;d*=this._zoomFactor}this.canvas.drawArc(a,e,d,c,b)},drawBezier:function(d,c,b,a){if(this._noZoom){d=this.transformZoomOffsetDirect(d);c=this.transformZoomOffsetDirect(c);if(a!=null){b=this.transformZoomOffsetDirect(b)}a=this.transformZoomOffsetDirect(a)}this.canvas.drawBezier(d,c,b,a)},drawImage:function(e,a,b,f,d,c){if(!c){c=new Webgram.Canvas.TransformSet()}if(!this._noZoom){c.addTranslation(-this._offsetX,-this._offsetY);c.addScaling(this._zoomFactor)}else{a=this.transformZoomOffsetDirect(a)}this.canvas.drawImage(e,a,b,f,d,c)},drawText:function(f,c,e,d){if(c==null){c=this.getBaseRectangle()}if(e===undefined){e=this.getTextStyle()}if(!d){d=new Webgram.Canvas.TransformSet()}if(!this._noZoom){d.addTranslation(-this._offsetX,-this._offsetY);d.addScaling(this._zoomFactor)}else{var b=this.transformZoomOffsetDirect(c.getTopLeft());var a=this.transformZoomOffsetDirect(c.getBottomRight());c=new Webgram.Geometry.Rectangle(b.x,b.y,a.x,a.y)}this.canvas.drawText(f,c,e,d)},paint:function(f,a,e){if(!e){e=new Webgram.Canvas.TransformSet()}if(f===undefined){f=this.getStrokeStyle()}if(a===undefined){a=this.getFillStyle()}if(!this._noZoom){e.addTranslation(-this._offsetX,-this._offsetY);e.addScaling(this._zoomFactor)}else{if(f){f=f.clone()}if(a){a=a.clone()}var d=[f,a];for(var b=0;b<d.length;b++){var c=d[b];if(!c){continue}if(c.gradientPoint1){c.gradientPoint1=this.transformZoomOffsetDirect(c.gradientPoint1)}if(c.gradientPoint2){c.gradientPoint2=this.transformZoomOffsetDirect(c.gradientPoint2)}}}this.canvas.paint(f,a,e)},getZoomFactor:function(){return this._zoomFactor},getZoomLevel:function(){return this._zoomLevel},setZoomLevel:function(d,a){this._zoomLevel=d;var b=this.getSetting("zoomFactors");if(this._zoomLevel>b.length-1){this._zoomLevel=b.length-1}if(this._zoomLevel<0){this._zoomLevel=0}this.setZoomFactor(b[this._zoomLevel],a);for(var c=0;c<this.drawingElements.length;c++){this.drawingElements[c].invalidatePoints()}this.invalidate()},setZoomFactor:function(d,a){var f=this._zoomFactor;this._zoomFactor=d;if(a){var c=a.x*(this._zoomFactor/f-1);var b=a.y*(this._zoomFactor/f-1);var e=this.getOffset();e=e.getTranslated(c/this._zoomFactor,b/this._zoomFactor);this.setOffset(e)}this.invalidate(true);this.webgram.onZoom.trigger(this._zoomLevel)},getOffset:function(){return new Webgram.Geometry.Point(this._offsetX,this._offsetY)},setOffset:function(a){this._offsetX=Math.round(a.x);this._offsetY=Math.round(a.y);this.webgram.onPan.trigger(this.getVisibleCenter())},getVisibleCenter:function(){return this.transformZoomOffsetInverse(new Webgram.Geometry.Point(this.getWidth()/2,this.getHeight()/2))},setVisibleCenter:function(b){var a=b.x-this.getWidth()/2/this._zoomFactor;var c=b.y-this.getHeight()/2/this._zoomFactor;this.setOffset(new Webgram.Geometry.Point(a,c));this.invalidate(true)},getWidth:function(){return this.canvas.getWidth()},getHeight:function(){return this.canvas.getHeight()},setWidth:function(a){this.canvas.setWidth(a);this.invalidate()},setHeight:function(a){this.canvas.setHeight(a);this.invalidate()},getMargins:function(){if(this.drawingElements.length>0){return Webgram.DrawingElements.ContainerElement.prototype.getMargins.call(this)}else{var b=this.getWidth();var a=this.getHeight();return new Webgram.Geometry.Rectangle(-b/2,-a/2,b/2,a/2)}},transformZoomOffsetDirect:function(a){return new Webgram.Geometry.Point((a.x-this._offsetX)*this._zoomFactor,(a.y-this._offsetY)*this._zoomFactor)},transformZoomOffsetInverse:function(a){return new Webgram.Geometry.Point(a.x/this._zoomFactor+this._offsetX,a.y/this._zoomFactor+this._offsetY)},setSnapVisualFeedback:function(a){if(this._snapVisualFeedbackTimer!=null){clearTimeout(this._snapVisualFeedbackTimer);this._snapVisualFeedbackTimer=null}if(a==null||a.length===0){this._snapVisualFeedbackList=null;this.invalidate();return}if(a instanceof Array){this._snapVisualFeedbackList=a}else{this._snapVisualFeedbackList=[a]}this.invalidate();var b=this;this._snapVisualFeedbackTimer=setTimeout(function(){b._snapVisualFeedbackList=null;b.invalidate()},200)},addControlPoint:function(a){},addSocket:function(a){},addActionMenuItem:function(a){},saveParentRelativePosition:function(){},restoreParentRelativePosition:function(){},enterContainerElement:function(a){},leaveContainerElement:function(){},getActiveDrawingControl:function(){return this._activeDrawingControl},handleMouseDown:function(b,d,c){b=this.transformZoomOffsetInverse(b);var a,e=this.getActiveDrawingControl();if(e!=null&&(a=e.handleMouseDown(b,d,c))){return a}else{return this.onMouseDown.trigger(b,d,c)}},handleMouseUp:function(b,d,c){b=this.transformZoomOffsetInverse(b);var a,e=this.getActiveDrawingControl();if(e!=null&&(a=e.handleMouseUp(b,d,c))){return a}else{return this.onMouseUp.trigger(b,d,c)}},handleMouseMove:function(b,c){b=this.transformZoomOffsetInverse(b);this._lastMousePoint=b;var a,d=this.getActiveDrawingControl();if(d!=null&&(a=d.handleMouseMove(b,c))){return a}else{return this.onMouseMove.trigger(b,c)}},handleMouseScroll:function(c,b,d){c=this.transformZoomOffsetInverse(c);var a,e=this.getActiveDrawingControl();if(e!=null&&(a=e.handleMouseScroll(c,b,d))){return a}else{return this.onMouseScroll.trigger(c,b,d)}},handleKeyPress:function(c,b){var a,d=this.getActiveDrawingControl();if(d!=null&&(a=d.handleKeyPress(c,b))){return a}else{return this.onKeyPress.trigger(c,b)}},handleKeyDown:function(c,b){var a,d=this.getActiveDrawingControl();if(d!=null&&(a=d.handleKeyDown(c,b))){return a}else{return this.onKeyDown.trigger(c,b)}},handleKeyUp:function(c,b){var a,d=this.getActiveDrawingControl();if(d!=null&&(a=d.handleKeyUp(c,b))){return a}else{return this.onKeyUp.trigger(c,b)}},handleFocus:function(){var a,b=this.getActiveDrawingControl();if(b!=null&&(a=b.handleFocus())){return a}},handleBlur:function(){var a,b=this.getActiveDrawingControl();if(b!=null&&(a=b.handleBlur())){return a}},_addDrawingElement:function(b,a,d){Webgram.DrawingElements.ContainerElement.prototype._addDrawingElement.call(this,b,a,d);if(d){var c=this.getActiveDrawingControl();if(c!=null){c.handleDrawingElementAdd(b)}}},_remDrawingElement:function(b,d){if(d){var c=this.getActiveDrawingControl();if(c!=null){var e=c.getSelectedDrawingElements();c.handleDrawingElementRemove(b);var a=c.getSelectedDrawingElements();if(!Webgram.Utils.equals(e,a)&&this.webgram!=null){this.webgram.onSelectionChange.trigger(a)}}}Webgram.DrawingElements.ContainerElement.prototype._remDrawingElement.call(this,b,d)}};Webgram.Class("Webgram.DrawingElements.RootContainer",Webgram.DrawingElements.ContainerElement);Webgram.Connectors=Webgram.Namespace("Webgram.Connectors");Webgram.Connectors.Connector=function(b,a){Webgram.DrawingElements.PolyElement.call(this,b,a);this.zIndex=10;this.onConnect=new Webgram.Event("connect",this);this.onDisconnect=new Webgram.Event("disconnect",this)};Webgram.Connectors.Connector.prototype={draw:function(){this.drawPoly(this.getDrawingPoly(),false);this.paint(undefined,null)},saveParentRelativePosition:function(){var d=this._parent.getWidth();var c=this._parent.getHeight();this._parentRelativePositions=[];for(var b=0;b<this.shape.points.length;b++){var a=this.shape.points[b];a=this.rotateDirect(a);this._parentRelativePositions.push({x:a.x/(d-1),y:a.y/(c-1)})}},restoreParentRelativePosition:function(){var g=this._parent.getWidth();var f=this._parent.getHeight();for(var e=0;e<this._parentRelativePositions.length;e++){var d=this.getPolyControlPointByIndex(e);if(d&&(d instanceof Webgram.Connectors.EndPoint)&&d.isConnected()){continue}var b=this._parentRelativePositions[e];var a=new Webgram.Geometry.Point(b.x*(g-1),b.y*(f-1));this.shape.points[e]=a}var c=this.shape.getBoundingRectangle().getCenter();this.shape=this.shape.getRotated(-this.getRotationAngle(),c);this.invalidateBaseRectangle()},remControlPoint:function(a){if(a instanceof Webgram.Connectors.EndPoint&&a.isConnected()){a.socket.disconnect(a)}Webgram.DrawingElements.PolyElement.prototype.remControlPoint.call(this,a)},getPolyControlPointClass:function(a){return Webgram.Connectors.EndPoint},snapExternally:function(d,c,e,f,b){var a=this._snapToSockets(d,c,e,f,b);if(a!=null){return a}return Webgram.DrawingElement.prototype.snapExternally.call(this,d,c,e,f,b)},setEditEnabled:function(a){if(!a){this._disconnectAllEndPoints()}Webgram.DrawingElements.PolyElement.prototype.setEditEnabled.call(this,a)},getEndPoints:function(){return this.getControlPoints(Webgram.Connectors.EndPoint)},moveTo:function(b){var f=this.getEndPoints();var d=null;for(var c=0;c<f.length;c++){if(f[c].isConnected()){d=f[c];break}}if(d){var a=this.getCenter();var e=a.getDistanceTo(b);if(e<4*d.radius){return}}this._disconnectAllEndPoints();Webgram.DrawingElement.prototype.moveTo.call(this,b)},continueCreate:function(b,d,a,f){var e=this.shape.points.length;if(f&&e>1&&e>=this.minPointCount){var c=this.getPolyControlPointByIndex(e-1);if(c instanceof Webgram.Connectors.EndPoint&&c.isConnected()){this._pendingCreatePoint=false;return false}}return Webgram.DrawingElements.PolyElement.prototype.continueCreate.call(this,b,d,a,f)},isSnapExternallyEnabled:function(){return true},_snapToSockets:function(d,b,f,g,a){var e=this.getPolyControlPointByIndex(d);if(!(e instanceof Webgram.Connectors.EndPoint)){return null}b=b.getRotated(g,a);var c=e._getHoveredSocket(b);if(c){return c.getAnchor().getRotated(-g,a)}},_setRotationAngle:function(a){this._disconnectAllEndPoints();Webgram.DrawingElements.PolyElement.prototype._setRotationAngle.call(this,a)},_disconnectAllEndPoints:function(){var c=this.getEndPoints();for(var b=0;b<c.length;b++){var a=c[b];if(a.isConnected()){a.socket.disconnect(a)}}}};Webgram.Class("Webgram.Connectors.Connector",Webgram.DrawingElements.PolyElement);Webgram.Namespace("Webgram.Connectors");Webgram.Connectors.Socket=function(a){Webgram.ControlPoint.call(this);this.radius=10;this._endPoints=[];this._anchorFunc=a;this.onConnect=new Webgram.Event("connect",this);this.onDisconnect=new Webgram.Event("disconnect",this)};Webgram.Connectors.Socket.prototype={draw:function(){var b;var a=1;if(this.getFocusType()!==Webgram.ControlPoint.FOCUS_HOVERED){return}b=this.getImageStore().get("socket");if(!b){return}this.drawImage(b.content,Webgram.Geometry.Point.zero(),b.size,0,a)},computeAnchor:function(){var a=this._anchorFunc.call(this.drawingElement,this);return this.drawingElement.transformDirect(a)},update:function(){Webgram.ControlPoint.prototype.update.call(this);for(var b=0;b<this._endPoints.length;b++){var a=this._endPoints[b];a.update();a.movePoint(this.getAnchor())}},isConnected:function(){return this._endPoints.length>0},connect:function(b){this._endPoints.push(b);b.socket=this;b.onConnect.trigger(this);b.movePoint(this.getAnchor());this.onConnect.trigger(b);var a=b.drawingElement;a.onConnect.trigger(b,this);if(a.webgram){a.webgram.onDrawingElementInteract.trigger(a,this.drawingElement,"connect")}},disconnect:function(d){if(d!=null){var b=Webgram.Utils.indexOf(this._endPoints,d);if(b===-1){return}this.onDisconnect.trigger(d);d.onDisconnect.trigger(this);d.socket=null;this._endPoints.splice(b,1);var a=d.drawingElement;a.onDisconnect.trigger(d,this)}else{this.onDisconnect.trigger(d);for(var c=0;c<this._endPoints.length;c++){var d=this._endPoints[c];d.onDisconnect.trigger(this);d.socket=null;var a=d.drawingElement;a.onDisconnect.trigger(d,this)}this._endPoints=[]}if(a.webgram){a.webgram.onDrawingElementInteract.trigger(a,this.drawingElement,"disconnect")}},accepts:function(a){return true}};Webgram.Class("Webgram.Connectors.Socket",Webgram.ControlPoint);Webgram.Namespace("Webgram.Connectors");Webgram.Connectors.EndPoint=function(a){Webgram.DrawingElements.PolyElement.PolyControlPoint.call(this,a);this.radius=6;this.socket=null;this.onConnect=new Webgram.Event("connect",this);this.onDisconnect=new Webgram.Event("disconnect",this);this._hoveredDrawingElement=null;this.onEndMove.bind(function(){this._setHoveredDrawingElement(null)})};Webgram.Connectors.EndPoint.prototype={isConnected:function(){return this.socket!=null},movePoint:function(a){this.drawingElement.setRotatedShapePoint(this.polyPointIndex,a)},drawBase:function(){if(this.isConnected()){var b=1;var a=this.getImageStore().get("end-point-connected");if(!a){return}if(this.drawingElement.getFocusType()===Webgram.DrawingElement.FOCUS_HOVERED){b=0.5}this.drawImage(a.content,Webgram.Geometry.Point.zero(),a.size,0,b)}else{Webgram.DrawingElements.PolyElement.PolyControlPoint.prototype.drawBase.call(this)}},processMove:function(a,b){Webgram.DrawingElements.PolyElement.PolyControlPoint.prototype.processMove.call(this,a,b);this._checkConnect()},_checkConnect:function(){var b=this._getHoveredSocket(this.getAnchor());if(b){if(this.socket){if(b!==this.socket){this.socket.disconnect(this);b.connect(this)}}else{b.connect(this)}this._setHoveredDrawingElement(null)}else{if(this.socket){this.socket.disconnect(this)}var a=this._getHoveredDrawingElement();this._setHoveredDrawingElement(a)}},_getHoveredSocket:function(a){if(this.socket&&this.socket.pointInside(a)){return this.socket}if(this.drawingElement._parent==null){return null}var e=this.drawingElement._parent.drawingElements;for(var c=e.length-1;c>=0;c--){var d=e[c];if(d===this.drawingElement){continue}var b=d.pointInsideSocket(a);if(b){return b}}return null},_getHoveredDrawingElement:function(){var d=this.drawingElement._parent.drawingElements;var a=this.getAnchor();for(var b=d.length-1;b>=0;b--){var c=d[b];if(c===this.drawingElement){continue}if(c.pointInside(a)){return c}}return null},_setHoveredDrawingElement:function(b){if(this._hoveredDrawingElement===b){return}var a,c;if(this._hoveredDrawingElement){for(c=0;c<this._hoveredDrawingElement._sockets.length;c++){a=this._hoveredDrawingElement._sockets[c];a.setFocusType(Webgram.ControlPoint.FOCUS_NONE)}}this._hoveredDrawingElement=b;if(this._hoveredDrawingElement){for(c=0;c<this._hoveredDrawingElement._sockets.length;c++){a=this._hoveredDrawingElement._sockets[c];a.setFocusType(Webgram.ControlPoint.FOCUS_HOVERED)}}}};Webgram.Class("Webgram.Connectors.EndPoint",Webgram.DrawingElements.PolyElement.PolyControlPoint);Webgram.DrawingControls=Webgram.Namespace("Webgram.DrawingControls");Webgram.DrawingControls.SelectDrawingControl=function(a){Webgram.DrawingControl.call(this,a);this.hoveredDrawingElement=null;this.selectedDrawingElement=null;this.hoveredControlPoint=null;this.selectedControlPoint=null;this.hoveredActionMenuItem=null;this.onSelectionChange=new Webgram.Event("selection change",this);this._mouseDownPoint=null;this._panMouseDownPoint=null;this._msContainerElement=null;this.onDeactivate.bind(function(){this.setSelectedDrawingElements(null);this.hoveredDrawingElement=null;this.selectedDrawingElement=null;this.hoveredControlPoint=null;this.selectedControlPoint=null;this.hoveredActionMenuItem=null;this._mouseDownPoint=null;this._msContainerElement=null});this.onSelectionChange.bind(function(b){this.rootContainer.webgram.onSelectionChange.trigger(b)})};Webgram.DrawingControls.SelectDrawingControl.prototype={getSelectedDrawingElements:function(){if(this._msContainerElement){return this._msContainerElement.drawingElements.slice(0)}else{if(this.selectedDrawingElement){return[this.selectedDrawingElement]}else{return[]}}},setSelectedDrawingElements:function(b){if(this._msContainerElement){this._remFromMultipleSelection()}if(this.selectedDrawingElement){this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_NONE);this.selectedDrawingElement=null}if(b&&b.length){if(b.length===1){this.selectedDrawingElement=b[0];if(this.selectedDrawingElement){this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED)}this.onSelectionChange.trigger([this.selectedDrawingElement])}else{if(this.getSetting("multipleSelectionEnabled")){for(var a=0;a<b.length;a++){b[a].setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE)}this._msContainerElement=new Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer(0,0,0,0);this.rootContainer._addDrawingElement(this._msContainerElement);this.selectedDrawingElement=this._msContainerElement;this._finishMultipleSelection()}else{this.onSelectionChange.trigger([])}}}else{this.onSelectionChange.trigger([])}this.selectedControlPoint=null;this.hoveredControlPoint=null;this.hoveredActionMenuItem=null},doCopyAction:function(g){var f=this.getSelectedDrawingElements();var e=[];if(f.length===0){return false}for(var d=0;d<f.length;d++){var b=f[d];var c=b.toJson();e.push(c)}var a=this.getWebgram();a.setClipboard("json/drawing-elements",e);a.onCopyAction.trigger(f.slice(0),g==true);return true},doPasteAction:function(m){var h=this.getWebgram();var f=h.getClipboard();if(f.type==="json/drawing-elements"){var o=f.content;var g,j,d=[];for(g=0;g<o.length;g++){var p=o[g];var l=Webgram.Utils.getField(p.className);if(l==null){continue}delete p.id;j=new l();j.fromJson(p);this.rootContainer._addDrawingElement(j,null,true);d.push(j)}if(d.length===0){return false}var k=this.getSelectedDrawingElements();var b=null;if(k.length>0){b=k[0].getCenter()}var n=this.getSetting("mainGrid.sizeX",25);var e=n,c=n;if(b!=null){var a=d[0].getCenter();e+=b.x-a.x;c+=b.y-a.y}for(g=0;g<d.length;g++){j=d[g];j.moveTo(j.getCenter().getTranslated(e,c))}this.setSelectedDrawingElements(d);h.onPasteAction.trigger(d.slice(0),m==true);return true}return false},doDuplicateAction:function(k){var h,d=this.getSelectedDrawingElements();var f,p,n=[];var g=this.getWebgram();if(d.length===0){return false}for(f=0;f<d.length;f++){h=d[f];p=h.toJson();n.push(p)}d=[];for(f=0;f<n.length;f++){p=n[f];var j=Webgram.Utils.getField(p.className);if(j==null){continue}delete p.id;h=new j();h.fromJson(p);this.rootContainer._addDrawingElement(h,null,true);d.push(h)}if(d.length===0){return false}var b=null;if(this.selectedDrawingElement!=null){b=this.selectedDrawingElement.getCenter()}var l=this.getSetting("mainGrid.sizeX",25);var o=this.getSetting("snapDistance",10)+1;var m=Math.max(l,o);var e=m,c=m;if(b!=null){var a=d[0].getCenter();e+=b.x-a.x;c+=b.y-a.y}for(f=0;f<d.length;f++){h=d[f];h.moveTo(h.getCenter().getTranslated(e,c))}this.setSelectedDrawingElements(d);g.onDuplicateAction.trigger(d.slice(0),k==true);return true},doDeleteAction:function(c){var b=this.getSelectedDrawingElements();if(b.length>0){if(b.length>1){this.setSelectedDrawingElements();for(var a=0;a<b.length;a++){this.rootContainer.remDrawingElement(b[a])}}else{this.rootContainer.remDrawingElement(b[0])}this.getWebgram().onDeleteAction.trigger(b.slice(0),c==true);return true}return false},doMoveAction:function(e,d,f){var c;if(d){c=this.getSetting("snapGrid.sizeX",5)}else{c=this.getSetting("mainGrid.sizeX",25)}var b=this.selectedDrawingElement;if(b==null){return false}var a;if(e==="up"){a=b.getCenter().getTranslated(0,-c)}else{if(e==="right"){a=b.getCenter().getTranslated(c,0)}else{if(e==="down"){a=b.getCenter().getTranslated(0,c)}else{if(e==="left"){a=b.getCenter().getTranslated(-c,0)}else{return false}}}}b.moveTo(a);this.invalidate(true);this.getWebgram().onMoveAction.trigger(this.getSelectedDrawingElements().slice(0),e,f==true);return true},doBringToFrontAction:function(c){var b=this.selectedDrawingElement;if(b==null){return false}var a=this.rootContainer.getDrawingElementIndex(b);this.rootContainer._setDrawingElementIndex(b,a+1,true);if(a!==this.rootContainer.getDrawingElementIndex(b)){this.getWebgram().onBringToFrontAction.trigger(this.getSelectedDrawingElements().slice(0),c==true);return true}return false},doSendToBackAction:function(c){var b=this.selectedDrawingElement;if(b==null){return false}var a=this.rootContainer.getDrawingElementIndex(b);this.rootContainer._setDrawingElementIndex(b,a-1,true);if(a!==this.rootContainer.getDrawingElementIndex(b)){this.getWebgram().onSendToBackAction.trigger(this.getSelectedDrawingElements().slice(0),c==true);return true}return false},doFlipHorizontallyAction:function(b){var a=this.selectedDrawingElement;if(a==null){return false}if(a.isFlipEnabled()){a.flipHorizontally();this.getWebgram().onFlipHorizontallyAction.trigger(this.getSelectedDrawingElements().slice(0),b==true);return true}return false},doFlipVerticallyAction:function(b){var a=this.selectedDrawingElement;if(a==null){return false}if(a.isFlipEnabled()){a.flipVertically();this.getWebgram().onFlipVerticallyAction.trigger(this.getSelectedDrawingElements().slice(0),b==true);return true}return false},handleMouseDown:function(c,f,d){if(this.selectedDrawingElement){var b=this.selectedDrawingElement.onMouseDown.trigger(c,f,d);if(b){return true}}else{if(this.hoveredDrawingElement&&this.hoveredDrawingElement.isHoveredControlPointsEnabled()){var b=this.hoveredDrawingElement.onMouseDown.trigger(c,f,d);if(b){return true}}}if(f===1){this.invalidate();this._mouseDownPoint=c;var e=this.selectedDrawingElement;if(this.selectedDrawingElement&&this.selectedDrawingElement!==this.hoveredDrawingElement){this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_NONE)}var h=this.selectedControlPoint;if(this.selectedControlPoint&&this.selectedControlPoint!==this.hoveredControlPoint){this.selectedControlPoint.setFocusType(Webgram.ControlPoint.FOCUS_NONE)}this.selectedControlPoint=this.hoveredControlPoint;this.selectedDrawingElement=this.hoveredDrawingElement;if(this.selectedDrawingElement!==e){if(e){e.onUnselect.trigger();e.disableShift()}if(this.selectedDrawingElement){this.selectedDrawingElement.onSelect.trigger();this.onSelectionChange.trigger([this.selectedDrawingElement])}else{this.onSelectionChange.trigger([])}}if(this.selectedControlPoint!==h){if(h){h.onUnselect.trigger()}if(this.selectedControlPoint){this.selectedControlPoint.onSelect.trigger()}}if(this.selectedControlPoint){this.selectedControlPoint.setFocusType(Webgram.ControlPoint.FOCUS_SELECTED);this.selectedControlPoint.onBeginMove.trigger();this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED)}else{if(this.hoveredActionMenuItem){this.hoveredActionMenuItem.activate();this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED)}else{if(this.selectedDrawingElement){var a=this.selectedDrawingElement.getCenter();this.selectedDrawingElement._mouseDownPoint=new Webgram.Geometry.Point(c.x-a.x,c.y-a.y);this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED);if(d.shift&&(!this._msContainerElement||(this._msContainerElement.getRotationAngle()===0))){if(this.selectedDrawingElement!==this._msContainerElement){if(this._msContainerElement){this._remFromMultipleSelection(true);this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE);this._finishMultipleSelection(c)}else{if(this.getSetting("multipleSelectionEnabled")){if(e&&e!==this.selectedDrawingElement){e.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE);this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE);this._msContainerElement=new Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer(c.x,c.y,0,0);this.rootContainer._addDrawingElement(this._msContainerElement);this._finishMultipleSelection(c)}else{this.selectedDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED)}}}}}else{if(this._msContainerElement&&this.selectedDrawingElement!==this._msContainerElement){this._remFromMultipleSelection()}}}else{if(this._msContainerElement){this._remFromMultipleSelection()}if(this.getSetting("multipleSelectionEnabled")){var g=this.getSetting("snapGrid");if(g!=null){c=new Webgram.Geometry.Point(Math.round(c.x/g.sizeX)*g.sizeX,Math.round(c.y/g.sizeY)*g.sizeY)}this._msContainerElement=new Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer(c.x,c.y,0,0);this.rootContainer._addDrawingElement(this._msContainerElement)}return true}}}}else{if(f===2&&this.getSetting("panEnabled")){this._panMouseDownPoint=c;return true}}},handleMouseUp:function(b,d,c){if(this.selectedDrawingElement){this.selectedDrawingElement.triggerShapeChange();var a=this.selectedDrawingElement.onMouseUp.trigger(b,d,c);if(a){return true}}if(d===1){this._mouseDownPoint=null;if(this.selectedControlPoint){this.selectedControlPoint.onEndMove.trigger();return true}if(this._msContainerElement&&this._msContainerElement.drawingElements.length===0){this._finishMultipleSelection(b);this.invalidate();return true}}else{if(d===2){delete this._panMouseDownPoint;return true}}},handleMouseMove:function(n,m){if(this.hoveredDrawingElement){var o=this.hoveredDrawingElement.onMouseMove.trigger(n,m);if(o){return o}}if(this._panMouseDownPoint){var e=n.x-this._panMouseDownPoint.x;var c=n.y-this._panMouseDownPoint.y;var d=this.rootContainer.getOffset();this.rootContainer.setOffset(new Webgram.Geometry.Point(d.x-e,d.y-c));this.invalidate(true);return"move"}else{if(this._mouseDownPoint){if(this.selectedControlPoint){this.selectedControlPoint.move(n,true);this.invalidate();return this.selectedControlPoint.getCursor()}else{if(this.selectedDrawingElement){this.selectedDrawingElement.onMouseMove.trigger(n,m);if(this.selectedDrawingElement.isMoveEnabled()){var e=n.x-this._mouseDownPoint.x;var c=n.y-this._mouseDownPoint.y;var k=this._mouseDownPoint.x-this.selectedDrawingElement._mouseDownPoint.x+e;var j=this._mouseDownPoint.y-this.selectedDrawingElement._mouseDownPoint.y+c;this.selectedDrawingElement.moveTo(new Webgram.Geometry.Point(k,j));this.invalidate();return"move"}}else{if(this._msContainerElement&&this._msContainerElement.isResizeEnabled()){if(this._mouseDownPoint.x<=n.x){if(this._mouseDownPoint.y<=n.y){this._msContainerElement._setBottomRight(n,false)}else{this._msContainerElement._setTopRight(n,false)}}else{if(this._mouseDownPoint.y<=n.y){this._msContainerElement._setBottomLeft(n,false)}else{this._msContainerElement._setTopLeft(n,false)}}this._markMultipleSelected();this.invalidate();return"crosshair"}}}}}var h=null;var a=null;var b=null;for(var f=0;f<this.rootContainer.drawingElements.length;f++){var g=this.rootContainer.drawingElements[f];if(!g.isSelectEnabled()){continue}if(((this.selectedDrawingElement===g)||g.isHoveredControlPointsEnabled())){a=g.pointInsideControlPoint(n);if(a){h=g;break}b=g.pointInsideActionMenuItem(n);if(b){h=g;break}}if(g.pointInside(n)){h=g}}if(h&&h.getFocusType()>Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE){return"not-allowed"}var l=false;if(h!==this.hoveredDrawingElement){if(this.hoveredDrawingElement){if(this.hoveredDrawingElement.getFocusType()===Webgram.DrawingElement.FOCUS_HOVERED){this.hoveredDrawingElement.setFocusType(Webgram.DrawingElement.FOCUS_NONE)}this.hoveredDrawingElement.onMouseLeave.trigger(n,m)}if(h){if(h.getFocusType()===Webgram.DrawingElement.FOCUS_NONE){h.setFocusType(Webgram.DrawingElement.FOCUS_HOVERED)}h.onMouseEnter.trigger(n,m)}this.hoveredDrawingElement=h;l=true}if(a!==this.hoveredControlPoint){if(this.hoveredControlPoint&&this.hoveredControlPoint.getFocusType()===Webgram.ControlPoint.FOCUS_HOVERED){this.hoveredControlPoint.setFocusType(Webgram.ControlPoint.FOCUS_NONE);this.hoveredControlPoint.onMouseLeave.trigger(n,m);this.hoveredControlPoint.onRemove.unbind(Webgram.DrawingControls.SelectDrawingControl._whenPointRemoved)}if(a&&a.getFocusType()===Webgram.ControlPoint.FOCUS_NONE){a.setFocusType(Webgram.ControlPoint.FOCUS_HOVERED);a.onMouseEnter.trigger(n,m);a.onRemove.bind(Webgram.DrawingControls.SelectDrawingControl._whenPointRemoved,this)}this.hoveredControlPoint=a;l=true}if(b!==this.hoveredActionMenuItem){if(this.hoveredActionMenuItem&&this.hoveredActionMenuItem.getFocusType()===Webgram.ActionMenuItem.FOCUS_HOVERED){this.hoveredActionMenuItem.setFocusType(Webgram.ActionMenuItem.FOCUS_NONE);this.hoveredActionMenuItem.onRemove.unbind(Webgram.DrawingControls.SelectDrawingControl._whenPointRemoved)}if(b&&b.getFocusType()===Webgram.ActionMenuItem.FOCUS_NONE){b.setFocusType(Webgram.ActionMenuItem.FOCUS_HOVERED);b.onRemove.bind(Webgram.DrawingControls.SelectDrawingControl._whenPointRemoved,this)}this.hoveredActionMenuItem=b;l=true}if(l){this.invalidate()}if(a){return a.getCursor()}if(b){return b.getCursor()}else{if(h){return h.getCursor()}else{return"default"}}},handleMouseScroll:function(c,b,d){if(this.hoveredDrawingElement){var a=this.hoveredDrawingElement.onMouseScroll.trigger(c,b,d);if(a){return a}}if(this.getSetting("zoomEnabled")){c=this.rootContainer.transformZoomOffsetDirect(c);if(b){this.rootContainer.setZoomLevel(this.rootContainer.getZoomLevel()+1,c)}else{this.rootContainer.setZoomLevel(this.rootContainer.getZoomLevel()-1,c)}this.invalidate();return true}},handleKeyDown:function(c,b){var a;if(this.selectedDrawingElement){a=this.selectedDrawingElement.onKeyDown.trigger(c,b);if(a){return a}if(c===16){this.selectedDrawingElement.enableShift();this.invalidate();return true}}if(this.getSetting("actionsEnabled")){if(this.keyMatches(this.getSetting("keyboardShortcuts.copy"),c,b)){if(this.doCopyAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.paste"),c,b)){if(this.doPasteAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.duplicate"),c,b)){if(this.doDuplicateAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.delete"),c,b)){if(this.doDeleteAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.moveUp"),c,b)){if(this.doMoveAction("up",b.shift,true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.moveRight"),c,b)){if(this.doMoveAction("right",b.shift,true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.moveDown"),c,b)){if(this.doMoveAction("down",b.shift,true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.moveLeft"),c,b)){if(this.doMoveAction("left",b.shift,true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.bringToFront"),c,b)){if(this.doBringToFrontAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.sendToBack"),c,b)){if(this.doSendToBackAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.flipHorizontally"),c,b)){if(this.doFlipHorizontallyAction(true)){return true}}else{if(this.keyMatches(this.getSetting("keyboardShortcuts.flipVertically"),c,b)){if(this.doFlipVerticallyAction(true)){return true}}}}}}}}}}}}}}},handleKeyUp:function(c,b){if(this.selectedDrawingElement){var a=this.selectedDrawingElement.onKeyUp.trigger(c,b);if(a){return a}if(c===16){this.selectedDrawingElement.disableShift();this.invalidate();return true}}},handleBlur:function(){if(this.selectedDrawingElement!=null&&this.selectedDrawingElement.isShiftEnabled()){this.selectedDrawingElement.disableShift()}},handleDrawingElementRemove:function(a){if(this.selectedDrawingElement===a){this.selectedDrawingElement=null;this.selectedControlPoint=null}},_markMultipleSelected:function(d){if(!this._msContainerElement){return}var a,b;if(d){for(b=0;b<d.length;b++){a=d[b];if(a===this._msContainerElement){continue}if(!a.isSelectEnabled()){continue}a.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE);a.onSelect.trigger()}}else{var e=this._msContainerElement.getBoundingRectangle();for(b=0;b<this.rootContainer.drawingElements.length;b++){a=this.rootContainer.drawingElements[b];if(a===this._msContainerElement){continue}if(!a.isSelectEnabled()){continue}var c=a.getBoundingRectangle();if((e.x1<=c.x1)&&(e.x2>=c.x2)&&(e.y1<=c.y1)&&(e.y2>=c.y2)){a.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE);a.onSelect.trigger()}else{a.setFocusType(Webgram.DrawingElement.FOCUS_NONE);a.onUnselect.trigger();a.disableShift()}}}},_finishMultipleSelection:function(d){if(!this._msContainerElement){return}var h=Infinity;var f=Infinity;var c=-Infinity;var b=-Infinity;var o,m;var j=[];for(m=0;m<this.rootContainer.drawingElements.length;m++){o=this.rootContainer.drawingElements[m];if(o.getFocusType()!==Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE){continue}j.push(o)}for(m=0;m<j.length;m++){o=j[m];var g=o.getBoundingRectangle();if(g.x1<h){h=g.x1}if(g.y1<f){f=g.y1}if(g.x2>c){c=g.x2}if(g.y2>b){b=g.y2}}if(j.length>1){this._msContainerElement._setTopLeft(new Webgram.Geometry.Point(h,f),true);this._msContainerElement._setBottomRight(new Webgram.Geometry.Point(c,b),true);this._msContainerElement._setTopLeft(new Webgram.Geometry.Point(h,f),true);var p,n=[];for(m=0;m<j.length;m++){p=this.rootContainer.getDrawingElementIndex(j[m]);n.push(p)}this._msContainerElement._drawingElementIndexes=n;this.rootContainer._setDrawingElementIndex(this._msContainerElement,n[0]);this._msContainerElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED);this.selectedDrawingElement=this._msContainerElement;this.onSelectionChange.trigger(j.slice(0));if(d){var a=this.selectedDrawingElement.getCenter();this.selectedDrawingElement._mouseDownPoint=new Webgram.Geometry.Point(d.x-a.x,d.y-a.y)}}else{if(j.length===1){j[0].setFocusType(Webgram.DrawingElement.FOCUS_SELECTED);this.selectedDrawingElement=j[0];this.onSelectionChange.trigger([this.selectedDrawingElement]);this.rootContainer._remDrawingElement(this._msContainerElement);this._msContainerElement=null;if(d){var a=this.selectedDrawingElement.getCenter();this.selectedDrawingElement._mouseDownPoint=new Webgram.Geometry.Point(d.x-a.x,d.y-a.y)}return}else{this.rootContainer._remDrawingElement(this._msContainerElement);this._msContainerElement=null;return}}var e=true;var l=true;var q=true;var k=[];for(m=0;m<this.rootContainer.drawingElements.length;m++){var o=this.rootContainer.drawingElements[m];if(o.getFocusType()!==Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE){continue}if(!o.isMoveEnabled()){e=false}if(!o.isRotateEnabled()){l=false}if(o.isResizeEnabled&&!o.isResizeEnabled()){q=false}k.push(o)}for(m=0;m<k.length;m++){k[m]._enterContainerElement(this._msContainerElement);k[m].setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE)}if(!e){this._msContainerElement.setMoveEnabled(false)}if(!l){this._msContainerElement.setRotateEnabled(false)}if(!q){this._msContainerElement.setResizeEnabled(false)}},_remFromMultipleSelection:function(b){if(!this._msContainerElement){return}var f,a=[];for(f=0;f<this._msContainerElement.drawingElements.length;f++){a.push(this._msContainerElement.drawingElements[f])}for(f=0;f<a.length;f++){a[f]._leaveContainerElement();if(b){a[f].setFocusType(Webgram.DrawingElement.FOCUS_SELECTED_MULTIPLE)}}var e=this._msContainerElement._drawingElementIndexes;var d=this.rootContainer.getDrawingElementIndex(this._msContainerElement);this.rootContainer._remDrawingElement(this._msContainerElement);if(e!=null){for(f=0;f<a.length;f++){var c=a[f];c._parent._setDrawingElementIndex(c,e[f])}}else{for(f=0;f<a.length;f++){var c=a[f];c._parent._setDrawingElementIndex(c,d+f)}}if(b){this.rootContainer._addDrawingElement(this._msContainerElement)}else{this._msContainerElement=null}}};Webgram.DrawingControls.SelectDrawingControl._whenPointRemoved=function(a,b){if(b.hoveredControlPoint===this){b.hoveredControlPoint=null}if(b.selectedControlPoint===this){b.selectedControlPoint=null}if(b.hoveredActionMenuItem===this){b.hoveredActionMenuItem=null}};Webgram.Class("Webgram.DrawingControls.SelectDrawingControl",Webgram.DrawingControl);Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer=function(b,d,c,a){Webgram.DrawingElements.ContainerElement.call(this,":special:multiple-selection-container",b,d,c,a);this.setStrokeStyle(Webgram.Styles.getStrokeStyle("multiple-selection"));this.setFillStyle(Webgram.Styles.getFillStyle("multiple-selection"));this.setMinSize(new Webgram.Geometry.Size(1,1));this._firstShapeChange=true;this._drawingElementIndexes=null;this.onMouseDown.bind(this.handleMouseDown);this.onIndexChange.bind(function(){this._drawingElementIndexes=null})};Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer.prototype={drawNoZoom:function(){this.drawRect(this.getDrawingRectangle());this.paint()},setFocusType:function(a){Webgram.DrawingElement.prototype.setFocusType.call(this,a)},handleMouseDown:function(a,g,e){var b=this.transformInverse(a);var d=null;for(var f=this.drawingElements.length-1;f>=0;f--){var c=this.drawingElements[f];if(c.pointInside(b)){d=c;break}}if(d&&e.shift&&(this.getRotationAngle()===0)){var h=this._parent.getActiveDrawingControl();h._remFromMultipleSelection(true);d.setFocusType(Webgram.DrawingElement.FOCUS_NONE);h._finishMultipleSelection(a);h._mouseDownPoint=null;return true}},pointInside:function(a,f,d){var b=this.transformInverse(a);for(var e=0;e<this.drawingElements.length;e++){var c=this.drawingElements[e];if(c.pointInside(b)){return true}}return false},isSnapExternallyEnabled:function(){return this.drawingElements.length>0},triggerShapeChange:function(b){if(this._firstShapeChange){this._firstShapeChange=false;return}for(var a=0;a<this.drawingElements.length;a++){this.drawingElements[a].triggerShapeChange(b)}},_triggerAdded:function(){},_triggerRemoved:function(){}};Webgram.Class("Webgram.DrawingControls.SelectDrawingControl._MultipleSelectionContainer",Webgram.DrawingElements.ContainerElement);Webgram.Namespace("Webgram.DrawingControls");Webgram.DrawingControls.CreateDrawingControl=function(a){Webgram.DrawingControl.call(this,a);this.drawingElement=null;this.drawingElementClass=null;this._initialMouseDownPoint=null;this.onDeactivate.bind(function(){this.drawingElement=null;this.drawingElementClass=null;this._initialMouseDownPoint=null})};Webgram.DrawingControls.CreateDrawingControl.prototype={setDrawingElementClass:function(a){if(this.drawingElement!=null){this.finish()}this.drawingElementClass=a;this.invalidate(true)},finish:function(){if(this.drawingElement==null){return}var a=this.drawingElement;this.drawingElement=null;this._initialMouseDownPoint=null;this._mouseDownPoint=null;if(a.endCreate()){var b=this.activatePrevious();if(b!=null&&b instanceof Webgram.DrawingControls.SelectDrawingControl){b.setSelectedDrawingElements([a])}a.onAdd.trigger();this.rootContainer.webgram.onDrawingElementAdd.trigger(a)}else{this.rootContainer._remDrawingElement(a);this.activatePrevious()}a._creating=false;a.disableShift();this.invalidate(true)},getSelectedDrawingElements:function(){if(this.drawingElement){return[this.drawingElement]}else{return[]}},handleMouseDown:function(a,d,b){if(d!==1){return}if(b.doubleClick){this.finish();return true}this._mouseDownPoint=a;if(!this._initialMouseDownPoint){this._initialMouseDownPoint=a}if(!this.drawingElement){this.drawingElement=new this.drawingElementClass();this.drawingElement.setFocusType(Webgram.DrawingElement.FOCUS_SELECTED);this.rootContainer._addDrawingElement(this.drawingElement);this.drawingElement._creating=true;this.rootContainer.webgram.onDrawingElementCreate.trigger(this.drawingElement);this.rootContainer.webgram.onSelectionChange.trigger([this.drawingElement]);if(!this.drawingElement.beginCreate(a)){this.finish()}}else{var c=new Webgram.Geometry.Size(a.x-this._initialMouseDownPoint.x,a.y-this._initialMouseDownPoint.y);if(b.shift){this.drawingElement.enableShift()}if(!this.drawingElement.continueCreate(a,c,true,true)){this.finish()}}this.handleMouseMove(a,b);this.invalidate();return true},handleMouseUp:function(a,c,b){if(c!==1){return}this.handleMouseMove(a,b);if(this._mouseDownPoint!=null&&a.getDistanceTo(this._mouseDownPoint)>25){this.handleMouseDown(a,c,b)}this._mouseDownPoint=null;return true},handleMouseMove:function(b,c){if(!this.drawingElement){return}var d=new Webgram.Geometry.Size(b.x-this._initialMouseDownPoint.x,b.y-this._initialMouseDownPoint.y);var a=this.drawingElement.continueCreate(b,d,(this._mouseDownPoint!=null),false);if(!a){this.finish()}this.invalidate()},handleKeyDown:function(c,b){if(c===27){this.finish();return true}if(this.drawingElement){var a=this.drawingElement.onKeyDown.trigger(c,b);if(a){return resukt}if(c===16){this.drawingElement.enableShift();this.invalidate();return true}}},handleKeyUp:function(c,b){if(this.drawingElement){var a=this.drawingElement.onKeyUp.trigger(c,b);if(a){return a}if(c===16){this.drawingElement.disableShift();this.invalidate();return true}}},handleBlur:function(){if(this.drawingElement!=null&&this.drawingElement.isShiftEnabled()){this.drawingElement.disableShift();return true}}};Webgram.Class("Webgram.DrawingControls.CreateDrawingControl",Webgram.DrawingControl);Webgram.Namespace("Webgram.DrawingControls");Webgram.DrawingControls.TextDrawingControl=function(a){Webgram.DrawingControl.call(this,a);this.onTextChange=new Webgram.Event("text change",this);this._drawingElement=null;this._area=null;this._angle=null;this._textField=null;this._textFieldIsAbsolute=false;this._textStyle=null;this._originalDrawingElementIndex=null;this._originalDrawingElementZIndex=null;this._textInputArea=null;this._textInputBackground=null;this._position=0;this.onDeactivate.bind(function(){this._hide()});this.onActivate.bind(function(){this._show()})};Webgram.DrawingControls.TextDrawingControl.prototype={configure:function(b,a,c,e,d){this._drawingElement=b;this._textField=a;this._textFieldIsAbsolute=(Webgram.Utils.getField(a,undefined,b)===undefined);this._textStyle=e;this._box=c;this._angle=b.getRotationAngle();if(d!=null){this._angle+=d}},finish:function(){var a=this._drawingElement;var b=this.activatePrevious();if(b instanceof Webgram.DrawingControls.SelectDrawingControl){b.setSelectedDrawingElements([a])}},getSelectedDrawingElements:function(){if(this._drawingElement){return[this._drawingElement]}else{return[]}},handleMouseDown:function(h,d,g){if(this._drawingElement==null||this._textInputBackground==null){return}if(this._textInputArea.pointInside(h)){h=this._textInputArea.transformInverse(h);var b=this._getLineCol();var c,j=b.layout.lines;for(c=0;c<j.length;c++){var k=j[c];var e=this._getTextStyle();var f=new Webgram.Geometry.Rectangle(k.left-e.size,k.top,k.right+e.size,k.bottom);if(f.pointInside(h)){var a=this._colFromXCoord(b,h.x);if(a!=null){b.line=c;b.col=a;this._position=this._positionFromLineCol(b);this.invalidate();return true}}}}},handleMouseUp:function(a,c,b){if(this._drawingElement==null||this._textInputBackground==null){return}if(!this._textInputArea.pointInside(a)){this.finish();return true}},handleMouseMove:function(a,b){if(this._drawingElement==null||this._textInputBackground==null){return}if(this._textInputArea.pointInside(a)){return"text"}else{return"default"}},handleKeyPress:function(b,a){if(this._drawingElement==null||this._textInputBackground==null){return}if(b<32||b>126){return}var c=String.fromCharCode(b);var d=this._getText();d=d.substring(0,this._position)+c+d.substring(this._position);this._setText(d);this._position++;this.invalidate();return true},handleKeyDown:function(b,a){if(this._drawingElement==null||this._textInputBackground==null){return}var c=a.ctrl;var e=this._getLineCol();var d=e.layout.text;switch(b){case 8:if(this._position>0){if(c){do{d=d.substring(0,this._position-1)+d.substring(this._position);this._position--}while(this._position>0&&this._isAlNum(d[this._position-1]))}else{d=d.substring(0,this._position-1)+d.substring(this._position);this._position--}this._setText(d);this.invalidate();return true}break;case 13:d=d.substring(0,this._position)+"\n"+d.substring(this._position);this._setText(d);this._position++;this.invalidate();return true;case 27:this.finish();return true;case 35:if(e.col<e.colCount){this._position+=e.colCount-e.col;this.invalidate();return true}break;case 36:if(e.col>0){this._position-=e.col;this.invalidate();return true}break;case 37:if(this._position>0){if(c){do{this._position--}while(this._position>0&&this._isAlNum(d[this._position]))}else{this._position--}this.invalidate();return true}break;case 39:if(this._position<d.length){if(c){do{this._position++}while(this._position<d.length&&this._isAlNum(d[this._position]))}else{this._position++}this.invalidate();return true}break;case 38:if(e.line>0){do{this._position--}while(this._position>0&&d[this._position]!=="\n");this.invalidate();return true}break;case 40:if(e.line<e.lineCount-1){do{this._position++}while(this._position<d.length&&d[this._position-1]!=="\n");this.invalidate();return true}break;case 46:if(this._position<d.length){if(c){do{d=d.substring(0,this._position)+d.substring(this._position+1)}while(this._isAlNum(d[this._position]))}else{d=d.substring(0,this._position)+d.substring(this._position+1)}this._setText(d);this.invalidate();return true}break}},handleFocus:function(){if(this._drawingElement==null||this._textInputBackground==null){return}this.invalidate();return true},handleBlur:function(){if(this._drawingElement==null||this._textInputBackground==null){return}this.invalidate();return true},_show:function(){if(this._textInputBackground!=null){return}if(this._drawingElement==null){return}var a=this._drawingElement.getParent();this._originalDrawingElementIndex=a.getDrawingElementIndex(this._drawingElement);this._originalDrawingElementZIndex=this._drawingElement.zIndex;this._textInputBackground=new Webgram.DrawingControls.TextDrawingControl._TextInputBackground(this);this._textInputArea=new Webgram.DrawingControls.TextDrawingControl._TextInputArea(this);a._addDrawingElement(this._textInputBackground);this._drawingElement.zIndex=Infinity;a._setDrawingElementIndex(this._drawingElement,Infinity);a._addDrawingElement(this._textInputArea);this._position=this._getText().length},_hide:function(){if(this._textInputBackground==null){return}var a=this._drawingElement.getParent();a._remDrawingElement(this._textInputBackground);this._textInputBackground=null;if(this._textInputArea!=null){a._remDrawingElement(this._textInputArea);this._textInputArea=null}this._drawingElement.zIndex=this._originalDrawingElementZIndex;a._setDrawingElementIndex(this._drawingElement,this._originalDrawingElementIndex);this._originalDrawingElementZIndex=null;this._originalDrawingElementIndex=null},_getTextStyle:function(){if(this._textStyle!=null){return this._textStyle}var a=this._drawingElement.getTextStyle();if(a!=null){return a}return Webgram.Styles.getTextStyle("default")},_getText:function(){var a=Webgram.Utils.getField(this._textField,undefined,this._textFieldIsAbsolute?null:this._drawingElement);if(a===undefined){a=""}return a},_setText:function(a){Webgram.Utils.setField(this._textField,a,this._textFieldIsAbsolute?null:this._drawingElement);this.onTextChange.trigger(this._drawingElement,a)},_getLineCol:function(){var e=this._getText();var c=this._textInputArea.layoutText(e,null,this._getTextStyle());var b,d=0,f=0,a=0,e=c.text;for(b=0;b<e.length;b++){if(e[b]==="\n"){a++;if(b<this._position){d=0;f++}}else{if(b<this._position){d++}}}return{line:f,col:d,lineCount:a+1,colCount:c.lines[f].text.length,layout:c}},_colFromXCoord:function(e,b){var a=e.layout.lines[e.line];if(b<a.left){return 0}var c,d=this._getTextStyle();for(c=0;c<a.text.length;c++){if(b<a.left+this._textInputArea.getTextSize(a.text.substring(0,c),d).width){return c}}return a.text.length},_positionFromLineCol:function(e){var d=e.layout.text;var a=0;var b=0,c=0;while(a<d.length&&b<e.line){if(d[a]==="\n"){b++}a++}while(a<d.length&&c<e.col){a++;c++}return a},_isAlNum:function(a){return(a>="A"&&a<="Z")||(a>="a"&&a<="z")||(a>="0"&&a<="9")}};Webgram.Class("Webgram.DrawingControls.TextDrawingControl",Webgram.DrawingControl);Webgram.DrawingControls.TextDrawingControl._TextInputBackground=function(a){Webgram.DrawingElement.call(this,":special:text-input-background");this.setFillStyle(Webgram.Styles.getFillStyle("text-input-background"));this.setStrokeStyle(null);this.zIndex=Infinity;this._textDrawingControl=a};Webgram.DrawingControls.TextDrawingControl._TextInputBackground.prototype={drawNoZoom:function(){this.drawRect(this.webgram.getVisibleArea().getShrinked(-1));this.paint()}};Webgram.Class("Webgram.DrawingControls.TextDrawingControl._TextInputBackground",Webgram.DrawingElement);Webgram.DrawingControls.TextDrawingControl._TextInputArea=function(a){var h=a._drawingElement;var i=a._box.getTopLeft();var d=a._box.getBottomRight();var b=a._box.getCenter();var e=h.getRotationAngle();b=h.transformDirect(b);i=h.transformDirect(i).getRotated(-e,b);d=h.transformDirect(d).getRotated(-e,b);var g=i.x;var f=i.y;var c=d.x-i.x+1;var j=d.y-i.y+1;Webgram.DrawingElements.RectangularElement.call(this,":special:text-input-area",g,f,c,j);this.setStrokeStyle(Webgram.Styles.getStrokeStyle("text-input-area"));this.setFillStyle(Webgram.Styles.getFillStyle("text-input-area"));this.zIndex=Infinity;this.setRotationAngle(e);this._textDrawingControl=a};Webgram.DrawingControls.TextDrawingControl._TextInputArea.prototype={drawNoZoom:function(){if(this._textDrawingControl._box!=null){this.drawArea()}if(this.webgram.hasFocus()){this.drawCursor()}},drawArea:function(){var f=this.getDrawingPoly();var c=3;var b=3;var m=f.points[0];var h=f.points[1];var d=m.x-5;var g=d+c;var k=m.y-5;var e=k+b;var l=h.x+5;var j=l-c;var a=h.y+5;var i=a-b;this.drawArc(new Webgram.Geometry.Point(g,e),c,b,Math.PI,3*Math.PI/2);this.drawLine(new Webgram.Geometry.Point(g,k),new Webgram.Geometry.Point(j,k));this.drawArc(new Webgram.Geometry.Point(j,e),c,b,3*Math.PI/2,2*Math.PI);this.drawLine(new Webgram.Geometry.Point(l,e),new Webgram.Geometry.Point(l,i));this.drawArc(new Webgram.Geometry.Point(j,i),c,b,0,Math.PI/2);this.drawLine(new Webgram.Geometry.Point(j,a),new Webgram.Geometry.Point(g,a));this.drawArc(new Webgram.Geometry.Point(g,i),c,b,Math.PI/2,Math.PI);this.drawLine(new Webgram.Geometry.Point(d,i),new Webgram.Geometry.Point(d,e));this.paint()},drawCursor:function(){var e=this._textDrawingControl._getTextStyle();var i=this._textDrawingControl._getText();var c=this._textDrawingControl._getLineCol();var b=c.layout.lines[c.line];var g=b.top;var a=b.bottom;var d=b.left;var h=d+this.getTextSize(b.text.substring(0,c.col),e).width;this.drawLine(new Webgram.Geometry.Point(h,g));this.drawLine(new Webgram.Geometry.Point(h,a));var f=Webgram.Styles.createStrokeStyle({colors:e.color,lineWidth:1});this.paint(f,null)}};Webgram.Class("Webgram.DrawingControls.TextDrawingControl._TextInputArea",Webgram.DrawingElements.RectangularElement);Webgram.MiniWebgram=function(c,b){Webgram.call(this,c,b);this.bigWebgram=null;this.marginFactor=0.1;this.settings.mainGrid=null;this.settings.snapGrid=null;this.settings.snapAngle=null;this.settings.snapDistance=null;this.settings.showRulers=false;this.settings.showZoom=false;this.settings.panEnabled=false;this.settings.zoomEnabled=false;var a=this;this.rootContainer._fillStyle=Webgram.Styles.getFillStyle("mini-background");this.rootContainer._strokeStyle=Webgram.Styles.getStrokeStyle("mini-background");this.rootContainer.drawBackground=function(){if(this._fillStyle!=null){a.bigWebgram._drawMini();var d=this.webgram.getVisibleArea().getShrinked(-1);var f=this.webgram.visibleArea.getBaseRectangle();var e=[new Webgram.Geometry.Point(f.x1,d.y2),new Webgram.Geometry.Point(f.x1,f.y1),new Webgram.Geometry.Point(f.x2,f.y1),new Webgram.Geometry.Point(f.x2,f.y2),new Webgram.Geometry.Point(f.x1,f.y2),new Webgram.Geometry.Point(f.x1,d.y2),new Webgram.Geometry.Point(d.x2,d.y2),new Webgram.Geometry.Point(d.x2,d.y1),new Webgram.Geometry.Point(d.x1,d.y1),new Webgram.Geometry.Point(d.x1,d.y2),new Webgram.Geometry.Point(f.x1,d.y2)];this.drawPoly(new Webgram.Geometry.Poly(e),true);this.paint(null,undefined);this.drawRect(f);this.paint(undefined,null)}};this.rootContainer.drawGrid=function(){};this.onMouseDown.bind(function(d,f,e){if(f===1){d=this.rootContainer.transformZoomOffsetInverse(d);if(!this.visibleArea.pointInside(d)){this.visibleArea.moveTo(d);return true}}})};Webgram.MiniWebgram.prototype={setVisibleArea:function(b,a){this._updatingMini=true;this.visibleArea._setTopLeft(b,true);this.visibleArea._setBottomRight(a,true);delete this._updatingMini},setWidth:function(a){Webgram.prototype.setWidth.call(this,a);this.setVisibleCenter(new Webgram.Geometry.Point(0,0));this.bigWebgram._updateMini()},setHeight:function(a){Webgram.prototype.setHeight.call(this,a);this.setVisibleCenter(new Webgram.Geometry.Point(0,0));this.bigWebgram._updateMini()},handleMouseDown:function(a,c,b){if(c===3){return}Webgram.prototype.handleMouseDown.call(this,a,c,b)},handleMouseScroll:function(c,b,d){var e=this.bigWebgram.getZoomLevel();var a=new Webgram.Geometry.Point(this.bigWebgram.getWidth()/2,this.bigWebgram.getHeight()/2);if(b){this.bigWebgram.setZoomLevel(e-1,a)}else{this.bigWebgram.setZoomLevel(e+1,a)}},_setRedrawLoop:function(){},_initDrawingElements:function(){this.visibleArea=new Webgram.MiniWebgram._MiniVisibleArea();this.addDrawingElement(this.visibleArea)},};Webgram.Class("Webgram.MiniWebgram",Webgram);Webgram.MiniWebgram._MiniVisibleArea=function(){Webgram.DrawingElements.RectangularElement.call(this,":special:mini-visible-area",-20,-20,41,41);this.setRotateEnabled(false);this.setResizeEnabled(false);this.onMove.bind(this._updateBigWebgram);this.onResize.bind(this._updateBigWebgram)};Webgram.MiniWebgram._MiniVisibleArea.prototype={draw:function(){},drawGuides:function(){},drawDecoration:function(){},getDrawingRectangle:function(){var f=this.getDrawingWidth();var a=this.getDrawingHeight();var c=Math.round(-f/2);var e=Math.round(-a/2);var b=Math.round(f/2);var d=Math.round(a/2);return new Webgram.Geometry.Rectangle(c,e,b,d)},snap:function(){},_updateBigWebgram:function(){if(this.webgram._updatingMini){return}var a=this.webgram.bigWebgram;a._updateFromMini()}};Webgram.Class("Webgram.MiniWebgram._MiniVisibleArea",Webgram.DrawingElements.RectangularElement);